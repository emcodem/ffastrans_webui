<html>
<head>


<link rel="stylesheet" href="/alternate-server/css/override.css"/>

<script src="../../dependencies/dhtmlx/8.4.5/suite.umd.js"></script>
<link rel="stylesheet" href="../../dependencies/dhtmlx/8.4.5/suite.min.css" type="text/css"/> 
<link rel="stylesheet" href="../../dependencies/dhtmlx/dhtmlx.css" id="theme_loader" type="text/css">
<script>
    //theme changeer
    if (localStorage.global_skin_dark == "1"){
        try{
            document.querySelector("#theme_loader").href = document.querySelector("#theme_loader").href.replace("dhtmlx.css","dhtmlx_benjamin.css")
        }catch(ex){}
        try{
            dhx.setTheme("dark");
        }catch(ex){}
        try{
            dhx8.dhx.setTheme("dark");
        }catch(ex){}
    }
</script><!-- legacy dhtml css goes first -->

<script src="../../dependencies/jquery/jquery.js"></script>
<link href="../../dependencies/MaterialDesign-Webfont-7.2.96/css/materialdesignicons.min.css" media="all" rel="stylesheet" type="text/css" />

<style>
* {
  /* â†“ Now literally all elements display a sans-serif font */
  font-family: "Tahoma";
}

.custom_msg{
    /*we re-use dhx default message class but override some props to fit our needs */
    width:unset;
    font-weight:unset;
    padding:4px;
    margin:4px;
    box-shadow:var(--dhx-border-shadow-small);
    cursor:unset;
    font-size:10;
}

.dhx_grid-cell{
    font-size:12
}

.dhx_button--size_medium{
    text-transform:unset;
}

.option_grid_button{
   height:70%;width:30px;
   margin:5px;
}

.dhx_button .dhx_toolbar-button__text{
    font-size:12 !important
}

.dhx_grid-header-cell-text_content{
    font-size:12;
}
</style>

<script type="module">
import { webuiVariables_processVariables } from "../common/webuiVariables.js";

window.m_last_data = null;
window.init = init;

var m_maingrid;
var m_filter_statics = false;

window.addEventListener("pagehide",(event) => {
    window.parent.window.parent.showHeader(); //the root index html is 2 iframes up ;-)
  },
  false
);

async function loadData(){
    var locations = await  $.ajax({
        url:  ("/getworkflowlist"),
        type: "GET"
    });
    return locations;
}

async function saveVariableAjax(var_name_and_data){
    var data = await  $.ajax({
        url:  (build_new_api_url("/variables")),
        type: "POST",
        contentType:"application/json",
        
        data: JSON.stringify(var_name_and_data)
    });
    loadGridData(true);//reload with every save
    dhx8.dhx.message({
        text:"Success Saving Variables", 
        css:"expire", 
        expire:2000
    });
    return data;
}

async function deleteVariableAjax(var_name_and_data){
    var data = await  $.ajax({
        url:  (build_new_api_url("/variables?name=" + var_name_and_data.name)),
        type: "DELETE",
        contentType:"application/json",
        
        data: JSON.stringify(var_name_and_data)
    });
    loadGridData(true);//reload with every save
    return data;
}

function build_new_api_url(what) {
        return "/new_proxy" + what;
}

function init(){
    buildLayout();
}

async function buildLayout(){
    //LAYOUT
    const mainlayout_config = {
        //type: "wide",//"line" | "wide" | "space" | "none";
		width:"100%", height:"100%",rows:
		[   { id: "toolbar", height: "content" },
			{
				cols: [
                    {
						id: "main",
						resizable:false,
						padding: "0px",  
						margin: "0px",
					}
                ]
			}
		]
	}
        
    var layout = new dhx8.dhx.Layout("layout", mainlayout_config);
    layout.getCell("main").progressShow();

    //GRID
    m_maingrid = new dhx8.dhx.Grid(null, {
        adjust:"data",
        columns: [
            {  readonly:true, id: "wf_folder",minWidth: 80, header: [{ content: "selectFilter" },           { text: "Folder" }]},
            {  readonly:true, id: "wf_name",minWidth: 80, header: [{ content: "inputFilter" },              { text: "Name" }]},
            {  readonly:true, id: "_status",minWidth: 80, header: [{ content: "selectFilter" },             { text: "Status" }]},
            {  readonly:true, id: "webui_integration",minWidth: 130, header: [{ content: "inputFilter" },   { text: "Webui Integration" }]},
            {  readonly:true, id: "farming",width:"content",minWidth: 70, header: [{ content: "inputFilter" },{ text: "Hosts" }],
                                    template: function (data, row, col) {
                                            if (! data)
                                                return;
                                            if (data.hosts.length == 0)
                                                return;
                                            let in_or_ex = data.include ? "Include: " : "Exclude: ";
                                            return in_or_ex + data.hosts.join(" ");
                                        } 
                                    },
            {  readonly:true, id: "general",minWidth: 80, 
                                    header: [
                                        {
                                            content: "inputFilter",
                                            customFilter: (data, match) => {
                                                try{
                                                    if (Object.keys(data).length == 0) return false;
                                                    return data.priority.match(match);
                                                }catch(ex){return false}
                                            }
                                        },
                                                                                                            { text: "Priority" },
                                    ],
                                    template: function (data, row, col) {
                                            return data.priority;
                                        } 
            },
            {  readonly:true, id: "special",minWidth: 80, 
                                    header: [{  
                                        content: "inputFilter",
                                        customFilter: (data, match) => {
                                            try{
                                                if (Object.keys(data).length == 0) return false;
                                                return data.log_level.match(match);
                                            }catch(ex){return false}
                                        }
                                    },
                                                                                                            { text: "Log Level" }
                                    ],
                                    template: function (data, row, col) {
                                            return data.log_level;
                                        } 
                                    },
            {  readonly:true, id: "maintainance",minWidth: 80,                                     
                                    header: [{  
                                        content: "inputFilter",
                                        customFilter: (data, match) => {
                                            try{
                                                if (data.keep_all_workdir && match.match(/a/i)){
                                                    return true;
                                                }
                                                if (data.keep_failed_workdir && match.match(/f/i)){
                                                    return true;
                                                }

                                            }catch(ex){return false}
                                        }
                                    },
                                                                                                            { text: "Keep Work Files" }
                                    ],
                                    template: function (data, row, col) {
                                        let to_display = "";
                                        to_display += data.keep_all_workdir ? "<span style='color:red'>All</span>" : "";
                                        if (!data.keep_all_workdir)
                                            to_display += data.keep_failed_workdir ? "<span>Failed</span>" : "";
                                        return to_display;
                                    } 
            },
            {  readonly:true, id: "updated", header: [{ content: "inputFilter" },                           { text: "Updated" }],
                                    template: function (data, row, col) {
                                        return data.replace("T"," ");
                                    } 
            }
        ],
        editable: false,
        autoWidth: true,
        resizable: true,//allow manual resize
        selection:"row",
        htmlEnable: true,
        
    });

    m_maingrid.events.on("cellDblClick", function(row,col,editorType){
        console.log("Cell dblclick",col);
        if (col.id == "webui_integration"){
            //bring up integration window
            console.log(m_maingrid)
            webuiWorkflowIntegrationEditor(row);
        }

    });
    //TOOLBAR
    const cfg = [
        {
            id: "btnnew",
            type: "button",
            value: "New",
            icon: "dxi dxi-plus",
            size: "small",
            color: "secondary",
            css: "dhxform_obj_dhx_skyblue"
        },
        {
            id: "btnedit",
            type: "button",
            value: "Edit",
            icon: "dxi dxi-pencil",
            size: "small",
            color: "secondary",
            css: "dhxform_obj_dhx_skyblue"
        },{
            id: "btndel",
            type: "button",
            value: "Delete",
            icon: "dxi dxi-close",
            size: "small",
            color: "secondary",
            css: "dhxform_obj_dhx_skyblue"      
        }
    ]
    const toolbar = new dhx8.dhx.Toolbar("toolbar", {
        css:"dhx_widget--bordered"
        });
    toolbar.data.add(cfg);
    toolbar.events.on("click", function(id,e){
        if(id == "btnedit")
            editWebUiTypeVar();
        if(id == "btndel")
            deleteSelected();
        if (id == "btnnew")
            newVariableWindow();
    });
    toolbar.events.on("change", function(id,e){
        //user change filter
        const typefilter = m_maingrid.getHeaderFilter("type");
        typefilter.setValue("");
        if (toolbar.getState("filtervartype").indexOf("Statics") != -1){
            m_filter_statics = true;
            loadGridData(true);
            return;
        }
        if (toolbar.getState("filtervartype").indexOf("WebUI") != -1){
            typefilter.setValue("web");
        }
        m_filter_statics = false;
        loadGridData(true);
        
    })
    
    layout.getCell("toolbar").attach(toolbar);
    
    await loadGridData(true);
    layout.getCell("main").attach(m_maingrid);
    layout.getCell("main").progressHide();
    
}

async function loadGridData(force=false){
    //console.trace("loadGridData called..")

    var data = await(loadData());
    if (data != m_last_data || force){
        m_last_data = data;
    }else{
        return;
    }
    

    data = JSON.parse(data);
    console.log("loadGridData got some new data...",data)
    var gridData = [];
    console.log("loading",data.workflows);
    m_maingrid.data.parse([]);
    m_maingrid.data.parse(data.workflows);

}

async function webuiWorkflowIntegrationEditor(workflowData){
    console.log("Selected row",workflowData)
    const selectedCells = m_maingrid.selection.getCells();
    if (selectedCells.length == 0){
        return;
    }
    
    
    var dhxWindow = new dhx8.dhx.Window({
        header: true,
        title: "WebUI Workflow Integration",
        movable: true,
        closable:true,
        modal:true,
        resizable:true,
        height:550,
        html:"<div style='height:80%' id='newvarform'></div>Final variable name: <input style='width:70%;color:rgba(0, 0, 0, 0.5)' readonly=true id='newvarname'></div>"
    });
    dhxWindow.header.data.add({ icon: "mdi mdi-fullscreen", id: "fullscreen" }, 2);
            var isFullScreen = false;
            dhxWindow.header.events.on("click", function (id) {
                if (id === "fullscreen") {
                    if (isFullScreen) {
                        isFullScreen = false;
                        dhxWindow.unsetFullScreen();
                    } else {
                        isFullScreen = true;
                        dhxWindow.setFullScreen();
                    }
                }
            });
    dhxWindow.show();
    await dhx8.dhx.awaitRedraw(); //wait until html part of dhxWindow is drawn on page

    const layout_config = {
        //type: "wide",//"line" | "wide" | "space" | "none";
		width:"100%", height:"100%",
        type:"wide",
        rows:
		[   
            { id: "toolbar", height: "content" },
            ,
            {
                
                cols:[{cols:[
                    {
                            collapsable:true,
                            header:"Job Submit Form",
                            id: "left_cell",
                            resizable:false,
                            padding: "0px",  
                            width:"80%",
                            margin: "0px",
                    },
                    {
                            collapsable:true,
                            header:"Merit",
                            id: "merit_cell",
                            resizable:false,
                            padding: "0px",  
                            width:"20%",
                            margin: "0px",
                    }]},
                    {
                    cols:[
                    {
                            header:"Features",
                            id: "right_cell",
                            resizable:true,
                            width:"100%",
                            padding: "0px",  
                            margin: "0px",
                            
                    }]
                }
                ]
            },
            {
                id: "save_cell",
                width:"100%",
                height:"30px",
                padding: "0px",  
                margin: "0px",
                            
            }
		]
	}
    let layout = new dhx8.dhx.Layout(null, layout_config);
    dhxWindow.attach(layout);

    const features_form = new dhx8.dhx.Form(null, {
        css: "dhx_widget--bordered",
        rows: [
            {
                name : "top_text",
                "type": "textarea",
                "label": "Top Text",
                "labelPosition": "left",
                "labelWidth": "80",
                "placeholder": "Displayed on Top",
                "readOnly": false,
                "resizable": true
            },
            {
                name: "stitch",
                "type": "checkbox",
                "label": "Stitch",
                "labelPosition": "left",
                "labelWidth": "80",
                "checked": false
            },
            {
                "type": "text",
                "label": "",
                "labelPosition": "left",
                "labelWidth": "80",
                "value": "Submits all selected files into a single job, sets %webui_a_source% and %webui_o_source%"
            },

            {view:"link",width:"250px",css:"dhxform_obj_dhx_skyblue",circle:true,full:true,type: "button",name: "btn_save",text: "Save",view: "flat",color: "primary"},
        ]
    });
    layout.getCell("right_cell").attach(features_form);
    layout.getCell("left_cell").attach(createWorkflowForm(workflowData));
    
    features_form.events.on("click", async function(event, name, id) {
            //form submit
            if (!features_form.validate()){
                alert("Error, Please check your inputs.");
                return;
            }
            
            var v = features_form.getValue();
            var real_var_name = document.getElementById("newvarname").value.replaceAll("%","");
            try{
                var res = await saveVariableAjax({name:real_var_name,data:v.description});
                console.log("Save variable response",res);
            }catch(ex){
                console.log("Error Saving variable: ", ex)
                alert("Error Saving variable: " + ex.responseText)
                console.log("Responsetext: ", ex.responseText)
            }
            dhxWindow.destructor();
            await loadGridData();
            await dhx8.dhx.awaitRedraw();
            //select cell in grid 
            
            var foundRow = m_maingrid.data.find(function(item){
                if(item.name=== real_var_name){return true}
            });
            if (!foundRow)
                alert("row not found")
            console.log("rowid",foundRow.id)
            m_maingrid.selection.setCell(m_maingrid.data.getItem(foundRow.id));

            //open variable editor
            editWebUiTypeVar()
    });
    features_form.events.on("change", function(event, name, id) {
        //onNameChange();
        //applyNewVarFormRules(new_form);
    });
    features_form.events.on("keydown", function(event, name, id) {
        console.log("keydown")
        //onNameChange();
    });

    //Merit grid
    const merit_grid = new dhx8.dhx.Grid("grid", {
        selection: "row",
        editable: true,
        columns: [
            
            { width: "50%", id: "merit", type:"number", header: [{ text: "M" }]},
            { width: "50%", id: "name", header: [{ text: "N" }] },
            
        ]})
    layout.getCell("merit_cell").attach(merit_grid);  
    let rows_to_load = webuiVariables_processVariables(workflowData.user_variables.variables);
    merit_grid.data.parse(rows_to_load);

}

function createWorkflowForm(wf_object){

    var dhxform_user_vars = webuiVariables_processVariables(wf_object.user_variables.variables);
    const vars_form = new dhx8.dhx.Form("form_wf_form", {
                //css: "dhx_widget--bordered",
                rows: dhxform_user_vars
            });
    return vars_form;

}

function deleteSelected(){
    // const selectedCells = m_maingrid.selection.getCells();
    // if (selectedCells.length == 0){
    //     return;
    // }
    // var to_delete = selectedCells[0].row;
    // if (to_delete.use_count != 0){
    //     dhx.alert({
    //         header: "Not possible",
    //         text: "Selected Variable is used ("+to_delete.use_count+"), you must edit your workflows to not make use of the variable before deleting it.",
    //         buttons: ["ok"]
    //     });
    //     return;
    // }

    // dhx.confirm({
    //     header: "Confirm delete",
    //     text: "Delete "+to_delete.name+"?",
    // }).then(function (i) { 
    //     try{
    //         deleteVariableAjax(to_delete);
    //     }catch(ex){
    //         console.log("Error deleting".ex)
    //         alert("Error deleting variable: " + ex.responseText)
    //         console.log("Error deleting",ex.responseText)
    //     }
    //     m_maingrid.data.remove(selectedCells[0].row.id);
    // });
    
}


// async function newVariableWindow(){
//     var dhxWindow = new dhx.Window({
//         header: true,
//         title: "New Variable",
//         movable: true,
//         closable:true,
//         modal:true,
//         resizable:true,
//         height:550,
//         html:"<div style='height:80%' id='newvarform'></div>Final variable name: <input style='width:70%;color:rgba(0, 0, 0, 0.5)' readonly=true id='newvarname'></div>"
//     });
//     dhxWindow.show()
//     await dhx.awaitRedraw(); //wait until html part of dhxWindow is drawn on page
//     dhxWindow.events.on("beforeHide", function(position, events){
//         //reload grid after window close
//         loadGridData();
//     });
//     const new_form = new dhx.Form("newvarform", {
//         css: "dhx_widget--bordered",
//         rows: [
//             {type: "input",name: "new_var_name",label: "Name",value: "new_name",labelPosition: "left",labelWidth:110,required:true},
//             {
//                 type: "select",name:"var_or_static",label: "Variable or Static",labelPosition: "left",labelWidth: 110,value: m_filter_statics ? "static" : "variable",
//                 required: true,
//                 options: [
//                     {
//                         value: "static",
//                         content: "Static"
//                     },
//                     {
//                         value: "variable",
//                         content: "Variable"
//                     }
//                 ]
//             },
//             {type: "select",name: "datatype",label: "Data Type",labelPosition: "left",labelWidth: 110,value: "s_webui_",
//                 required: true,
//                 options: [
//                     {
//                         value: "s_webui_",
//                         content: "Webui Form Field",
//                         selected:true
//                     },
//                     {
//                         value: "s_",
//                         content: "String"
//                     },

//                     {
//                         value: "i_",
//                         content: "Integer"
//                     },
//                     {
//                         value: "f_",
//                         content: "Floating Point Number"
//                     }
//                 ]
//             },
            
//             {type: "input",name: "description",label: m_filter_statics ? "Value" : "Description",value: "",labelPosition: "left",labelWidth:110},
//             {view:"link",width:"250px",css:"dhxform_obj_dhx_skyblue",circle:true,full:true,type: "button",name: "btn_save",text: "Save",view: "flat",color: "primary"},
//         ]
//     });

//     new_form.events.on("click", async function(event, name, id) {
//             //form submit
//             if (!new_form.validate()){
//                 alert("Error, Please check your inputs.");
//                 return;
//             }
            
//             var v = new_form.getValue();
//             var real_var_name = document.getElementById("newvarname").value.replaceAll("%","");
//             try{
//                 var res = await saveVariableAjax({name:real_var_name,data:v.description});
//                 console.log("Save variable response",res);
//             }catch(ex){
//                 console.log("Error Saving variable: ", ex)
//                 alert("Error Saving variable: " + ex.responseText)
//                 console.log("Responsetext: ", ex.responseText)
//             }
//             dhxWindow.destructor();
//             await loadGridData();
//             await dhx.awaitRedraw();
//             //select cell in grid 
            
//             var foundRow = m_maingrid.data.find(function(item){
//                 if(item.name=== real_var_name){return true}
//             });
//             if (!foundRow)
//                 alert("row not found")
//             console.log("rowid",foundRow.id)
//             m_maingrid.selection.setCell(m_maingrid.data.getItem(foundRow.id));

//             //open variable editor
//             editWebUiTypeVar()
//     });
//     new_form.events.on("change", function(event, name, id) {
//         onNameChange();
//         applyNewVarFormRules(new_form);
//     });
//     new_form.events.on("keydown", function(event, name, id) {
//         console.log("keydown")
//         onNameChange();
//     });
    


//     function onNameChange(){
//         //live calculate actual name while the user interacts with form
//         var v = new_form.getValue();
//         var _name = document.querySelector('[data-dhx-id="new_var_name"]').value; //form native getValue method only gives actual value when input was validated

//         var real_name = calculateRealVarName(v.var_or_static,v.datatype,_name)

//         if (v.var_or_static == "static")
//             real_name = real_name.toUpperCase();
//         try{
//             document.getElementById("newvarname").value = "%" + real_name + "%";
//         }catch(ex){}
        
//     }

//     await dhx.awaitRedraw();
//     onNameChange();
//     applyNewVarFormRules(new_form);
// }

// function calculateRealVarName(var_or_static,datatype,userText){ //var_or_static is static or variable
//         /*replace space and other things to construct valid name*/
//         const regex = / /ig; //[^A-Z1-9]
//         var real_name = userText.replaceAll(regex,"_");
//         real_name = datatype + real_name;
//         if (var_or_static == "static")
//             real_name = real_name.toUpperCase();
//         return real_name;
//     }

// function applyNewVarFormRules(new_form){
//     var v = new_form.getValue();
//     if (v.var_or_static == "static"){
//         new_form.setProperties("description", {label: "Value"})
//     }
//     else{
//         new_form.setProperties("description", {label: "Description"})
//     }
//     if (v.datatype == "s_webui_"){
//         new_form.setProperties("description", {readOnly: "not relevant",css:"displayNone"})
//     }else{
//         new_form.setProperties("description", {readOnly: "",css:""})
//     }
// }


/* -------- webui variable editor -------- */

// function editWebUiTypeVar(){
    
//     const selectedCells = m_maingrid.selection.getCells();

//     if (selectedCells.length == 0){
//         return;
//     }

//     try{
//         window.parent.window.parent.hideHeader(); //the root index html is 2 iframes up ;-)
//     }catch(ex){}

//     var selected_var = selectedCells[0].row;
//     console.log("Selected Variable:",selected_var);
//     var o_var = JSON.parse(m_last_data);
//     o_var = o_var.user_variables.find(v=>v.name == selected_var.name);
    
//     if (!o_var){
//         alert("Unknown error getting variable by name "+vname+", contact developer");
//         return;
//     }

//     var dhxWindow = new dhx.Window({
//         node: document.body,
//         viewportOverflow:true,
//         header: true,
//         title: "Editor ("+o_var.name+")",
//         movable: true,
//         closable:true,
//         modal:true,
//         resizable:true,
//         customFullScreen:false,
//         height:350,
//         css: "seekme",
//     });

//     dhxWindow.header.data.add({ icon: "mdi mdi-fullscreen", id: "fullscreen" }, 2);
//     var isFullScreen = false;
//     dhxWindow.header.events.on("click", function (id) {
//         if (id === "fullscreen") {
//             if (isFullScreen) {
//                 isFullScreen = false;
//                 dhxWindow.unsetFullScreen();
//             } else {
//                 isFullScreen = true;
//                 dhxWindow.setFullScreen();
//             }
//         }
//     });

//     dhxWindow.events.on("beforeHide", function(position, events){
//         //reload grid after window close
//         try{
//             window.parent.window.parent.showHeader(); //the root index html is 2 iframes up ;-)
//         }catch(ex){}
//         loadGridData();
//     });

//     ////webui type variables need special attention ^^
//     if (selected_var.name.indexOf("s_webui")!=-1){
//         construct_webui_vars_form(dhxWindow,selected_var,form_btns,top_form_rows);
//         return;
//     }
//     //NON webui variables can just edit description
//     var layout = new dhx.Layout(null, {
//                                             type: "space",
//                                             rows: [
//                                                 {id: "top"},
//                                             ]
//                                         });
//     dhxWindow.attach(layout);                            
    
//     //attach form component editor to top cell
//     var top_form_rows = [];

//     //add save button
//     var form_btns = {
//                 padding: "10px", 
//                 align: "around",// "center", "end", "between", "around", "evenly"
//                 cols:[
//                     {view:"link",css:"dhxform_obj_dhx_skyblue",circle:true,full:true,type: "button",name: "btn_save",text: "Save",view: "flat",color: "primary"}
//                 ]
//             }

//         //FINALLY CONSTRUCT FORM
//         var is_static = !selected_var.name.match(/^s_|^i_|^f_/)
//         var label_text = is_static ? "Value" : "Description"; //statics have uppercase sif, they have value instead of description
//         var preMsg = is_static ? "" : "Note this is only Variable Description, it is not important for your Workflow. Actual Variable Values are calculated only while a job is running. Use 'static' if you need variables with fixed values." 
//         top_form_rows.push({type: "input",  label: label_text,
//                                             name: "data",
//                                             value: selected_var.original_object.data,
//                                             labelPosition: "left",
//                                             preMessage: preMsg
//                             });
//         top_form_rows.push(form_btns);

//         const top_form = new dhx.Form(null, {
//                         css: "dhx_widget--bordered",
//                         rows: top_form_rows
//                     });
//         top_form.getItem("btn_save").events.on("click", async function(events){
//             var _d = top_form.getValue().data;
//             saveVariable(selected_var.name,_d);
//         })
//         layout.getCell("top").attach(top_form);  

//         dhxWindow.show();
// }

// function attach_codemirror(id){
//     document.getElementById(id).innerHTML = "";
//     var base = document.getElementById(id);
//         var o_codemirror = CodeMirror(base, {
//                   lineNumbers: true,
//                   value: "", //"//when you are done and this array contains filepaths, one job per contained path will be started.\nvar filesToProcess = [];",
//                   mode: "application/json",
//                   gutters: ["CodeMirror-lint-markers"],
//                   lint: true
//         });
//     return o_codemirror;
// }

// async function construct_webui_vars_form(dhxWindow,selected_var,form_btns,top_form_rows){
//     try{
//         parent.m_sidebar.collapse();
//         await dhx.awaitRedraw();
//     }catch(ex){}

//     dhxWindow.setSize(window.innerWidth-100, window.innerHeight-10);//webui editor win is bigger than the one for generic vars

//     const layout = new dhx.Layout(null, {
            
//             cols: [
//                 {
//                     type: "line",
//                     width:"40%",
//                     resizable:true,
//                     rows:[
//                         {
//                             id: "jsonedit",
//                             html:"<div id='codemirror'></div>",
//                         },
//                         { 
//                             type: "line",
//                             height:"content",id: "save_btn_area",
//                         }
//                     ]
//                 },
//                 {
//                     type: "space",
//                     resizable:true,
//                     rows: [
//                         {
//                             type: "line",
//                             cols: [
//                                 {
//                                     header:"Main Editor",
//                                     resizable:true,
//                                     id: "top",
//                                     collapsable: true,
//                                     css: "seekme2"
//                                 },
//                                 {
//                                     header:"Select Options",
//                                     resizable:true,
//                                     collapsable: true,
//                                     id: "select_options",
//                                     hidden:true,
//                                     width:"350px",
//                                     minWidth:"50px",
//                                 },
//                             ],
                            
//                     },
//                     { 
//                         resizable:true,
//                         height:"40%",
//                         id: "bottom",
//                         css:"seekme2"
//                     },
//                 ]
//     }]});
//     m_var_layout = layout;
//     dhxWindow.attach(layout);                            
//     dhxWindow.show();
//     await dhx.awaitRedraw();

//     dhxWindow.events.on("beforeHide", function(position, events){
//         try{
//             parent.m_sidebar.expand()
//         }catch(ex){}
//         return true;
//     });

//     layout.codemirror = attach_codemirror("codemirror");
//     init_top_form(selected_var.name,selected_var.original_object.data,layout);
    
//     // top_form.getItem("data").events.on("keyDown", async function(value) {
//     //     //this did not work as attaching preview to bottom form did reset top form
//     //     window.setTimeout(function(){previewForm(getDataInputValue(),layout.getCell("bottom")),1});
//     //     return true;
//     // });
// }//webui type variables


// async function init_options_grid(layout,top_form){
// //builds a grid for topright, only shown in case type is select

//     var griddata = [];
//     try{
//         griddata = JSON.parse(layout.codemirror.getValue()).options;
//         if (!Array.isArray(griddata))
//             return;
//     }catch(ex){
//         alert("Error parsing options field from Data JSON. Did you manually edit the data field and produce invalid JSON?")
//         console.log(ex)
//     };
//     console.log("options grid data:",griddata)
    
//     layout.getCell("select_options").show();

//     var opts_grid;
//     try{ 
//         var g_layout = layout.getCell("select_options").getWidget(); //gets attached grid layout
//         opts_grid = g_layout.getCell("attach_grid_here").getWidget(); //gets the grid itself
//         console.log("Using existing optsgrid")
//     }catch(ex){}
//     //only initialize if grid is not there
//     if (opts_grid){
//         console.log("Optsgrid",opts_grid)
//         opts_grid.data.parse(griddata);
//         return; //important, otherwise we attach
//     }
    
//     //only initialize everything if not already done
//     opts_grid = new dhx.Grid(null, {
//         selection:"row",
//         autoWidth: true,
//         multiselection:true,
//         columns: [
//             { id: "value", header: [{ text: "Value" }],gravity:100 },
//             { id: "content", header: [{ text: "Display Name" }],gravity:100 }
//         ],
        
//         editable: true,
//         data: griddata
//     });
//     var grid_layout = new dhx.Layout(null, {
//         type: "line",
//         rows: [
//             {
//                 id: "right_header",
//                 height:40,
//                 css:"displayflex dhxlayout_base_dhx_skyblue dhxlayout_cont div.dhx_cell_layout div.dhx_cell_hdr",
//                 html:"<div style='padding-left: 10px;'>Options <button class='option_grid_button' id='addRow' >+</button><button class='option_grid_button' id='removeRow'>-</button></div>"
//             },
//             {
//                 id: "attach_grid_here",
//             },
//         ]
//     });

//     grid_layout.getCell("attach_grid_here").attach(opts_grid);
//     layout.getCell("select_options").attach(grid_layout);

        
//     //we build a layout here in order to have the add/delete buttons on top. this is not possible with grid only?

    
//     //EVENTS 

//     //add/remove row button click event
//     await dhx.awaitRedraw();
//     $(".option_grid_button").click(function(evt){
//         if(evt.currentTarget.id == "addRow"){
//             var added_row = opts_grid.data.add({value:"value",content:"content"});
//             saveOptsGridChanges();
//             dhx.awaitRedraw().then(function () {
//                 opts_grid.scrollTo(added_row, "value")
//             })
//         }else{
//             //todo.get selected row
//             var selcel = opts_grid.selection.getCells();
//             console.log("delete row:",selcel[0].row)
//             opts_grid.data.remove(selcel[0].row.id);
//             dhx.awaitRedraw();
//             saveOptsGridChanges();
//         }
//     });

//     opts_grid.events.on("afterEditEnd", function(value,row,column){
//         //cell was edited
//         console.log("Saving opts grid changes");
//         saveOptsGridChanges();

//     });

//     function saveOptsGridChanges(){
//         //udpates codemirror with changes
//         try{    
//             var _parsed = JSON.parse(layout.codemirror.getValue());
//             _parsed.options = opts_grid.data.serialize();
//             //remove id because it would pollute our json, it is auto generated
//             var without_id = _parsed.options.map(o=>{return {content:o.content,value:o.value}});
//             _parsed.options = without_id;
//             layout.codemirror.setValue(JSON.stringify(_parsed,null, "   "));
//         }
//         catch(ex){
//             console.log("options error:",ex)
//             alert("Could not update 'options' of variable Data JSON definition. Did you manually edit the Data Field?")
//         };
//     }
// }

// function getDataInputValue(){
//     var dataInput = document.querySelector('[data-dhx-id="data"]');
//     alert(dataInput.value)
//     return dataInput.value;
// }

// async function do_previewForm(value,bottom_layout_cell,selected_var_name){
//     /* parses and previews current webui type variable config */
//     const layout = new dhx.Layout(null, {
//         type:"line",
//                 rows: [
//                     {
//                         header:"Preview",
//                         id: "previewlayout",
//                         resizable:false,
//                         css:"seekme2"
//                     },
//                     {
//                         height: 80,
//                         id: "testerlayout",
//                         resizable:false,
//                     },
//                 ]
//             });
//     bottom_layout_cell.attach(layout);

//     try{
//         var item_config = JSON.parse(value);
//         if (item_config.validation){
//             //transform validation into function that applies regex
//             //make sure this is in sync with webuiVariables.js addvalidation function. We must do that manually here to avoid 
//             item_config = _addValidation(item_config)
//             // item_config.validregex = item_config.validation;
//             // if (!original.validation.match ("email|integer|numeric|alphanumeric|IPv4")){
//             //     item_config.validation = function(value){
//             //         console.log("validating",value)
//             //         return value.match(item_config.validregex);
//             //     }
//             // }
//         }


//         var testerFormItems = {css:"seekme3",
//                             "cols":[
//                                 {"view":"flat","css":"dhxform_obj_dhx_skyblue","circle":true,"type":"button","name":"btn_test","text":"Test Submit","color":"primary"},
//                                 {
//                                     "type": "input",
//                                     "name" : "final_value",
//                                     "label": "Workflow Value:",
//                                     "readOnly":true,
//                                     "labelPosition": "left",
//                                     "labelWidth": 140,
//                                     "placeholder": "",
//                                     "preMessage": "The value that  %" + selected_var_name + "% would have when submitting the job"
//                                 }
//                         ]}
//         var preview_form = new dhx.Form(null,{
//             rows: [item_config]
//         });
//         var test_form = new dhx.Form(null,{
//             rows: [testerFormItems]
//         });

//         layout.getCell("previewlayout").attach(preview_form);             
//         layout.getCell("testerlayout").attach(test_form); 

//         preview_form.events.on("change",function(name, new_value){
//             preview_form.validate();
//         });
        
//         // preview_form.getItem("simplevault").data.events.on("afterAdd", function(file) {
//         //     preview_form.getItem("simplevault").send()
//         // });

//         test_form.getItem("btn_test").events.on("click", function(value,row,column){
//             console.log("testing start");
//             preview_form.validate();
//             console.log("testing validation done");
//             var prev_form_itms = preview_form.getValue();
//             delete(prev_form_itms.final_value);
//             var user_item = Object.values(prev_form_itms)[0];
//             console.log("set final value. all user item values:",Object.values(prev_form_itms));
//             test_form.getItem("final_value").setValue(""); //this works around an issue with combo where after second selection, the final value is not displayed updated
//             dhx.awaitRedraw();
//             test_form.getItem("final_value").setValue(user_item);
//             dhx.awaitRedraw();
//         });

//     }catch(ex){
//         //show error in bottom cell
//         console.log(ex)
//         bottom_layout_cell.attachHTML("Error: " + ex.stack + " Value was: " +value);
//     }
// }

async function saveVariable(var_name,data_value){

     var to_save = {name:var_name,data:data_value};
    console.log("Saving var:",to_save);
    try{
        await saveVariableAjax(to_save);
        
    }catch(ex){
        alert("Error saving variable: "+ ex.responseText());
        console.error(ex);
    }

}


</script>
</head>
<body onload="init()">
<div id="windowcontainer">

</div>
</body>
</html>