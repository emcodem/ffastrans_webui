<html>
<head>
<script src="/socket.io/socket.io.js"></script>

<script src="../dependencies/jquery/jquery.js"></script>
<link rel="icon" href="favicon.ico?v=1.1">
<link rel="stylesheet" href="../dependencies/fontawesome/css/all.css" />
<link href="../dependencies/MaterialDesign-Webfont-7.2.96/css/materialdesignicons.min.css" media="all" rel="stylesheet" type="text/css" />

<link rel="stylesheet" href="../dependencies/fancytree/skin-ffastrans/ui.fancytree.css"/>
<script src="../dependencies/fancytree/modules/jquery.fancytree.ui-deps.js"></script>
<script src="../dependencies/fancytree/modules/jquery.fancytree.js" type="text/javascript"></script>
<script src="../dependencies/fancytree/modules/jquery.fancytree.filter.js" type="text/javascript"></script>
<script src="../dependencies/fancytree/modules/jquery.fancytree.multi.js"></script>
<script src="../dependencies/fancytree/modules/jquery.fancytree.persist.js"></script>

<!-- pagination -->
<script src="../dependencies/pagination/pagination.min.js"></script>
<link rel="stylesheet" href="../dependencies/pagination/pagination.css" type="text/css">

<script src="common/buildWorkflowTree.js"></script> <!-- function parseWorkflows -->
<!--
<link rel="stylesheet" href="../dependencies/dhtmlx/8.0.0/suite.css" type="text/css"/>
<script src="../dependencies/dhtmlx/8.0.0/suite.umd.js"></script> -->

<link rel="stylesheet" href="../dependencies/dhtmlx/9.0.1/suite.min.css" type="text/css"/>
<script src="../dependencies/dhtmlx/9.0.1/suite.umd.js"></script>

<link rel="stylesheet" href="../dependencies/dhtmlx/dhtmlx.css" id="theme_loader" type="text/css">
<link rel="stylesheet" href="../dependencies/css/global.css" id="theme_loader" type="text/css">

<link rel="stylesheet" href="/alternate-server/css/override.css"/>
<script>
    //theme changeer
    if (localStorage.global_skin_dark == "1"){
        try{
            document.querySelector("#theme_loader").href = document.querySelector("#theme_loader").href.replace("dhtmlx.css","dhtmlx_benjamin.css")
        }catch(ex){}
        try{
            dhx.setTheme("dark");
        }catch(ex){}
        try{
            dhx8.dhx.setTheme("dark");
        }catch(ex){}
    }
</script>

<style>
    /* it's important to set width/height to 100% for full-screen init */
    html, body {
        /* width: 100%; */
        height: 100%;
        margin: 0px;
        overflow: hidden;
        color: #333;
        font: 12px Tahoma;
        line-height: 18px;

    }

    .fas {
        opacity: 0.9;                /* Opacity (Transparency) */
        color: rgba(0, 0, 0, 0.9);   /* RGBA Color (Alternative Transparency) */
    }

    .progressbar {
        margin: 0;
        /* margin-left:5px;
        margin-right:5px; */

        line-height: 140%;
        font-size: 10;

        background-color: #4caf5080;
        padding: 0;
        text-align: center;
        vertical-align: middle;
        white-space: nowrap;
    }

    /*layout headers (big blue lines)*/
    .dhxlayout_base_material div.dhx_cell_layout div.dhx_cell_hdr {
        height: 25px;
        line-height: 23px;
        font-size: 12px;
    }

    /*collapse icon in layout header*/
    .dhxlayout_base_material div.dhx_cell_layout div.dhx_cell_hdr div.dhxlayout_arrow.dhxlayout_arrow_ha {
        background-position: -32px -5px;
        z-index: 1;
        margin-top: -3;
    }
    /*collapse icon in layout header*/
    div.dhx_cell_layout div.dhx_cell_hdr div.dhxlayout_arrow.dhxlayout_arrow_vb {
        margin-top: -8px;
        z-index: 1;
    }

    /* if we use direction rtl, browser can put \\ from beginning of text to end of text, very nasty */
    .celltext_rtl {
        justify-content: flex-end;
        display: flex;
		overflow:hidden; 
        text-overflow: ellipsis;
        user-select: text;
    }

    .pagination_total_count{
        position: absolute;
        right: 0;
        margin-right: 30;
    }

    /*three dots on text overflow*/
    /* .celltext {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        user-select: text;
        margin-left: 6px;
		margin-right: 6px;
    }


    .celltext_clicked {
        text-overflow: clip;
        white-space: normal;
        word-break: break-all;
        user-select: text;
    } */

    /*context menu stuff*/
    /* td:hover {
        opacity:0.5;
    }
    .context-menu-active {
        opacity:0.5;
    } */

	/*keeps sort icon on top*/
	i[id^='history-']{

		margin-top:3px;
	}
	/*keeps sort icon on top*/
	i[id^='active-']{

		margin-top:3px;
	}


    ul.fancytree-container {
        font-size:12px !important;
    }


    /* NEW STUFF */
    /* searchbox  */

    /* narrow space in header cell helps to fit all searchbox stuff*/
    .dhx_grid-header-cell{
        padding-left: 5px; 
    }

    .searchbox {
            width: 100%;
            height:22px;
            /* pointer-events: none; */
            transition: opacity 0.3s ease;
    }

    .searchbox:hover,.searchbox:focus {
            pointer-events: auto;
    }

    .searchbox-icon-left{
        font-size:15px;
        width:25px;
        padding-left:5px;
        flex-shrink: 0;
        margin-top:1px;
        cursor:pointer;
    }
    .searchbox-icon-right{/*spacer to fit dhtmlx inbuilt reorder icon*/
        font-size:15px;
        width:25px;
        flex-shrink: 0;
        margin-top:1px;
    }
    .searchbox_container:hover{
        opacity: 1;
        pointer-events: auto;
    }
    .searchbox_container{
        opacity: 0;
        left:0;
        display:flex;
        align-items: center;
        position: absolute;
        width:100%;
        max-width:100%;
        height: 100%;
    }
    .searchbox_container.active{
        /* keeps searchbox visible if not empty. Setting background ensures that the header text is not visible */
        background-color:var(--dhx-s-grid-header-background);
        opacity: 1;
    }
    
    .grid_header_text{
        opacity:1;
    }

    .dhx_grid-header-cell:hover .grid_header_text{
        /* hide header text on hover. todo: this is not helpful because we also want to hide the text when searchbox_container has .active class 
           as a workaround, we currently set background-color of searchbox_container.active, not very shiny...
        */
        opacity: 0;
    }

    /* grid and rows */
    .ffastrans_grid_style{
        --dhx-font-family:"Tahoma";
        --dhx-font-size-normal:12px
    }

    .dhx_grid-selected-row{
        background:  rgba(0, 128, 255, 0.250)
    }

    .dhx_grid-cell__content{
        user-select: text;
    }

    .dhx_grid-row{
        /* transition: transform ease 0.05s, box-shadow ease 0.05s; */
        box-shadow: unset;
        transition-timing-function: ease-in;
        transition: box-shadow 1s;
    }

    .dhx_grid-row:hover {
        /* background-color: var(--dhx-color-primary-light-hover) !important;
        box-shadow: 2px 2px 0px 0px #4777e0 !important; */
        position:relative;
        overflow: visible;
        background-color: transparent;
        /* box-shadow: 0 0 4px 0.5px rgba(14, 61, 162, 0.708);  */
        box-shadow: 0 0 4px 0.5px rgb(231, 231, 231);
        transition-timing-function: ease-in;
        transition: box-shadow .7s;
    }

    .row_status_sucess{
        background-color: #33333330;
    }

    /* jobviewer buttons */

    .jobviewer_menu_container{
        container-name: css_container_jobviewer_menu_container;
        container-type: inline-size;
        white-space: nowrap;
        overflow: hidden;
        font-size: 12px;
        user-select: none;
        position: absolute;
        height: 100%;
        display: flex;

        /* if you change left you need to change width calc and vice versa */
        width: calc(100% - 190px);
        left: 150;

        justify-content: flex-start;
        align-items: center;
        flex-shrink: 1; 
        
    }

    .btn.jobviewer_menu.right{
        position: absolute;
        right: 0; /* Position it on the right side */
    }

    .btn.jobviewer_menu {
        height:17px;
        width:120px;
        font-size: inherit;
        color:inherit;
        padding-bottom: -2px;
        border: var(--dhx-border);
    }

    button.jobviewer_menu {
        cursor: pointer;

        margin-right: 10px;
        white-space: nowrap;
    }

    .btn.jobviewer_menu:disabled{
        background: transparent !important;
    }

    .btn .jobviewer_menu span{
        position: relative;
        top: -1;
    }


    /* workflow selection */

    .button_workflow_filter_menu_item {
        width:22px;
        height:21px;
        cursor:pointer;
        margin-top:4px;
        background-color: unset;
        border:var(--dhx-border);

    }
    /* reset workflow search btn */
    .button_workflow_filter_menu_item i{

        margin-left:-1px;
        font-size:10px;

    }

    /* collapsed workflow layout cell */
    .dhx_layout-columns > .dhx_layout-cell--collapsed {
        width: 30px!important;
    }

    /* .dhx_layout-cell--collapsed{
        margin-right: 6px!important;
    } */

    /* jobgrid */
    .dhx_layout-cell--collapsed .dxi-chevron-right{
        margin-left: -7px;
    }

    /* layout */
    .dhx_layout-wide.dhx_layout-rows>.dhx_layout-cell{
        margin-bottom:6px;
    }

    .dhx_layout-cell-header__title{
        overflow:visible;
        user-select: none;
    }

    div .dhx_layout-cell-header.dhx_layout-cell-header--row.dhx_layout-cell-header--collapseble {
        position:relative;
    }
    /* button.jobviewer_menu:hover{
        transform: scale(1.1)
    } */

    /* @media all and (max-width: 950px){
        .jobviewer_menu {
            display: none !important;
        }
    } */
    /* @container css_container_jobviewer_menu_container (max-width: 700px) {
        .btn.jobviewer_menu span{
            font-size: 0px;
            color:green;
            width:20px;
        }
        .btn.jobviewer_menu{
            color:green;
            width:20px;
        }
    }    */
    

</style>

<script type="module">
    /* init SOCKET.IO */
    var socket = io();

    /* GLOBALS */
    var mainLayout, runningJobGrid, m_serverconfig, m_userpermissions, m_lastsortelementid, m_lastsortdir;
    let m_jobviewerLayoutSettings = localStorage.jobviewer_layout ? JSON.parse(localStorage.jobviewer_layout) :  {};
    let m_historyGrid;
    let m_activeGrid;
    let m_workflowArray;
	var m_max_history_gridrows = localStorage.getItem("jobviewer_rows_per_page") || 100;
    var m_query = {}; //url parameters

    /* global function override */
    //backward compatible dhtmlx message
    const dhtmlx = {};
    dhtmlx.message= function(what){
        dhx8.dhx.message({ expire: 3000, text: what});
    }
    dhtmlx.alert= function(what){
        dhx8.dhx.message({ expire: 3000, text: what});
    }

    document.addEventListener('keydown', (event) => {
        //if shiftkey is pressed, clear text selection, prevents unwanted selecting text over multiple gridrows when marking multiple
        if ("INPUT" == (event.target.nodeName))
            return false;
        if (event.key === 'Shift'){
            document.getSelection().removeAllRanges();
        }
    });

    /* global click handler */
    document.addEventListener("click", function(evnt){
        //unselect selected grid rows if not clicked within a grid (or on some text in grid)
        if (Array.from(evnt.target.classList).join("").match(/dhx_grid-cell__content|celltext_rtl/ ))
            return true;
            
        console.log("Clearing grid selection because of click")

        if(m_historyGrid && m_activeGrid){
            //disable selection in the grids
            m_historyGrid.selection.removeCell();
            m_activeGrid.selection.removeCell();
            toggleJobControl("active",false);
            toggleJobControl("history",false);
        }
    });

    /*load config from server*/
    window.loadserverconfig = loadserverconfig; //used by html
    function loadserverconfig() {
        $.ajax({
            url: ("/getuserpermissionsasync" + "?" + Math.random()),
            type: "GET",
            success: function(response) {

                m_userpermissions = JSON.parse(response);
                //load serverconfig and initialize page
                $.ajax({
                    url: ("/getserverconfig" + "?" + Math.random()),
                    type: "GET",
                    success: function(response) {
                        m_serverconfig = JSON.parse(response);
                        init();
                    },
                    error: function(xhr, status) {
                        dhtmlx.message("Fatal error, could not load serverconfig. ");
                        document.body.innerHTML = "Fatal error, could not load serverconfig. " + xhr.responseText;
                    }
                });
            },
            error: function(xhr, status) {
                dhtmlx.message("Fatal error, could not load serverconfig. ");
                document.body.innerHTML = "Fatal error, could not load serverconfig. " + xhr.responseText;
            }

        });

    }

    function toggleJobControl(id,selected_is_on){
        //enable/disable menu buttons
        var element_names = [];
        if (id.match("active")){
            element_names = ["a_details","a_abort","a_pause","a_resume"];
        }
        if (id.match("history")){
            element_names = ["b_details","b_resubmit","b_delete_selected"];
        }

        element_names.forEach(function(name){
            try{
                document.getElementsByName(name)[0].disabled = !selected_is_on;
                var icon = document.getElementsByName(name)[0].getElementsByTagName("i")[0];
                if (selected_is_on){
                    icon.classList.remove("disabled")
                }else{
                    icon.classList.add("disabled")
                }
            }catch(ex){
                //who
            }
        })

    }

    /* render menu buttons based on permissions*/
    async function addMenuButtons(){

        function _appendtext (headerText, to_append){//helper
            let headers = document.querySelectorAll(".dhx_layout-cell-header__title")
            let header = [...headers].filter(e => e.innerText === headerText);
            header[0].insertAdjacentHTML( 'afterEnd', to_append );

            //appends text to mainLayout.cells("b") and mainLayout.cells("c")
            //mainLayout.getCell(cellid).config.header = mainLayout.getCell(cellid).config.header + to_append;
        }


        //menu buttons html
        //do not forget to add the button name to togglejobcontrol if you add more btns
        var a_details = '<button class="btn jobviewer_menu" name="a_details" disabled="true" onclick="event.stopPropagation();active_grid_actions(this.name)"><i style = "margin-right:3px" class= "fas fa-info-circle fa-sm disabled" ></i><span>Job Details</span></button> ';
        var a_abort =   '<button class="btn jobviewer_menu" name="a_abort" disabled="true"  onclick="event.stopPropagation();active_grid_actions(this.name)"><i style = "margin-right:3px;" class= "fas fa-stop fa-sm disabled" ></i><span>Abort</span></button> ';
        var a_pause =   '<button class="btn jobviewer_menu" name="a_pause" disabled="true"  onclick="event.stopPropagation();active_grid_actions(this.name)"><i style = "margin-right:3px" class= "fas fa-pause fa-sm disabled" ></i><span>Pause</span></button> ';
        var a_resume =  '<button class="btn jobviewer_menu" name="a_resume" disabled="true"  onclick="event.stopPropagation();active_grid_actions(this.name)"><i style = "margin-right:3px" class= "fas fa-play fa-sm disabled" ></i><span>Resume</span></button>   ';
        // var a_prio  =  '<button class="btn jobviewer_menu" name="a_priority" disabled="true"  onclick="click_a_header(this.name)"><i style = "margin-right:3px" class= "fas fa-clock fa-sm disabled" ></i>Priority</button>   ';
        var a_opts  =    '<button class="btn jobviewer_menu right" name="b_options" onclick="event.stopPropagation();history_grid_actions(this.name)" ><i style = "margin-right:3px;" class= "fas fa-cog fa-sm" ></i><span>Options</span></button> ';

        var arr_all_in_a = [a_details,a_abort,a_pause,a_resume,a_opts];

        var b_details =              '<button class="btn jobviewer_menu" name="b_details" disabled="true"  onclick="event.stopPropagation();history_grid_actions(this.name)"><i style = "margin-right:3px" class= "fas fa-info-circle fa-sm disabled"></i><span>Job Details</span></button> ';
        var b_resubmit =             '<button class="btn jobviewer_menu" name="b_resubmit" disabled="true"  onclick="event.stopPropagation();history_grid_actions(this.name)"><i style = "margin-right:3px" class= "fas fa-retweet fa-sm disabled"  ></i><span>Resubmit</span></button> ';
        var b_delete_selected =      '<button class="btn jobviewer_menu" name="b_delete_selected" disabled="true" onclick="event.stopPropagation();history_grid_actions(this.name)"><i style = "margin-right:3px" class= "mdi mdi-trash-can-outline disabled" ></i><span>Delete Selected</span></button> ';
        var b_jobchart =             '<button class="btn jobviewer_menu right" name="b_jobchart"  onclick="event.stopPropagation();history_grid_actions(this.name)"><i style = "margin-right:3px" class= "mdi mdi-chart-bar" ></i><span>Chart</span></button> ';
        var arr_all_in_b = [b_details,b_resubmit,b_delete_selected,b_jobchart];


        //check user permissions
        var _filter = _getObjectByValue(m_userpermissions,"FILTER_JOBSTATUS_BUTTONS");
        if (_filter.length > 0){

            var regex = new RegExp( _filter[0]["value"]["filter"], 'i' );
            console.log("Displaying filtered list of buttons, regex: ", regex);

            //add filtered btns to Running jobgrid
            _appendtext('History',"<div class='jobviewer_menu_container historygrid'  ></div>");
            _appendtext('Running',"<div class='jobviewer_menu_container activegrid'  ></div>");

            for (let _id=0;_id<arr_all_in_a.length;_id++){
                var input_name = arr_all_in_a[_id].match(/name="(.*?)"/)[1];
                if (regex.test(input_name)){
                     document.querySelectorAll(".jobviewer_menu_container.activegrid")[0].innerHTML += (arr_all_in_a[_id])
                }
            }
            //no filter, add filtered btns to History jobgrid
            for (let _id=0;_id<arr_all_in_b.length;_id++){
                var input_name = arr_all_in_b[_id].match(/name="(.*?)"/)[1];
                if (regex.test(input_name)){
                    document.querySelectorAll(".jobviewer_menu_container.historygrid")[0].innerHTML += (arr_all_in_b[_id])
                }
            }
        }else{
            //just render all btns
            console.log("Displaying unfiltered list of menu buttons" )
            _appendtext('Running',"<div class='jobviewer_menu_container historygrid'>" + arr_all_in_a.join("") + "</div>");
            _appendtext('History',"<div class='jobviewer_menu_container activegrid'>" + arr_all_in_b.join("") + "</div>");
        }

        document.querySelector('.jobviewer_menu_container').addEventListener('click', function(event) {
                
                //event.stopPropagation(); //attempt to disable collapse on click everywhere but this way buttons also dont click
                
         }, true); 

        // let pageText = `<span id="page_number_text" style="margin-right:15px;font-size:13px;color:#888888" ></span>`;
        // _appendtext("History",pageText);

        let spacer = `<div style='width:75px'></div>`;
        _appendtext('Running',spacer);
        let spacer_with_pagenum = `<div>&nbsp;<span id="page_number_text" class="page_number_text" style="margin-right:15px;font-size:13px;color:#888888; white-space: nowrap;" ></span>&nbsp;</div>`;
        _appendtext('History',spacer_with_pagenum);

    }

    function _getObjectByValue(object, value) {//helper
        var to_return = [];
        for (var _idx in object){
           var _v =  object[_idx]["key"];
           if (_v == value){
            to_return.push(object[_idx]);
           }
        }
        return to_return;
    }

    function applyFilter(filtername,filtervalue){
        /* inserts filter into grid header and hits enter */
        const searchboxes = document.querySelectorAll('.searchbox');
        searchboxes.forEach((searchbox) => {
            let header_id = searchbox.closest('.dhx_grid-header-cell').dataset.dhxId;
            if (header_id.toUpperCase().match(filtername.toUpperCase())){
                searchbox.value = filtervalue;
                console.log("triggering enter on ",searchbox.id)
                $(searchbox).trigger("input");
            }
        })

    }

    /* build basic page layout and init periodic job loading*/
    async function init() {

        //search params from URL go to their corresponding search inputs
        var query = window.location.search.substring(1);
        query = parse_query_string(query);
        m_query = query;
        console.log("Querystring",query);
        //insert filter from url into search text fields
        for (var filtername in query) {
            if (query.hasOwnProperty(filtername) && filtername != "") {
                console.log(filtername + " -> " + query[filtername]);
                applyFilter(filtername, query[filtername])
            }
        }

        //check if html5 features supported
        if (typeof(Storage) !== "undefined") {} else {
            dhtmlx.message("ERROR, no html5 store support, cannot save view state")
        }

        let layoutConf = {
            type: "wide",
            padding:5,
            cols: [
                {
                    id: "a",
                    resizable:true,
                    gravity: 1,
                    collapsed: false,
                    collapsable:true,
                    header: "Workflow",

                },
                {
                    id:"grid_container_cell",
                    gravity: 100,
                    rows: [
                        {
                            id: "b",
                            gravity:220,
                            resizable:true,
                            collapsable:true,
                            header:"Running"
                        },
                        {
                            id: "c",
                            gravity:100,
                            resizable:true,
                            collapsable:true,
                            header:"History"
                        },
                    ]
                },
            ]
        };

        //parse the layout config, construct layout object
        mainLayout = new dhx8.dhx.Layout(document.body, layoutConf);

		if (m_serverconfig["alternate-server"] != true && m_serverconfig["alternate-server"] != "true"){
			//buildWorfklowTree(); //load workflows

			//mainLayout.getCell("a").header = ('<span id="workflow_filter_header_expanded" style="margin-right:15px;font-size:13px;display:flex" >Workflows</span>');

		}else{
            mainLayout.getCell("a").config.header  = "";
            mainLayout.getCell("a").config.width   = 0;
			console.log("alternate server is true!");
            mainLayout.getCell("a").collapse();
		}


        function saveLayoutConf(){

            let cells = [];
            mainLayout.forEach(function (cell, index) {
                cells.push({
                    id: cell.id,
                    collapsed: cell.config.collapsed,
                    height: cell.config.height
                })
            });
            m_jobviewerLayoutSettings.layoutCells = cells;
            localStorage.setItem("jobviewer_layout",JSON.stringify(m_jobviewerLayoutSettings));
            console.log("saveLayoutConf",m_jobviewerLayoutSettings);
            console.log("saveLayoutConf current",mainLayout);
        }

        mainLayout.events.on("afterResizeEnd", function(id){
            saveLayoutConf();
        });

        mainLayout.events.on("afterCollapse", function(id){
            console.log("Collapsed",id)
            saveLayoutConf();
        });

        mainLayout.events.on("afterExpand", async function(id){
            
            //after expand, we need to redraw the cell content, it is destroyed on collapse
            if (id == "a"){
                console.log("Workflow Tree Expand")
                m_jobviewerLayoutSettings.workflowtree_collapsed = false;
                buildWorfklowTree();
            }
            if (id == "b"){
                mainLayout.getCell("b").attach(await buildActiveGrid());
                m_activeGrid.loadGridData_internal();
                mainLayout.getCell("c").config.height = "60%";
                await dhx8.dhx.awaitRedraw();
            }
            if (id == "c"){
                mainLayout.getCell("c").attach(await buildHistoryGrid());
                m_historyGrid.loadGridData();
            }
            saveLayoutConf();
        });

        mainLayout.events.on("afterResizeEnd", function(id){
            //savelayoutsizes
        });

        function restoreLayoutConf(){

            try{
                console.log("restoring layout config");
                //restore layout conf
                if (m_jobviewerLayoutSettings.layoutCells){
                    console.log("Restore Layout conf",m_jobviewerLayoutSettings.layoutCells);
                    m_jobviewerLayoutSettings.layoutCells.forEach(c=>{
                        let targetCell = mainLayout.getCell(c.id);
                        targetCell.config.collapsed = c.collapsed;
                        if (c.height){
                            targetCell.config.height = c.height;
                        }
                    })
                }
            }catch(ex){}
        }

        restoreLayoutConf()
        await dhx8.dhx.awaitRedraw();

        //Query params override localStorage config
        if (query["hiderunning"]){
            mainLayout.getCell("b").config.hidden=true;
            mainLayout.getCell("c").config.height = "100%";
        }
        if (query["hidehistory"]){
            mainLayout.getCell("c").config.hidden=true;
            mainLayout.getCell("b").config.height = "100%";
        }
        if (query["hideworkflow"]){
            mainLayout.getCell("a").config.hidden=true;
        }
        if (query["hideheaders"]){
            delete mainLayout.config.cols[0].header;
            delete mainLayout.config.cols[1].rows[0].header;
            delete mainLayout.config.cols[1].rows[1].header;
            mainLayout.paint();
            await dhx8.dhx.awaitRedraw()
        }else{
            addMenuButtons();
        }
        //finally load data into grids
        if (!mainLayout.getCell("a").config.hidden){
            buildWorfklowTree();
            console.log("Cell A config: ",mainLayout.getCell("c").config)
        }


        mainLayout.getCell("b").attach(await buildActiveGrid());
        m_activeGrid.loadGridData();

        mainLayout.getCell("c").attach(await buildHistoryGrid());
        m_historyGrid.loadGridData();

        await dhx8.dhx.awaitRedraw();

        //Socket events
        socket.on('newhistoryjob', async function() {
            console.log("got newhistoryjob event from jobfetcher")
            m_historyGrid.loadGridData();
        });

        socket.on('queuedjobs', function(msg) {

        });
        socket.on('activejobs', async function(count) {
            console.log("got activejobs message from jobfetcher",count)
            m_activeGrid.loadGridData();
        })

        socket.on('error', function(msg) {
            dhtmlx.message(msg);
        });
        socket.on('msg', function(msg) {
            dhtmlx.message(msg);
        });

        /* check if new activejobs forever */
        window.setInterval(function() {
            m_activeGrid.loadGridData();
        }, parseInt(3000));


    }


function buildWorfklowTree(){
    mainLayout.getCell("a").progressShow();
    $.ajax({
        url:  "/getworkflowlist?nodetails=true",
        type: "GET",
        crossDomain: true,
        dataType: "json",
        success: async function (response) {
            console.log("workflows",response)
            if (response['workflows'].length == 0){
                alert("Did not get any workflows from FFASTRANS API");
            }else{
                m_workflowArray = response['workflows'];
                mainLayout.getCell("a").progressHide();

                //mainLayout.getCell("a").detachObject();
                let treehtml = `
                        <div id="workflow_filter_menu" class="workflow_filter_background">
                            <div class='dhtmlxMenu_dhx_skyblue_Middle workflow_filter_menu_item' style='display:flex;width:100% ;height:40px;'>
                                <div style="float:left;display:block;margin-top:5px;margin-left:5px">
                                    <button title="Delete Selection (Show all Workflows)" name="delete_selected" class="button_workflow_filter_menu_item" style="" onclick="clear_workflow_tree_selection(this)" id="wf_filter_clear" >
                                        <i class="fas fa-ban" style=""></i>
                                    </button>
                                    </div>
                                <div style="float:left;margin-top:10px;margin-left:5px;display:flex;max-width:180px;white-space:nowrap;overflow:hidden">
                                    <input name='wf_filter' class="workflow_filter_menu_item" style='float:left;max-width:150px;height:20px;' id='wf_filter' autocomplete='off'></input>

                                </div>
                        </div>
                            <div id='workflowtree' style='margin-left:10px;margin-top:10px;margin-bottom:40px'/>
                        </div>
                `
                mainLayout.getCell("a").attachHTML(treehtml);
                await dhx8.dhx.awaitRedraw();
                //search button
                $("input[name=wf_filter]").keyup(function(e){
                    var n,
                        tree = $("#workflowtree").fancytree('getTree');
                        opts = {},
                        filterFunc = tree.filterNodes,
                        match = $(this).val();
                        if(e && e.which === $.ui.keyCode.ESCAPE || $.trim(match) === ""){
                            tree.clearFilter();
                            return;
                        }
                    // Pass a string to perform case insensitive matching
                    n = filterFunc.call(tree, match, opts);

                }).focus();

                //finally build workflow tree
                parseWorkflows(m_workflowArray,{"selectMode":2,"dom_id":"workflowtree","extensions":["filter","multi","persist"]},on_treeWorkflowSelected,function(){/*no click evt*/});
                if ($("#workflowtree").fancytree('getTree').hasOwnProperty("getSelectedNodes")){
                    var sel = $("#workflowtree").fancytree('getTree').getSelectedNodes();            
                    if (sel.length != 0){
                        //on initial page load, don't apply the filter if empty
                        applyWorkflowSearch(sel);
                    }
                }      
            }
        },
        error: function (xhr, status) {
            mainLayout.getCell("a").progressHide();
            dhtmlx.message("ERROR getting WORKFLOWS, please check FFAStrans Path in Admin settings on the left. or you have an invalid expression in filter?");
        }
    });
}

function applyWorkflowSearch(selectednodes){
    var searchpatterns = [];
    selectednodes.forEach(function(n){
        if (n.folder){
            //unselect folders
            console.log("unselecting folder",n.title)
            n.setSelected(false)
        }else{
            searchpatterns.push(n.title);
        }
    })
    console.log("Applying filter search from applyWorkflowSearch",searchpatterns)
    applyFilter("workflow",searchpatterns.join("|"));
}


function on_treeWorkflowSelected(event, data){
    //user selected a workflow, modify workflowfilter

    var s = data.tree.getSelectedNodes();
    console.log("on_treeWorkflowSelected");
    applyWorkflowSearch(s);
}


// function setInitialColumnWidths(){

//     /*only set column widths if there ar no stored ones*/
//     var do_restore = true;
//     if ("treetable_active" in localStorage){
//         console.log("Not restoring InitialColumnwidths as it is not the first time user opened the site")
//         do_restore = false;
//     }
//     console.log("Setting initial width percent values")
//     var running_percent = m_serverconfig["STATIC_RUNNING_GRID_COL_WIDTHS_PERCENT"].split(",");
//     console.log(running_percent)
//     var idx = 0;
//     $('#colgroup_active').children('col').each(function () {
//         try{

//             if (!running_percent[idx] && do_restore){
//                 $($('#colgroup_active').children('col')[idx]).css("width","4%"); //minimum width
//             }
//             if (running_percent[idx] && (do_restore)){
//                 console.log($($('#colgroup_active').children('col')[idx]),running_percent[idx])
//                 $($('#colgroup_active').children('col')[idx]).css("width",running_percent[idx])
//             }
//             if (running_percent[idx] == "0%"){
//                 //hide if admin config is 0%
//                 $($('#tr_treetable_active').children('th')[idx]).css("display","none")
//             }

//         }catch(ex){
//             console.log(ex)
//         }
//         idx++;
//     });

//     var history_percent = m_serverconfig["STATIC_FINISHED_GRID_COL_WIDTHS_PERCENT"].split(",");
//     idx = 0;
//     $('#colgroup_history').children('col').each(function () {
//         try{
//             if (!history_percent[idx] && do_restore){
//                 $($('#colgroup_active').children('col')[idx]).css("width","4%"); //minimum width
//             }
//             if (history_percent[idx] && ( do_restore)){
//                 $($('#colgroup_history').children('col')[idx]).css("width",history_percent[idx])
//             }
//             if (history_percent[idx] == "0%"){
//                 $($('#tr_treetable_history').children('th')[idx]).css("display","none");
//             }
//         }catch(ex){
//         }
//         idx++;
//     });
// }


function show_options_window(){
    const dhxWindow = new dhx8.dhx.Window({
        width: 600,
        height: 600,
        title: "Options",
        modal: false,
        closable: true,
        movable: true,
        resizable:true
    });

    dhxWindow.attachHTML('<iframe height="100%" width="100%" style="border:none" src="jobviewer_pages/options.html"></iframe>');
    dhxWindow.show()
    // var dhxwins = new dhtmlXWindows();
    // var win = dhxwins.createWindow("View Options", window.innerWidth/2, window.innerHeight/4, 600, 600);
    // win.setText("View Options ");
    // win.attachURL("jobviewer_pages/options.html");
}

async function showJobChart(){
    //this is the first es6 module we use, we should do that in future more often :D
    try{
        const chartmodule = await import('./jobviewer_pages/ES6modules/jobchart.js');
        console.log("ES6:",chartmodule.doTheMagic(m_historyGrid.data.serialize()))
        

    }catch(ex){
        console.error(ex)
    }

}

window.history_grid_actions= history_grid_actions;
function history_grid_actions(id,node) {
    //if we have node argument, we are called from context menu
    if (id == "b_jobchart"){
        showJobChart();
    }
    if (id == "b_options") {
        show_options_window();
        return;
    }

    let selected = m_historyGrid.selection.getCells();

    if (selected.length == 0 ) {
        dhtmlx.alert("Please select row");
        return;
    }
    if (id.match("resubmit")) {
        selected.forEach(function(node) {
            resubmit_job(node.row.guid||node.row.job_id);
        })
    }
    if (id.match("details")) {
        var jobid = (selected[0].row.job_id);
        openLogViewer(jobid);
    }
    if (id.match("delete")) {
        let array_to_delete = [];
        let a_gridids = [];
        for (let i = 0; i < selected.length; i++) {}
        selected.forEach(function(cell_and_row) {
            array_to_delete.push(cell_and_row.row.job_id);
            a_gridids.push(cell_and_row.row.id)
        });
        m_historyGrid.data.remove(a_gridids);
        socket.emit("deletejob", JSON.stringify(array_to_delete)); //note, custom structure for socket.emit messages

    }
}


window.active_grid_actions= active_grid_actions;
function active_grid_actions(id,node) {
    //if we have node argument, we are called from context menu
    if (id == "b_options") {
        show_options_window();
        return;
    }

    let selected = m_activeGrid.selection.getCells();

    if (selected.length == 0 ) {
        dhtmlx.alert("Please select row");
        return;
    }
    // if (id.match("resubmit")) {
    //     selected.forEach(function(node) {
    //         resubmit_job(node.row.guid||node.row.job_id);
    //     })
    // }
    if (id == "a_details") {
        var jobid = (selected[0].row.job_id);
        openLogViewer(jobid);
    }
    if (id == "a_abort") {
        jobCommand(selected, "abort");//jobid for incoming jobs is the filename of mons/i file
    }
    if (id == "a_pause") {
        jobCommand(selected, "pause");
    }
    if (id == "a_resume") {
        jobCommand(selected, "resume");
    }
    if (id == "a_priority") {
        // show_priority_window();
    }
}

window.getActiveGridColumns = getActiveGridColumns;
function getActiveGridColumns(){
    //let searchboxhtml = `<input class="searchbox" placeholder="" onclick="event.stopPropagation()"></input>`;
    let searchboxhtml = ``;
    return [
                {
                    id: "state",maxWidth: 100,header: ["<span>State</span>" + searchboxhtml],sortable: true,
                    template:function(val,row,column){
                        if (row.children && row.children.length > 1){
                            let expander = `<div id="${row.job_id}_expander" class="expander dhx_grid-expand-cell-icon dxi dxi-chevron-right"
                                             role="button" aria-label="Collapse group" style="padding: 0px 0px 0px 0px;"></div>`
                            return expander + val;
                        }
                        return val;
                    },
                    htmlEnable:true
                },
                {
                    id: "workflow",
                    width:300,
                    header: ["<span>Workflow</span>"+ searchboxhtml],   sortable: true,htmlEnable: true,
                    template:function(val,row,column){
                        return val
                    }

                },
                {id: "job_start",   header: ["<span>Start</span>"+ searchboxhtml],      sortable: true,htmlEnable: true,  maxWidth: 152},
                {id: "source",      header: ["<span>File</span>"+ searchboxhtml],       sortable: true,htmlEnable: true,
                    template: function(val,row,column){
                        return '<span class="celltext_rtl">' + row.source + '</span>'
                    }
                 },
				{id: "proc",     	header: ["<span>Step</span>"+ searchboxhtml],       sortable: true,htmlEnable: true, maxWidth: 600,
					template: function(val,row,column){
						return "Prio " + (row.priority || "") + " | " + row.proc + " | " + row.host
				} },
				//Prio " +  (node.data.priority || 1) + " @ " + node.data.proc + " @ " + node.data.host
                {id: "status",      header: ["<span>Status</span>" + searchboxhtml],   sortable: true,htmlEnable: true },
				{id: "progress",    header: ["<span>Progress</span>" + searchboxhtml],  sortable: true,htmlEnable: true, width: 200,template: function(val,row,column){
                    return '<div class="progressbar" style=" width:' + row.progress + '%">' + row.progress + '% ' + row.steps.replace(/ /g, "") + '</div>'
                }},

        ];
}

async function buildActiveGrid() {
    console.log("building activegrid")

    //grid columns are defined on server side
    // let colres = await fetch("/get_jobviewercolumns");
    // if (!colres.ok)
    //     return dhx8.dhx.message({ expire: 3000, text: "Error loading grid config"});
    // let gridcolumns = await colres.json()
    let gridcolumns = getActiveGridColumns();

    // //apply user state
    if (localStorage.jobviewer_active_grid_column_config){
        try{
            //inject merit and hidden state from user config (options.html)
            let userconf = JSON.parse(localStorage.jobviewer_active_grid_column_config);
            gridcolumns = gridcolumns.map(c=>{
                let uc = userconf.filter(uc=>{return uc.id == c.id});
                if (uc.length != 1)
                    return c;
                c.hidden    = uc[0].user_hidden;
                c.merit     = uc[0].merit;
                return c;
            });

            gridcolumns.sort((a, b) => a.merit - b.merit);
        }catch(ex){console.error("Cannot restore user column config",ex)}
    }

    //gridcolumns = getActiveGridColumns();

    console.log("active gridcols with userdata",gridcolumns)

    /* build the grid */
    const grid = new dhx8.dhx.Grid(null, {
        columns: gridcolumns,
        keyNavigation: true,
        autoWidth: true,
        resizable: true,
        multiselection:true,
        height: "auto",
        rowHeight: 20,
        headerRowHeight: 30,
        selection: "row",
        css: "alternate_row ffastrans_grid_style",
        eventHandlers: {
            oninput:{
                searchbox: debounce((event,  args) => {

                    //debounce function prevents this to fire multiple times parallel while user is typing
                    //only if user did not type for 750ms, function will fire
                    grid.filterobj = collectFilters();
                    grid.data.removeAll();
                    loadGridData_internal();
                },750),
            }

        },
    });

    m_activeGrid = grid;
    //custom fields keep track of current state
    grid.filterobj      = {};
    grid.sortcol        = "state";
    grid.sortdir        = "asc";
    grid.mystuff        = {page:1}
    grid.loadGridData   = loadGridData;
    grid.loadGridData_internal   = loadGridData_internal;
    /* Row select */
    grid.selection.events.on("AfterSelect", (row, column) => {
        toggleJobControl("active",true);
    });

    /* Sorting */
    grid.events.on("beforeSort", async (column, dir) => {
        /* remove all rows and reload sorted data from server */
        grid.sortcol =  column.id;
        grid.sortdir =  dir;
        grid.data.removeAll();
        await dhx8.dhx.awaitRedraw();
        // grid.data.removeAll();
        // loadGridData();
        return false;
    });

    grid.events.on("afterSort", (column, dir) => {
        loadGridData_internal();
    })

    /* Searching */
    function collectFilters(){ //collects all search values
        let filterobj = {};
        filterobj.variablecols = [];
        const searchboxes = document.querySelectorAll('.searchbox');
        searchboxes.forEach((searchbox) => {
            let cont = searchbox.closest('.searchbox_container');
            if (searchbox.value == ""){
                cont.classList.remove("active");
                return;
            }
            cont.classList.add("active");
            let header_id = searchbox.closest('.dhx_grid-header-cell').dataset.dhxId;
            if (searchbox.dataset.variablecol){
                filterobj.variablecols.push({col_header_name:header_id,filter:searchbox.value});
            }else
                filterobj[header_id] = searchbox.value;

        })
        return filterobj;
    }

    /* Data loading */
    grid.throttleflag = {throttle:null};
    async function loadGridData(){
        throttle(loadGridData_internal,3000,grid.throttleflag,"active")();

    }

    async function loadGridData_internal(){
        console.log("loadactivejobs internal")
        let urlSearchParams =  new URLSearchParams({});

        // urlSearchParams.append("filterobj", JSON.stringify(grid.filterobj));
        urlSearchParams.append("sortcol", grid.sortcol);
        urlSearchParams.append("direction", grid.sortdir);
        // urlSearchParams.append("start", grid.mystuff.page == 1 ? 0 : m_max_history_gridrows * (grid.mystuff.page-1));

        let url = "/getactivejobs_dhx?"+urlSearchParams.toString();
        var response = await fetch(url);
        if (!response.ok)
            return dhx8.dhx.message({ expire: 3000, text: "Error loading activejobs grid data"});

        const newData = await response.json();

        newData.map(r=>{//unique grid row id
            r.id = r.job_id + r.split_id;
            return r;
        })

        //restore selection if any
        let selectedCells = grid.selection.getCells();
        selectedCells = JSON.parse(JSON.stringify(selectedCells));
        console.log("selected Cells",selectedCells);


        //redraw grid
        grid.data.removeAll();
        grid.data.add(newData);
        selectedCells.map(c=>{
            console.log("re-selecing",c.row)
            grid.selection.setCell(c.row.id, 0,true,false);
        })
        //if no cells were selected, disable buttons
        selectedCells = grid.selection.getCells();
        if (selectedCells.length == 0)
            toggleJobControl("active",false);
        return;

        // let existing    = grid.data.serialize();
        // let existingIds = existing.map(r=>{return r.id});
        // let newIds      = newData.map(r=>{return r.id});
        // let newRows     = newData.filter(   r=>{return existingIds.indexOf(r.id) == -1});
        // let existingRows = newData.filter(  r=>{return existingIds.indexOf(r.id) != -1});
        // let missing     = existing.filter(  r=>{return newIds.indexOf(r.id) == -1})
        // let missingIds  = missing.map(r=>{return r.id});

        // //insert new
        // grid.data.add(newRows);
        // missingIds.forEach(rid=>{grid.selection.removeCell(rid);}); //unselect
        // //remove missing
        // grid.data.remove(missingIds);
        // //update existing
        // console.log("rows to update:",existingRows)
        // existingRows.map(r=>{
        //     console.log("updating",r,newData.filter(nrow=>{return nrow.id == r.id}));
        //     grid.data.update(r.id, newData.filter(nrow=>{return nrow.id == r.id})[0]);
        // });

        // //sort
        // applySort();
        // function applySort(){
        //     if (grid.sortcol == "state"){
        //         //sort by first by date and state second
        //         let $do_if_gt = grid.sortdir == "asc" ? 1 : -1;
        //         console.log("do_if_gt",$do_if_gt)
        //         console.log("before sort",grid.data.serialize())
        //         console.log("sorting state before",grid.getSortingState())
        //         grid.data.sort({
        //                 rule: (a, b) => {
        //                     let a_state_date = a.state + a.job_start;
        //                     let b_state_date = b.state + b.job_start;
        //                     //first ternary moves a down, second moves it up or keeps current position if dup
        //                     return a_state_date > b_state_date ? $do_if_gt : (a_state_date < b_state_date ? ($do_if_gt*-1) : 0);
        //                 }
        //             }
        //         )


        //         console.log("after sort",grid.data.serialize())
        //         console.log("sorting state after",grid.getSortingState())

        //     }else{
        //         //let the grid sort without help
        //         grid.data.sort({
        //             by: grid.sortcol,
        //             dir: grid.sortdir
        //         })
        //     }


        // }
        //check if we have selected rows



    }
    //attachGridContextMenu()
    // loadGridData();
    return grid;

}//buildActiveGrid


    async function openLogViewer(jobid){
        var url = "/webinterface/components/logviewer.html?job_id=" + jobid;
        const dhxWindow = new dhx8.dhx.Window({
            node: document.body,
            viewportOverflow:true,
            width: window.innerWidth-20,
            height: window.innerHeight-20,
            title: "Job Details",
            modal: false,
            closable: true,
            movable: true,
            resizable:true,
            css:"custom_window_small_borders"
        });
        dhxWindow.header.data.add({ icon: "mdi mdi-fullscreen", id: "fullscreen" }, 2);

        var isFullScreen = false;
        dhxWindow.header.events.on("click", function (id) {
            if (id === "fullscreen") {
                if (isFullScreen) {
                    isFullScreen = false;
                    dhxWindow.unsetFullScreen();
                } else {
                    isFullScreen = true;
                    dhxWindow.setFullScreen();
                }
            }
        });

        let ifrid = Math.random();
        dhxWindow.attachHTML('<iframe height="100%" id="'+ifrid+'"width="100%" style="border:none" src="'+url+'"></iframe>');
        dhxWindow.show();
        await dhx8.dhx.awaitRedraw();
        document.getElementById(ifrid.toString()).onload = function() {
            this.contentWindow.focus();
            var elem = this.contentWindow.m_closefunc = function(){
                    dhxWindow.destructor()
                }
        };


        function resizeWindow(deltaW,deltaH) {
            dhxWindow.setSize(dhxWindow.config.width+deltaW, dhxWindow.config.height+deltaH); // Resize the dhtmlxWindow
        }

        let lastWidth = window.innerWidth;
        let lastHeight = window.innerHeight;
        window.addEventListener("resize", function(){
            // Get the new dimensions
            const newWidth = window.innerWidth;
            const newHeight = window.innerHeight;

            // Calculate the difference (resize delta)
            const widthDelta = newWidth - lastWidth;
            const heightDelta = newHeight - lastHeight;
            resizeWindow(widthDelta,heightDelta);
            // Update the last known dimensions
            lastWidth = newWidth;
            lastHeight = newHeight;
        });
        // var dhxwins = new dhtmlXWindows();
        // var win = dhxwins.createWindow("Job Details", 10, 10,  window.innerWidth-20,window.innerHeight-20);
        // win.setText("Job Details");
        // win.attachURL(url);
        // window.onresize = function(){
        //     win.setDimension(window.innerWidth-20,window.innerHeight-20);
        // }

        // //support closing with escape key from within iframe
        // dhxwins.attachEvent("onContentLoaded", function(win){
        //         //support esc key for close window
        //         console.log("CONTENTLOADED")
		// 		var ifr = win.getFrame();
        //         ifr.contentWindow.focus();
        //         console.log("iframe",ifr.contentWindow)
        //         var elem = ifr.contentWindow.m_closefunc = function(){
        //             win.close()
        //         }
        // });
    }

    function getContextMenuHistoryGrid(allpossible){
        //opens context menu

        var contextmenu = {};
        var _filter = _getObjectByValue(m_userpermissions,"FILTER_JOBSTATUS_BUTTONS");
        if (_filter.length > 0){
            var regex = new RegExp( _filter[0]["value"]["filter"], 'gi' );
            console.log("Displaying filtered list of buttons, regex: ", regex);
            for (var _idx in allpossible){
               if (allpossible[_idx]){
                    if (allpossible[_idx].name.match(regex)){
                        console.log(allpossible[_idx]);
                        var newitem = {};
                        newitem[_idx] = allpossible[_idx];
                        $.extend(contextmenu, newitem);
                        console.log(contextmenu);
                    }
               }
            }
            return contextmenu;
        }else{
            //just render all btns
            console.log("Displaying unfiltered list of menu buttons" );
            contextmenu = allpossible;
            return contextmenu;
        }
    }

    // function getContextMenuHistoryGrid_ex(allpossible){
    //     //opens context menu

    //     var contextmenu = {};
    //     var _filter = _getObjectByValue(m_userpermissions,"FILTER_JOBSTATUS_BUTTONS");
    //     if (_filter.length > 0){
    //         var regex = new RegExp( _filter[0]["value"]["filter"], 'gi' );
    //         console.log("Displaying filtered list of buttons, regex: ", regex);
    //         for (var _idx in allpossible){
    //            if (allpossible[_idx]){
    //                 if (allpossible[_idx].name.match(regex)){
    //                     console.log(allpossible[_idx]);
    //                     var newitem = {};
    //                     newitem[_idx] = allpossible[_idx];
    //                     $.extend(contextmenu, newitem);
    //                     console.log(contextmenu);
    //                 }
    //            }
    //         }
    //         return contextmenu;
    //     }else{
    //         //just render all btns
    //         console.log("Displaying unfiltered list of menu buttons" );
    //         contextmenu = allpossible;
    //         return contextmenu;
    //     }
    // }

    function buildPagination(config,dhxgrid)
    {
        var total = config.total;
        // var tree = $('#treetable_history').fancytree('getTree');
        if (dhxgrid.mystuff.page != 1){
            //skip rebuilding pagination if we show another page than first
            return;
        }
        $('#pagination-container').pagination({
            totalNumber: total,
            pageSize: m_max_history_gridrows,
            showGoInput: true,
            showGoButton: true,
            dataSource: function(done){
                        //this is mandatory but pretty useless, we can store custom data in the pagination object. we just store the row indexes
                        var result = [];
                        for (var i = 1; i < this.totalNumber; i++) {
                            result.push(i);
                        }
                        done(result);
                    },
            callback: function(data, pagination) {
                //click on some page number
                if (pagination.pageNumber != dhxgrid.mystuff.page){
                    //a new  page was selected, reload tree
                    // var start = (pagination.pageNumber-1) * m_max_history_gridrows;
                    // var sourceUrl = "/gethistoryjobsajax_treegrid?sortcol="+tree.mystuff.sortcol+"&direction="+tree.mystuff.sortdir+"&start=" +start+ "&count=" + m_max_history_gridrows+"&filterobj="+encodeURIComponent(JSON.stringify(tree.mystuff.filterobj));

                    // tree.mystuff.page = pagination.pageNumber;
                    // tree.reload({
                    //     url: sourceUrl,
                    //     cache: false
                    // });
                    dhxgrid.mystuff.page = pagination.pageNumber;
                    dhxgrid.loadGridData();

                    if (pagination.pageNumber != 1){
                        document.getElementById("page_number_text").innerHTML = '<span style="color:orange">(Page ' +pagination.pageNumber+ ')</span>'
                        //addMenuButtons()
                    }else{
                        document.getElementById("page_number_text").innerHTML = ''
                        //addMenuButtons()
                    }
                }

                // var html = "<span></span>";
                // $('#data-container').html(html);

            }
        })
    }


    // function addVariableColumns(){

    //     // let htmltemplate = `
    //     //     <th id="history-variable" name="variable" data-sort_dir="">
    //     //         <div style="display:flex;margin-left:10px">
    //     //             <div id="history-variable-sorticon-dis">
    //     //                     <div class="up-arrow up-arrow-dis"></div>
    //     //                     <div class="down-arrow down-arrow-dis"></div>
    //     //             </div>
    //     //             <i id="history-variable-sorticon" name="treetable_history-sorticon"></i>
    //     //             <input placeholder="Variable" style="width:90%;height:18px;margin-left:5px;margin-right:3px" type="search" name="search" incremental autocomplete="off" />
    //     //             <img title="delete filters" style="display:none;width:15px;height:15px;margin-right:3px;margin-left:3px;cursor:pointer" src= "../images/remove-filter-icon-16.jpg"></img>
    //     //         </div>
    //     //     </th>`;

    //     let htmltemplate = `
    //         <th name="col_header_name" data-sort_dir="">
    //             <div style="display:flex;margin-left:10px">
    //                 <input placeholder="col_header_name" data-isvariablecol=true style="width:90%;height:18px;margin-left:5px;margin-right:3px" type="search" name="search" incremental autocomplete="off" />
    //                 <img title="delete filters" style="display:none;width:15px;height:15px;margin-right:3px;margin-left:3px;cursor:pointer" src= "../images/remove-filter-icon-16.jpg"></img>
    //             </div>
    //         </th>`;

    //     const trh = document.getElementById('tr_treetable_history');
    //     if (m_serverconfig.job_viewer && m_serverconfig.job_viewer.variable_columns){
    //         let variablecolumns = m_serverconfig.job_viewer.variable_columns;
    //         for (let i=0;i<variablecolumns.length;i++){
    //             let copy = htmltemplate;
    //             copy = copy.replaceAll("col_header_name",variablecolumns[i].col_header_name);
    //             trh.insertAdjacentHTML('beforeend', copy);
    //         }
    //     }

    // }

    window.getHistoryGridColumns = getHistoryGridColumns; //for options.html
    function getHistoryGridColumns(){

         /**
          * generate searchboxhtml for use in grid header with or without calendar
         */
        function getSearchBoxHtml(config = {}){
            const searchbox_container = document.createElement("div");
            searchbox_container.classList.add("searchbox_container");
            searchbox_container.setAttribute("onclick", "event.stopPropagation()");
            const clockIcon = document.createElement("span");
            clockIcon.classList.add("searchbox-icon-left");
            if (config.datepicker){
                clockIcon.classList.add("mdi", "mdi-clock-time-five-outline", "searchbox_calendar");
                
            }
            searchbox_container.appendChild(clockIcon);

            const searchbox = document.createElement("input");
            searchbox.classList.add("searchbox");
            searchbox.type = "search";
            searchbox.placeholder = "";
            searchbox.setAttribute("onclick", "event.stopPropagation()"); // Add the onclick attribute
            if (config.variablecol)
                searchbox.setAttribute("data-variablecol", true);
            
            //add searchbox
            searchbox_container.appendChild(searchbox);

            //if datepicker, add an element with same width at the end so searchbox does not take too much space
            const spacer = document.createElement("div");
            spacer.classList.add("searchbox-icon-right");
            searchbox_container.appendChild(spacer);
            // let searchboxhtml = `<div class="searchbox_container">
            // <span class="mdi mdi-clock-time-five-outline seachbox_calendar" ></span>
            // <input class="searchbox" type="search" placeholder="" onclick="event.stopPropagation()"></input>
            // </div>`;
            return searchbox_container.outerHTML;
        }

        let c = [
            {
                id: "state",
                maxWidth: 100,
                header: ["<span class='grid_header_text'>State</span>" + getSearchBoxHtml()],
                sortable: true,
                template:function(val,row,column){
                    if (row.children && row.children.length > 1){
                        let jobid = row.job_id
                        let expander = '<div id="'+jobid+'_expander" class="expander dhx_grid-expand-cell-icon dxi dxi-chevron-right"'+
                                            'role="button" aria-label="Collapse group" style="padding: 0px 0px 0px 0px;"></div>'
                        return expander + val;
                    }else{
                        return "<div style='width:20px'></div>" + val
                    }
                    return val;
                },
                htmlEnable:true
            },
            {
                id: "workflow",
                width:300,
                header: ["<span class='grid_header_text'>Workflow</span>"+ getSearchBoxHtml()],   sortable: true,htmlEnable: true,
                template:function(val,row,column){
                    return val
                }

            },
            {id: "job_start",   header: ["<span class='grid_header_text'>Start</span>" + getSearchBoxHtml({datepicker:true})],      sortable: true,htmlEnable: true,  maxWidth: 152},
            {id: "duration",    header: ["<span class='grid_header_text'>Duration</span>"+ getSearchBoxHtml()],   sortable: true,htmlEnable: true,  maxWidth: 80},
            {id: "job_end",     header: ["<span class='grid_header_text'>End</span>"+ getSearchBoxHtml({datepicker:true})],        sortable: true,htmlEnable: true,  maxWidth: 152},
            {id: "source",      header: ["<span class='grid_header_text'>Source</span>"+ getSearchBoxHtml()],     sortable: true,htmlEnable: true,template: function(val,row,column){
                      
                return '<span class="celltext_rtl">' + row.source + '</span>'
                    } },
            {id: "outcome",     header: ["<span class='grid_header_text'>Outcome</span>"+ getSearchBoxHtml()],    sortable: true,htmlEnable: true,
                template: function(val,row,col){
                    if (val.length > 5000)
                        val = val.substring(0, 5000);
                    val=val.replaceAll(/\n|\r/g,"");
                    return val;
            }}
        ]; //gridcolumns

        //add variablecols
        if (m_serverconfig.job_viewer && m_serverconfig.job_viewer.variable_columns){
            //let varcolsearchboxhtml = `<input class="searchbox" type="search" placeholder="" data-variablecol=true onclick="event.stopPropagation()"></input>`;
            let searchboxhtml = getSearchBoxHtml({variablecol:true});
            let variablecolumns = m_serverconfig.job_viewer.variable_columns;
            for (let i=0;i<variablecolumns.length;i++){
                c.push({
                    id: variablecolumns[i].col_header_name,
                    header: ["<span class='grid_header_text'>"+variablecolumns[i].col_header_name+"</span>"+ searchboxhtml],
                    sortable: false,
                    htmlEnable: true
                });
            }
        }
        return c;
    }

/**
 * Returns a layout containing grid and pagiantion
*/
    async function buildHistoryGrid(){
        //show total count div on the right side
        let paginationHtml = `
                <div id="pagination" >
                    <div id="pagination-container" class="dhx_cell_hdr" style="font-weight: normal !important;padding:5px;font-family:Tahoma !important;font-size:12px !important">
                            
                    </div>
                    <div class='pagination_total_count'></div>
                </div>
        `;

        const historyLayout = new dhx8.dhx.Layout(null, {
            type: "line",
            rows: [
                {
                    id: "history_grid_cell",
                },
                {
                    id: "layout_pagination_cell",
                    height:"35px",
                    html: paginationHtml
                },
            ]
        });

        let gridcolumns = getHistoryGridColumns();

        //apply user state
        if (localStorage.jobviewer_history_grid_column_config){
            try{
                //inject merit and hidden state from user config (options.html)
                let userconf = JSON.parse(localStorage.jobviewer_history_grid_column_config);
                gridcolumns = gridcolumns.map(c=>{
                    let uc = userconf.filter(uc=>{return uc.id == c.id});
                    if (uc.length != 1)
                        return c;
                    c.hidden    = uc[0].user_hidden;
                    c.merit     = uc[0].merit;
                    return c;
                });

                gridcolumns.sort((a, b) => a.merit - b.merit);
            }catch(ex){console.error("Cannot restore user column config",ex)}
        }


        console.log("gridcols with userdata",gridcolumns)

        /* build the grid */
        const grid = new dhx8.dhx.Grid("history_div", {
            columns: gridcolumns,
            keyNavigation: true,
            autoWidth:true,
            resizable: true,
            multiselection:true,
            height: "auto",
            rowHeight: 20,
            headerRowHeight: 30,
            selection: "row",
            css: "alternate_row ffastrans_grid_style",
            rowCss: function (row) {
                    if (localStorage.getItem("jobviewer_showrowcolors_history") != "false"){
                        return "css_jobviewer_history_row_status_" + row.state;
                    }
                    return "";

                },
            eventHandlers: {
                oninput:{
                    searchbox: debounce((event,  args) => {
                        //debounce function prevents this to fire multiple times parallel while user is typing
                        //only if user did not type for 500ms, function will fire

                        
                        grid.filterobj = collectFilters(event);
                        console.log("searchbox event:",event,"filter",grid.filterobj)
                        grid.data.removeAll();
                        loadGridData_internal();
                    },750),

                },
                onclick: {
                    /* onclick, dhtmlx will parse the classlist of the clicked stuff and for each class, execute the methods registered here */
                    expander: (event,  {row} ) => expandHistoryGridRow(row),//expander is in classlist of state htmle template
                    searchbox_calendar: (event,args) =>{
                        event.stopPropagation();
                        let headerColName = args.col.id;
                        let searchBox = event.srcElement.parentElement.querySelector(".searchbox");
                        searchboxCalendar(headerColName,searchBox);
                    }
                }
            },
        });

        async function searchboxCalendar(headerColName,searchBox){

            const dhxWindow = new dhx8.dhx.Window({
                width: 400,
                height: 400,
                title: "Date Filter " + headerColName,
                modal: false,
                closable: true,
                movable: true,
                resizable:true
            });

            const form = new dhx8.dhx.Form(null, {
                css: "dhx_widget--bordered",
                padding: 40,
                width: 600,
                rows: [
                    {
                        name: "from",
                        type: "datepicker",
                        label: "From:",
                        labelPosition: "left",
                        labelWidth: 50,
                        width: 250,
                        timePicker: true,
                        dateFormat: "%Y-%m-%d %H:%i:%s",
                        range: true
                    },
                    {
                        name: "to",
                        type: "datepicker",
                        label: "To:",
                        labelPosition: "left",
                        labelWidth: 50,
                        width: 250,
                        timePicker: true,
                        dateFormat: "%Y-%m-%d %H:%i:%s"
                    },
                    {cols: [
                                {type: "button",text: "Apply",id: "save",width:100},
                                {type: "spacer",name: "spacer",width:100},
                                {type: "button",text: "Cancel",id: "cancel",width:100}
                            ],
                            width:"100%",
                            align:"evenly"
                        },


                ]
            });
            await dhx8.dhx.awaitRedraw();
            
            form.getItem("save").events.on("click", function(events) {
                let from    = form.getItem("from").getValue();
                let to      = form.getItem("to").getValue();
                searchBox.value = from + "<:>" + to;
                const event = new Event('input', { bubbles: true, cancelable: true });
                searchBox.dispatchEvent(event);
                dhxWindow.destructor();
            });
            form.getItem("cancel").events.on("click", function(events) {
                dhxWindow.destructor();
            });

            dhxWindow.attach(form);
            dhxWindow.show();
        }

        m_historyGrid = grid;
        //custom fields keep track of current state
        grid.filterobj      = {};
        grid.sortcol        = "job_end";
        grid.sortdir        = "desc";
        grid.mystuff        = {page:1}
        grid.loadGridData   = loadGridData;


        function expandHistoryGridRow(row){
            if (row.expanded) {
                grid.data.update(row.id, { expanded: false });
                document.getElementById(row.job_id + "_expander").classList.replace('dxi-chevron-down', 'dxi-chevron-right');
                let to_remove = [];
                grid.data.forEach(function(item, index, array) {
                    if (item.parentid == row.id)
                        to_remove.push(item.id);
                });

                grid.data.remove(to_remove);

            } else {
                grid.data.update(row.id, { expanded: true });
                document.getElementById(row.job_id + "_expander").classList.replace('dxi-chevron-right', 'dxi-chevron-down');
                expandgridrow();
                function expandgridrow(rid){
                    //add the child rows into grid after
                    const index = grid.data.getIndex(row.id);
                    const naturalCollator = new Intl.Collator(undefined, {numeric: true, sensitivity: 'base'});
                    //row.children.sort(grid.)
                    try{
                        if (grid.sortcol && grid.sortcol != ""){
                            if (grid.sortdir == "asc"){
                                row.children.sort((a, b) => naturalCollator.compare(a[grid.sortcol], b[grid.sortcol]));
                            }else{
                                row.children.sort((a, b) => naturalCollator.compare(b[grid.sortcol], a[grid.sortcol]));
                            }

                        }
                    }catch(ex){}

                    grid.data.add(row.children.map(c=>{//each branch row
                            c.id = c._id;
                            c.parentid = row.id,
                            c.state="<p style='text-indent:30px'>" + c.state;
                            c.source="<p style='text-indent:30px'>" + c.source;
                            c.outcome="<p style='text-indent:30px'>" + c.outcome;
                            return c
                        }),index+1);
                }
            }
        }
        //restore grid widths if any
        // if (localStorage.jobviewer_historygrid_widths){
        //     try{
        //         let conf = JSON.parse(localStorage.jobviewer_historygrid_widths);
        //         let order = "";
        //         let wSum = 0;
        //         let colcount = 0;
        //         grid.config.columns.map(c=>{
        //             order += c.id;
        //             wSum += c.$width;
        //             colcount++;
        //         });
        //         if (order != conf.order){ //out of order
        //             delete localStorage.jobviewer_historygrid_widths;
        //         }else{//apply col widths
        //             let idx = 0;
        //             let newGridCols = getHistoryGridColumns();
        //             grid.config.columns.map(c=>{
        //                 let targetc = newGridCols.filter(tc=>{return tc.id == c.id});
        //                 // if (idx+2 > colcount){
        //                 //     targetc[0].autoWidth = true;
        //                 //     return;
        //                 // }
        //                 targetc[0].width = (wSum/100 * conf.percent[idx]);

        //                 console.log("Restore ",c.id,(wSum/100 * conf.percent[idx]))

        //                 idx++;


        //             });
        //             grid.setColumns( newGridCols);
        //         }
        //     }catch(ex){
        //         delete localStorage.jobviewer_historygrid_widths;
        //     }
        // }

        // //resize columns
        // grid.events.on("resize", (column, event) => {
        //     let allColWidths = {order:"",percent:[]}
        //     let sum_widths = 0;
        //     grid.config.columns.map(c=>{
        //         sum_widths += c.$width;
        //         allColWidths.order += c.id;
        //     })
        //     grid.config.columns.map(c=>{
        //         allColWidths.percent.push(100/sum_widths * c.$width);
        //         console.log("Store ",c.id,(100/sum_widths * c.$width))
        //     });
        //     localStorage.setItem("jobviewer_historygrid_widths",JSON.stringify(allColWidths));
        // });

        /* Row select */
        grid.selection.events.on("AfterSelect", (row, column) => {
            toggleJobControl("history",true);
        });

        /* Sorting */
        grid.events.on("beforeSort", (column, dir) => {
            /* remove all rows and reload sorted data from server */
            grid.sortcol =  column.id;
            grid.sortdir =  dir;
            grid.data.removeAll();
            loadGridData_internal();
            return true;
        });

        /* Searching */
        function collectFilters(inputEvent){ //collects all search values

            if (inputEvent.srcElement){
                //clears tree search if needed
                let currentSearchedId = inputEvent.srcElement.closest('.dhx_grid-header-cell').dataset.dhxId;
                if (currentSearchedId == "workflow" && inputEvent.srcElement.value == ""){
                    //wf search was cleared, reset tree filter if any
                    clear_workflow_tree_selection();
                }
            }
            //iterate all searchbox
            let filterobj = {};
            filterobj.variablecols = [];
            const searchboxes = document.querySelectorAll('.searchbox');
            searchboxes.forEach((searchbox) => {
                let header_id = searchbox.closest('.dhx_grid-header-cell').dataset.dhxId;
                let cont = searchbox.closest('.searchbox_container');
                if (searchbox.value == ""){
                    cont.classList.remove("active");
                    return;
                }

                cont.classList.add("active");


                if (searchbox.dataset.variablecol){
                    filterobj.variablecols.push({col_header_name:header_id,filter:searchbox.value});
                }else
                    filterobj[header_id] = searchbox.value;

            })
            return filterobj;
        }

        /* Data loading */
        grid.throttleflag = {throttle:null};
        async function loadGridData(){
            throttle(loadGridData_internal , 3000, grid.throttleflag,"history")();
        }

        async function loadGridData_internal(){
            let urlSearchParams =  new URLSearchParams({});
            urlSearchParams.append("count", m_max_history_gridrows);
            urlSearchParams.append("filterobj", JSON.stringify(grid.filterobj));
            urlSearchParams.append("sortcol", grid.sortcol);
            urlSearchParams.append("direction", grid.sortdir);
            urlSearchParams.append("start", grid.mystuff.page == 1 ? 0 : m_max_history_gridrows * (grid.mystuff.page-1));

            let url = "/gethistoryjobs_dhx?"+urlSearchParams.toString();
            var response = await fetch(url);
            if (!response.ok)
                return dhx8.dhx.message({ expire: 3000, text: "Error loading historygrid data"});
            const json = await response.json();
            console.log("Data for history grid",json)
            json.data.map(r=>{
                r.id = r._id;
            })

            //remember selection
            let selectedCells = grid.selection.getCells();
            selectedCells = JSON.parse(JSON.stringify(selectedCells));
            //remember expanded rows
            let expandedRows = [];
            grid.data.serialize().map(r=>{
                if (r.expanded)
                    expandedRows.push(r.id);
            })

            //load the new grid data
            grid.data.parse(json.data);
            await dhx8.dhx.awaitRedraw();

            //scroll to first selected
            if (selectedCells.length != 0){
                grid.scrollTo(selectedCells[0].row.id,"state");
            }

            //restore expansion
            expandedRows.map(rid=>{
                const exrow = grid.data.getItem(rid);
                if (exrow){
                    console.log("expanded row exists:",rid,grid.data.exists(rid))
                    expandHistoryGridRow(exrow);
                }
            })
            await dhx8.dhx.awaitRedraw();
            //restore selection
            selectedCells.map(c=>{
                console.log("re-selecing",c.row)
                grid.selection.setCell(c.row.id, 0,true,false);
            });
            await dhx8.dhx.awaitRedraw();

            //if no cells selected, disable buttons
            selectedCells = grid.selection.getCells();
            if (selectedCells.length == 0)
                toggleJobControl("history",false);

            //build pagination, todo, should we do this non blocking?
            urlSearchParams.append("getcount", 1);
            let counturl = "/gethistoryjobs_dhx?"+urlSearchParams.toString();
            var countresponse = await fetch(counturl);
            if (!countresponse.ok)
                return dhx8.dhx.message({ expire: 3000, text: "Error counting grid data"});

            const countjson = await countresponse.json();
            console.log("history count response",countjson);
            buildPagination({total:countjson.total_count},grid);
            document.querySelector(".pagination_total_count").innerHTML = "All: " + countjson.total_count;

        }

        attachGridContextMenu()
        // loadGridData();
        historyLayout.getCell("history_grid_cell").attach(grid);
        return historyLayout;

    }//buildHistoryGrid

    function attachGridContextMenu(){

        const contextMenu = new dhx8.dhx.ContextMenu(null, { css: 'grid-context-menu' });
        let menuitems = [
            {
                type: 'menuItem',id: 'details',value: 'Job Details'
            },
            {
                type: 'menuItem',id: 'resubmit',value: 'Resubmit'
            },
			{
                type: 'menuItem',id: 'delete',value: 'Delete'
            }
        ]

        var _filter = _getObjectByValue(m_userpermissions,"FILTER_JOBSTATUS_BUTTONS");
        if (_filter.length > 0){
            //filters user permissions, todo: support multiple FILTER_JOBSTATUS_BUTTONS?
            var regex = new RegExp( _filter[0]["value"]["filter"], 'gi' );
            console.log("Displaying filtered list of buttons, regex: ", regex);
            menuitems = menuitems.filter(itm=>{
                if (itm.value.match(regex))
                    return itm;
            })
        }

        contextMenu.data.parse(menuitems);
        /* context events */
        contextMenu.events.on("click", function(menu_id,e){
            history_grid_actions(menu_id);
        });

        m_historyGrid.events.on('CellRightClick', function (row, column, e) {
            m_historyGrid.selection.setCell(row.id, column);
            dhx8.dhx.awaitRedraw().then(function () {
                contextMenu.showAt(e);
            });
            event.preventDefault();
            return false;
        });
    }

    function saveLayoutSizes(dhxLayout, name) {
        //store layout cells height and with into html5 storage (in percentage of document height)
        var aw = (dhxLayout.cells("b").getWidth() / document.body.scrollWidth);
        var ah = (dhxLayout.cells("b").getHeight() / document.body.scrollHeight);
        var bw = (dhxLayout.cells("c").getWidth() / document.body.scrollWidth);
        var bh = (dhxLayout.cells("c").getHeight() / document.body.scrollHeight);
        var cw = (dhxLayout.cells("a").getWidth() / document.body.scrollWidth);
        var ch = (dhxLayout.cells("a").getHeight() / document.body.scrollHeight);
        localStorage.setItem(name + "_aw", aw);
        localStorage.setItem(name + "_ah", ah);
        localStorage.setItem(name + "_bw", bw);
        localStorage.setItem(name + "_bh", bh);
        if (!dhxLayout.cells("a").isCollapsed()){
            localStorage.setItem(name + "_cw", cw);
            localStorage.setItem(name + "_ch", ch);
        }
        localStorage.setItem(name + "_c_collapsed", dhxLayout.cells("a").isCollapsed());
    }

    function restoreLayoutSizes(dhxLayout, name) {
        if (localStorage.getItem(name + "_aw")) {
            if (localStorage.getItem(name + "_c_collapsed") == "false"  && !m_serverconfig["alternate-server"]){
                dhxLayout.cells("a").expand();
            }
            var aw = localStorage.getItem(name + "_aw");
            var ah = localStorage.getItem(name + "_ah");
            var bw = localStorage.getItem(name + "_bw");
            var bh = localStorage.getItem(name + "_bh");
            var cw = localStorage.getItem(name + "_cw");
            var ch = localStorage.getItem(name + "_ch");
            dhxLayout.cells("b").setWidth(aw * document.body.scrollWidth);
            dhxLayout.cells("b").setHeight(ah * document.body.scrollHeight);
            dhxLayout.cells("c").setWidth(bw * document.body.scrollWidth);
            dhxLayout.cells("c").setHeight(bh * document.body.scrollHeight);

            if (dhxLayout.cells("a").isCollapsed() == false){
                console.log("CW",cw)
                dhxLayout.cells("a").setWidth(cw * document.body.scrollWidth);
                dhxLayout.cells("a").setHeight(ch * document.body.scrollHeight);
            }

        }

    }

    function resubmit_job(job_id) {
        //get all workflows from server and start main with the workflow of interest
        job_id = job_id.split("~")[0];
        var _url = "/getjobdetails?jobid=" + job_id;
        $.ajax({
            url: build_new_api_url(_url),
            type: "GET",
            crossDomain: true,
            success: function(response) {

                if (response['wf_object'].length == 0) {
                    alert("Did not get any workflow in job from FFASTRANS API");
                } else {
					console.log("res: ",response)
                    var postBody = {};
                    postBody.start_proc = response["nodes"]["start"]["id"];
                    postBody.wf_id = response["workflow"]["id"];
                    postBody.inputfile = response["sources"]["localized_file"];
                    postBody.variables = response["variables"];
                    postBody.system = "FFAStrans Web Interface";

					console.log("submitting wf: ",postBody)
                    $.ajax({
                        url: build_new_api_url("/jobs"),//buildUrl(m_serverconfig['STATIC_START_JOB_URL']),
                        type: "POST",
                        crossDomain: true,
                        contentType: "application/json",
                        data: JSON.stringify(postBody),
                        success: function(response) {
                            dhtmlx.message("Sucess")
                        },
                        error: function(xhr, status) {
                            console.log(xhr.responseText)
                            dhtmlx.alert("Error submitting workflow: " + xhr.responseText);
                        }
                    });
                }
            },
            error: function(xhr, status) {
                alert("ERROR getting workflow of job " + job_id + ", please check FFAStrans Path in Admin settings on the left.. ");
            }
        });
    }

    function jobCommand(dhx_grid_rows, action, value) {
        //only available in ffastrans 9.4>//TODO: wait for the new version call, then do version detection
        console.log("jobcommand", dhx_grid_rows,action,value)
        console.log(m_serverconfig)
        dhx_grid_rows.forEach(function(node) {

            var postBody = {
                "action": action,
                "job_id"   : node.row.job_id,
                "split_id": node.row.split_id
            };
            var jobid = "";

            if (value){
                postBody["value"] = value;
            }
            $.ajax({
                url: build_new_api_url("/jobs"),//("/proxy" + m_serverconfig['STATIC_START_JOB_URL']) + node.data.job_id,
                type: "PUT",
                context: this,
                contentType: "application/json",
                data: JSON.stringify(postBody),
                success: function(response) {
                    console.log("success")
                    dhtmlx.message("Success " + action + " " + node.row.job_id);
                },
                error: function(xhr, status) {
                    console.error(xhr)
                    dhtmlx.message("ERROR aborting job, contact developer. Status:" + status);
                }
            });
        })

    }

    /* HELPERS */

    function pad(n, z) { //add leading zero if there is none
        z = z || '0';
        n = n + '';
        return n.length >= 2 ? n : new Array(2 - n.length + 1).join(z) + n;
    }

    function build_new_api_url(what) {
        if (JSON.parse(m_serverconfig['STATIC_USE_PROXY_URL'])) {
            return "/new_proxy" + what;
        } else {
            var protocol = m_serverconfig.STATIC_WEBSERVER_ENABLE_HTTPS == "true" ? "https://" : "http://";
            var _url = protocol + m_serverconfig['STATIC_API_HOST'] + ":" + m_serverconfig['STATIC_API_NEW_PORT'] + what;
            return _url;
        }
    }

    function parse_query_string(query) {
      var vars = query.split("&");
      var query_string = {};
      for (var i = 0; i < vars.length; i++) {
        var pair = vars[i].split("=");
        var key = decodeURIComponent(pair[0]);
        var value = decodeURIComponent(pair[1]);
        // If first entry with this name
        if (typeof query_string[key] === "undefined") {
          query_string[key] = decodeURIComponent(value);
          // If second entry with this name
        } else if (typeof query_string[key] === "string") {
          var arr = [query_string[key], decodeURIComponent(value)];
          query_string[key] = arr;
          // If third or later entry with this name
        } else {
          query_string[key].push(decodeURIComponent(value));
        }
      }
      return query_string;
    }

    function decodeEntities(encodedString) {
        var translate_re = /&(nbsp|amp|quot|lt|gt);/g;
        var translate = {
            "nbsp":" ",
            "amp" : "&",
            "quot": "\"",
            "lt"  : "<",
            "gt"  : ">"
        };
        return encodedString.replace(translate_re, function(match, entity) {
            return translate[entity];
        }).replace(/&#(\d+);/gi, function(match, numStr) {
            var num = parseInt(numStr, 10);
            return String.fromCharCode(num);
        });
    }

    function clear_workflow_tree_selection(what){
        try{
            var tree = $("#workflowtree").fancytree('getTree');
            tree.selectAll(false);
        }catch(ex){}
    }

    function debounce(func,timeout){
            //used to prevent kicking off search too often while user types, e.g. wait 100ms for no change and only then execute the function
            var timer;
            return function(event){
                if(timer) clearTimeout(timer);
                timer = setTimeout(func,timeout,event);
            };
    };

    /**
     * Ensures that the "mainFunction" is at maximum executed in delay frequency (e.g if 50 jobs finish in the same second, we would load 50 times activejob)
    */
    function throttle(mainFunction, delay,throttleFlag,label) {
        console.log("THROTTLE CALLED")
        return (...args) => {
            if (throttleFlag.throttle === null) { // If there is no timer currently running
            mainFunction(...args); // Execute the main function
            throttleFlag.throttle = setTimeout(() => { // Set a timer to clear the timerFlag after the specified delay
                throttleFlag.throttle = null; // Clear the timerFlag to allow the main function to be executed again
            }, delay);
            }
        };
    }

</script>

<body onload="loadserverconfig()">

    <div style="display:none">
        <!-- global hiding div prevents showing raw tables before dhtmlx layout attaches the template divs -->
        <!-- THIS DIV CONTAINS THE FINISHED JOBGRID FANCYTREE TEMPLATE -->


        <!-- height calc solution was the only way i found to have pagination and history div in same grid layout cell, todo: move on to dhx8 layout and put the 2 in separate layout cells -->



         <!-- WORKFLOW FILTER TEMPLATE -->



    </div><!-- global hiding div -->

    <!-- html code to be loaded by javascript into dhtmlx cells. This is not directly shown on the page but loaded as a template on demand -->
    <div style="display:none" id="dhtmlx attachObject Templates">

    </div>
</body>
