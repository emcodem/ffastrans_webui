<html>
<head>
<link rel="stylesheet" href="/alternate-server/css/override.css"/>

<script src="/socket.io/socket.io.js"></script>
<script src="../dependencies/dhtmlx/dhtmlx.js"></script>

<script src="../dependencies/jquery/jquery.js"></script>
<link rel="icon" href="favicon.ico?v=1.1">
<link rel="stylesheet" href="../dependencies/fontawesome/css/all.css" />
<link href="../dependencies/MaterialDesign-Webfont-7.2.96/css/materialdesignicons.min.css" media="all" rel="stylesheet" type="text/css" />

<!-- <link href="../dependencies/fancytree/modules/jquery.resizableColumns.css" rel="stylesheet"> -->
<!-- <script src="../dependencies/fancytree/modules/jquery.resizableColumns.js"></script> -->

<link rel="stylesheet" href="../dependencies/fancytree/skin-lion/ui.fancytree.min.css"/>
<script src="../dependencies/fancytree/modules/colResizable-1.6.min.js"></script>
<script src="../dependencies/fancytree/modules/jquery.fancytree.ui-deps.js"></script>
<script src="../dependencies/fancytree/modules/jquery.fancytree.js" type="text/javascript"></script>
<script src="../dependencies/fancytree/modules/jquery.fancytree.dnd.js" type="text/javascript"></script>
<script src="../dependencies/fancytree/modules/jquery.fancytree.filter.js" type="text/javascript"></script>
<script src="../dependencies/fancytree/modules/jquery.fancytree.edit.js" type="text/javascript"></script>
<script src="../dependencies/fancytree/modules/jquery.fancytree.gridnav.js" type="text/javascript"></script>
<script src="../dependencies/fancytree/modules/jquery.fancytree.table.js" type="text/javascript"></script>
<script src="../dependencies/fancytree/modules/jquery.fancytree.multi.js"></script>
<script src="../dependencies/fancytree/modules/jquery.fancytree.persist.js"></script>
<script src="../dependencies/fancytree/modules/jquery.fancytree.fixed.js"></script>
<script src="../dependencies/fancytree/modules/jquery.fancytree.contextmenu.js"></script>

<!-- pagination -->
<script src="../dependencies/pagination/pagination.min.js"></script>
<link rel="stylesheet" href="../dependencies/pagination/pagination.css" type="text/css"> 

<!-- jquery-contextmenu (https://github.com/swisnl/jQuery-contextMenu) -->
<link rel="stylesheet"
      href="../dependencies/fancytree/modules/jQuery-contextMenue/jquery.contextMenu.min.css" />
<script src="../dependencies/fancytree/modules/jQuery-contextMenue/jquery.contextMenu.min.js">
</script>

<script src="common/buildWorkflowTree.js"></script> <!-- function parseWorkflows -->

<link rel="stylesheet" href="../dependencies/dhtmlx/8.4.5/suite.min.css" type="text/css"/> 
<script src="../dependencies/dhtmlx/8.4.5/suite.umd.js"></script>
<link rel="stylesheet" href="../dependencies/dhtmlx/dhtmlx.css" id="theme_loader" type="text/css">
<script>
    //theme changeer
    if (localStorage.global_skin_dark == "1"){
        try{
            document.querySelector("#theme_loader").href = document.querySelector("#theme_loader").href.replace("dhtmlx.css","dhtmlx_benjamin.css")
        }catch(ex){}
        try{
            dhx.setTheme("dark");
        }catch(ex){}
        try{
            dhx8.dhx.setTheme("dark");
        }catch(ex){}
    }
</script>

<style>
    /* it's important to set width/height to 100% for full-screen init */
    html, body {
        /* width: 100%; */
        height: 100%;
        margin: 0px;
        overflow: hidden;
        color: #333;
        font: 12px Tahoma;
        line-height: 18px;
        
    }

    .fas {
        opacity: 0.9;                /* Opacity (Transparency) */
        color: rgba(0, 0, 0, 0.9);   /* RGBA Color (Alternative Transparency) */
        
    }

    button {
        cursor: pointer;
        font-size: 12px;
    }

    .progressbar {
        margin: 0;
        margin-left:5px;
        margin-right:5px;
        height: 15px;
        background-color: #4caf5080;
        padding: 0;
        text-align: center;
        vertical-align: middle;
        white-space: nowrap;
    }

    /*layout headers (big blue lines)*/
    .dhxlayout_base_material div.dhx_cell_layout div.dhx_cell_hdr {
        height: 25px;
        line-height: 23px;
        font-size: 12px;
    }

    /*collapse icon in layout header*/
    .dhxlayout_base_material div.dhx_cell_layout div.dhx_cell_hdr div.dhxlayout_arrow.dhxlayout_arrow_ha {
        background-position: -32px -5px;
        z-index: 1;
        margin-top: -3;
    }
    /*collapse icon in layout header*/
    div.dhx_cell_layout div.dhx_cell_hdr div.dhxlayout_arrow.dhxlayout_arrow_vb {
        margin-top: -8px;
        z-index: 1;
    }

    /*fancytree line break*/
    table.fancytree-ext-table tbody tr td {
        /*white-space: nowrap;*/
        text-overflow: ellipsis;
        overflow: hidden;
        white-space: nowrap;
    }

    /* tree column resize issues*/
    table {
        border: 1px;
        table-layout: fixed;
        width: 100%;
        outline: none;
    }
    /* tree column resize issues*/
    th,
    td {
        border: 1px;
        overflow: hidden;
        font-weight: unset;
        
    }
    th{
        border-right: 1px solid grey;
    }
    /* text in tree title column */
    span.fancytree-title {
        padding: 0 0 0;
    }
    /*three dots on text overflow*/
    .celltext {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        user-select: text;
        margin-left: 6px;
		margin-right: 6px;
    }
	.celltext_rtl {
		direction:rtl;
		text-align:left;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        user-select: text;
        margin-left: 6px;
		margin-right: 6px;
    }

    .celltext_clicked {
        text-overflow: clip;
        white-space: normal;
        word-break: break-all;
        user-select: text;
    }
   
    /*context menu stuff*/
    td:hover {
        opacity:0.5;
    }
    .context-menu-active {
        opacity:0.5;
    }
	
	/*keeps sort icon on top*/
	i[id^='history-']{
		
		margin-top:3px;
	}
	/*keeps sort icon on top*/
	i[id^='active-']{
		
		margin-top:3px;
	}
	
    .history_div{
        /* display:grid; */
        /* height:100%; */
        /* grid:'table_container' minmax(0,1fr); */
    }

    ul.fancytree-container {
        font-size:12px !important;
    }
    
    div.gridbox table.obj td { /* prevent success column to line break when small*/
        white-space: nowrap !important;
    }
    table.fancytree-ext-table tbody tr.fancytree-focused{
        background-color: unset; /* override default bg color #4169e1 of fancytree */
    }
    
    table.fancytree-ext-table tbody tr.fancytree-active {
        background-color: unset;  /* override default bg color #4169e1 of fancytree */;
    }

    /* NEW STUFF */
    /* searchbox is invisible unless hovered or has text */
    .searchbox {
            opacity: 0;
            position:absolute;
            right: 25;
            left: 10;
            /* pointer-events: none; */
            transition: opacity 0.3s ease;
    }
    .searchbox:hover,.searchbox:focus {
            opacity: 1;
            pointer-events: auto;
    }
    
    .searchbox:not(:placeholder-shown) {
            opacity: 1;/* Keep the textbox visible if it has content */
    }

    .ffastrans_grid_style{
        --dhx-font-family:"Tahoma";
        --dhx-font-size-normal:12px
    }
    
</style>


<style id="row_status_colors" type="text/css" id="customstyle">


</style>


<script>
    /* init SOCKET.IO */
    var socket = io();

    /* GLOBALS */
    var mainLayout, runningJobGrid, m_serverconfig, m_userpermissions, m_lastsortelementid, m_lastsortdir;
    let m_historyGrid;
    var m_rowColorError = "#f28d80"
    var m_rowColorCancelled = "#ffcc80"
	var m_max_history_gridrows = localStorage.getItem("jobviewer_rows_per_page") || 100;
    var m_query = {}; //url parameters

    /* global function override */
    dhtmlx.message= function(what){
        dhx8.dhx.message({ expire: 3000, text: what});
    }

    /*load config from server*/
    function loadserverconfig() {
        $.ajax({
            url: ("/getuserpermissionsasync" + "?" + Math.random()),
            type: "GET",
            success: function(response) {

                m_userpermissions = JSON.parse(response);
                //load serverconfig and initialize page
                $.ajax({
                    url: ("/getserverconfig" + "?" + Math.random()),
                    type: "GET",
                    success: function(response) {
                        m_serverconfig = JSON.parse(response);
                        init();
                    },
                    error: function(xhr, status) {
                        dhtmlx.message("Fatal error, could not load serverconfig. ");
                        document.body.innerHTML = "Fatal error, could not load serverconfig. " + xhr.responseText;
                    }
                });
            },
            error: function(xhr, status) {
                dhtmlx.message("Fatal error, could not load serverconfig. ");
                document.body.innerHTML = "Fatal error, could not load serverconfig. " + xhr.responseText;
            }

        });

    }

    function toggleJobControl(id,selected_is_on){
        //enable/disable menu buttons
        console.log("ToggleJobControl");

        var element_names = [];
        if (id.match("active")){
            element_names = ["a_details","a_abort","a_pause","a_resume"];
        }
        if (id.match("history")){
            element_names = ["b_details","b_resubmit","b_delete_selected"];
        }

        element_names.forEach(function(name){
            try{
                document.getElementsByName(name)[0].disabled = !selected_is_on;
                var icon = document.getElementsByName(name)[0].getElementsByTagName("i")[0];  
                if (selected_is_on){
                    icon.classList.remove("disabled")
                }else{
                    icon.classList.add("disabled")
                }
            }catch(ex){
                //who
            }
        })
        
    }
    
    /* render menu buttons based on permissions*/
    function addMenuButtons(){
        
        //menu buttons html
        //do not forget to add the button name to togglejobcontrol if you add more btns 
        var a_details = '<button class="btn jobviewer_menu" name="a_details" disabled="true" onclick="click_a_header(this.name)"><i style = "margin-right:3px" class= "fas fa-info-circle fa-sm disabled" ></i>Job Details</button> ';
        var a_abort =   '<button class="btn jobviewer_menu" name="a_abort" disabled="true"  onclick="click_a_header(this.name)"><i style = "margin-right:3px;" class= "fas fa-stop fa-sm disabled" ></i>Abort</button> ';
        var a_pause =   '<button class="btn jobviewer_menu" name="a_pause" disabled="true"  onclick="click_a_header(this.name)"><i style = "margin-right:3px" class= "fas fa-pause fa-sm disabled" ></i>Pause</button> ';
        var a_resume =  '<button class="btn jobviewer_menu" name="a_resume" disabled="true"  onclick="click_a_header(this.name)"><i style = "margin-right:3px" class= "fas fa-play fa-sm disabled" ></i>Resume</button>   ';
        // var a_prio  =  '<button class="btn jobviewer_menu" name="a_priority" disabled="true"  onclick="click_a_header(this.name)"><i style = "margin-right:3px" class= "fas fa-clock fa-sm disabled" ></i>Priority</button>   ';
        var a_opts  =    '<button class="btn jobviewer_menu" name="b_options" onclick="history_grid_actions(this.name)" style="float: right;margin-top:4px"><i style = "margin-right:3px;" class= "fas fa-cog fa-sm" ></i>Options</button> ';
        
        var arr_all_in_a = [a_details,a_abort,a_pause,a_resume,a_opts];
        
        var b_details =     '<button class="btn jobviewer_menu" name="b_details" disabled="true"  onclick="history_grid_actions(this.name)"><i style = "margin-right:3px" class= "fas fa-info-circle fa-sm disabled"></i>Job Details</button> ';
        var b_resubmit =    '<button class="btn jobviewer_menu" name="b_resubmit" disabled="true"  onclick="history_grid_actions(this.name)"><i style = "margin-right:3px" class= "fas fa-retweet fa-sm disabled"  ></i>Resubmit</button> ';
        var b_delete_selected =      '<button class="btn jobviewer_menu" name="b_delete_selected" disabled="true" onclick="history_grid_actions(this.name)"><i style = "margin-right:3px" class= "fas fa-trash-alt fa-sm disabled" ></i>Delete Selected</button> ';
        var arr_all_in_b = [b_details,b_resubmit,b_delete_selected];
        
        //check user permissions
        var _filter = _getObjectByValue(m_userpermissions,"FILTER_JOBSTATUS_BUTTONS");
        if (_filter.length > 0){
            
            var regex = new RegExp( _filter[0]["value"]["filter"], 'i' );
            console.log("Displaying filtered list of buttons, regex: ", regex);
            
            //add filtered btns to Running jobgrid
            for (let _id=0;_id<arr_all_in_a.length;_id++){
                var input_name = arr_all_in_a[_id].match(/name="(.*?)"/)[1];
                if (regex.test(input_name)){
                    _appendtext('b',arr_all_in_a[_id])
                }
            }
            //no filter, add filtered btns to History jobgrid
            for (let _id=0;_id<arr_all_in_b.length;_id++){
                var input_name = arr_all_in_b[_id].match(/name="(.*?)"/)[1];
                if (regex.test(input_name)){
                    _appendtext('c',arr_all_in_b[_id])
                }
            }
        }else{
            //just render all btns
            console.log("Displaying unfiltered list of menu buttons" )
            _appendtext('b',arr_all_in_a.join("") );
            _appendtext('c', b_details + b_resubmit + b_delete_selected);
        }
        function _appendtext (cellid, to_append){//helper
            //appends text to mainLayout.cells("b") and mainLayout.cells("c")
            mainLayout.cells(cellid).setText(mainLayout.cells(cellid).getText() + to_append);
        }
    }

    function _getObjectByValue(object, value) {//helper
        var to_return = [];
        for (var _idx in object){
           var _v =  object[_idx]["key"];
           if (_v == value){
            to_return.push(object[_idx]);
           }
        }
        return to_return;
    }
    
    function applyFilter(filtername,filtervalue){
        /* inserts filter into grid header and hits enter */
        const searchboxes = document.querySelectorAll('.searchbox');
        searchboxes.forEach((searchbox) => {
            let header_id = searchbox.closest('.dhx_grid-header-cell').dataset.dhxId;
            if (header_id.toUpperCase().match(filtername.toUpperCase())){
                searchbox.value = filtervalue;
                
                $(searchbox).trigger("input");
            }
        })
        // for (let i = 0; i < $("input[name=search]").length; i++) {
        //     var input = $("input[name=search]")[i];     
        //     var keyname = input.placeholder.toLowerCase();
        //     if(keyname.match(filtername.toLowerCase())){
        //         console.log("Applying filter from URL: " + filtername)
        //         input.value = filtervalue;
        //          var e = $.Event( "keyup", { keyCode: 13 } );
        //          $(input).trigger(e);
        //     }
        //  }  
    }

    /* build basic page layout and init periodic job loading*/
    function init() {
        
        //search params from URL go to their corresponding search inputs
        var query = window.location.search.substring(1);
        query = parse_query_string(query);
        m_query = query;
        console.log("Querystring",query)
        //insert filter from url into search text fields
        for (var filtername in query) {
            if (query.hasOwnProperty(filtername) && filtername != "") {
                console.log(filtername + " -> " + query[filtername]);
                applyFilter(filtername, query[filtername])
            }
        }

        //check if html5 features supported
        if (typeof(Storage) !== "undefined") {} else {
            dhtmlx.message("ERROR, no html5 store support, cannot save view state")
        }

        mainLayout = new dhtmlXLayoutObject({
            parent: document.body,
            pattern: "3L",
            cells: [
					{id: "a", text: "Workflow Filter", collapsed_text: "<span id='workflow_filter_header_collaped' style='display:flex;cursor:pointer'><b>Workflows</b></span>"},
					{id: "b", text: ""},
					{id: "c", text: ""}
				]
        });

        mainLayout.cells("a").showInnerScroll()
        mainLayout.cells("a").setMinWidth(150);
        mainLayout.cells("a").setWidth(350);
        mainLayout.cells("a").collapse(); 
		
		if (m_serverconfig["alternate-server"] != true && m_serverconfig["alternate-server"] != "true"){
			buildWorfklowTree(); //load workflows
			mainLayout.cells("a").setText('<span id="workflow_filter_header_expanded" style="margin-right:15px;font-size:13px;display:flex" >Workflows</span>');
		
		}else{
			console.log("alternate server is true!")
			mainLayout.cells("a").setCollapsedText("");
			mainLayout.cells("a").hideArrow();
            mainLayout.cells("a").collapse();
		}
        mainLayout.cells("b").setText('<span style="margin-right:15px;font-size:13px;color:#888888" >Running</span>');
        mainLayout.cells("c").setText('<span id="span_text_finished" style="margin-right:15px;font-size:13px;color:#888888" >Finished</span>');

        
        //attach mouseclick event to exand workflow cell on click onto whole bar instead of < icon only
        $('#workflow_filter_header_collaped').click(()=>{
            mainLayout.cells("a").expand()
            restoreLayoutSizes(mainLayout, "mainLayout");
        });
        mainLayout.attachEvent("onCollapse", function(name){
                $('#workflow_filter_header_collaped').click(()=>{
                    mainLayout.cells("a").expand()
                    restoreLayoutSizes(mainLayout, "mainLayout");
                });
                localStorage.setItem("mainLayout_c_collapsed", "true");
                console.log("saving collapsed state")
        });
        mainLayout.attachEvent("onExpand", function(name){
                localStorage.setItem("mainLayout_c_collapsed", "false");
        });
        
        mainLayout.cells("c").setWidth($(document).width() / 3);
        //mainLayout.cells("c").setText("Finished");
        mainLayout.cells("b").setHeight($(document).height() / 3.5);
        restoreLayoutSizes(mainLayout, "mainLayout");

        //attach grids
        mainLayout.cells("c").attachObject("history_div_container");
        mainLayout.cells("c").showInnerScroll();
        mainLayout.cells("b").attachObject("active_div");
        mainLayout.cells("b").showInnerScroll();
        
        
        //url parameter hideheaders
        if (query["hideheaders"]){
            mainLayout.cells("b"). hideHeader();
            mainLayout.cells("c"). hideHeader();
        }

        //ur param hideactive
        if (query["hideactive"]){
            mainLayout.cells("b").collapse()
            mainLayout.cells("b").hideArrow();
            $('.dhx_cell_layout.dhxlayout_collapsed_h')[0].style.height = "0px";          
        }
        if (query["hidehistory"]){
            mainLayout.cells("c").collapse()
            mainLayout.cells("c").hideArrow();
            $('.dhx_cell_layout.dhxlayout_collapsed_h')[0].style.height = "0px";           
        }
        //menu text and buttons
        addMenuButtons();
        
        mainLayout.attachEvent("onPanelResizeFinish", function() {
            saveLayoutSizes(mainLayout, "mainLayout");
        });

            m_lastsortelementid = {}
            m_lastsortdir = {}
            m_lastsortelementid["treetable_active"] = "active-state";
            m_lastsortdir["treetable_active"] = "asc";
			m_lastsortelementid["treetable_history"] = "history-job_start";
            m_lastsortdir["treetable_history"] = "des";
            console.log("Applying default sorting for active and history grid")
		
        socket.on('newhistoryjob', async function() {
            //m_historyGrid.loadGridData();
            // var tree = $("#treetable_history").fancytree('getTree');
            
            // //check if we are showing the first page
            // if (tree.mystuff.page != 1){
            //     console.log("loading of new history job suppressed because page is not 1")
            //     return;
            // }
            // tree.getNewData();
            // return;



            // //legacy jobs field mapping, need for update from <1.3.9
            // msg.title = msg.state;
            // msg.key = msg._id;

            // if (applyWorkflowFilter(msg) == false) {
            // //apply user permissions
			// 	return;
            // }
			// if (history_search_is_active()){
			// //apply search if any
			// 	if (!search_history_check_new_row(msg)){
			// 		return;
			// 	}
			// }
            // //server informs us about new history jobs in db, if there are new, we fetch them
            // var rootNode = $("#treetable_history").fancytree("getRootNode");

            // var existing_node = rootNode.tree.getNodeByKey(msg.key)
            // //store the position of existing nodes (for update)
            // if (existing_node) {
            //     existing_node.fromDict(msg);
            //     return;
            // }
			
            // firstnode = rootNode.findFirst("");
            // if (firstnode) {
            //     if (firstnode.extraClasses == "odd_dhx_skyblue") {
            //         msg.extraClasses = "ev_dhx_skyblue";
            //     } else {
            //         msg.extraClasses = "odd_dhx_skyblue";
            //     }
            // }

			// //cleanup too many nodes to support running the webinterface for indefinite time
			// while(rootNode.countChildren(false) > m_max_history_gridrows){
			// 	rootNode.getLastChild().remove();
			// }
            
			// //add new node
            // var childNode = rootNode.addChildren(msg, $("#treetable_history").fancytree("getRootNode").getFirstChild());
            // //take care about grid sorting
            
            // //save grid selection
            // await sortGrid("treetable_history", m_lastsortelementid["treetable_history"], m_lastsortdir["treetable_history"]);
			// //restore grid selection
			
        });

        socket.on('incomingjobs', function(msg) {
           
            if (JSON.parse(msg)) {
                var q_obj = (JSON.parse(msg));
                for (let i=0;i<q_obj.length;i++){
                    //convert file time to time of user perspective
                    q_obj[i]["job_start"] = new Date(q_obj[i]["job_start"] + " UTC" );//if do not do this, time will be off from timezone
                    q_obj[i]["job_start"] = new Date(q_obj[i]["job_start"] + " UTC" ).toISOString().replace("T"," ").replace(/\..*/,""); 
                    q_obj[i]["job_id"] = q_obj[i].fullpath;
                }
                addActiveJobsToGrid(runningJobGrid, q_obj, "Incoming");
            }
            mainLayout.cells("b").progressOff();
        });
		
        socket.on('queuedjobs', function(msg) {
            if (JSON.parse(msg)) {
                var q_obj = (JSON.parse(msg))
                addActiveJobsToGrid(runningJobGrid, q_obj, "Queued");
            }
            mainLayout.cells("b").progressOff();
        });
        socket.on('activejobs', async function(msg) {
            //load activejobs from server and call
            var activejobs = await $.ajax({
                url: "/getactivejobsajax_treegrid",
                type: 'GET', 
            });

            addActiveJobsToGrid(runningJobGrid, activejobs, "Active");
            mainLayout.cells("b").progressOff();
        });
        socket.on('error', function(msg) {
            dhtmlx.message(msg);
        });
        socket.on('msg', function(msg) {
            dhtmlx.message(msg);
        });
        socket.on('alert', function(msg) {
            dhtmlx.alert(msg);
        });
        
        

            window.setInterval(function() {
                getActiveJobs(runningJobGrid)
            }, parseInt(3000));
            
            getActiveJobs(runningJobGrid);
        


        $('input[type="search"]').click(function(event){
        /*need to canclebubble on type search to prevent sorting*/
        
            event.stopPropagation();
        });

        
        buildHistoryGrid();
        buildActiveGrid();
		setInitialColumnWidths();
		attachColResizeable("#treetable_active")
		attachColResizeable("#treetable_history")

        forcejobloading();
        //sort grids
		console.log("Sortying history by ",m_lastsortelementid["treetable_history"],m_lastsortdir["treetable_history"])
        //history grid is sorted in buildHistoryGrid
        sortGrid("treetable_active", m_lastsortelementid["treetable_active"], m_lastsortdir["treetable_active"]);
		


		window.onresize = debounce(function(){
            /* takes care about column resize matters */

            console.log("window was resized");
            validateColSizes();
            //workaround grips getting lost after resize: as fancytree takes a while to resize on window resize, we delay the resizing of colresizeable plugin
            window.setTimeout(function(){
                attachColResizeable("#treetable_active")
                attachColResizeable("#treetable_history")
			},100)
		},500);
		
    }

    function debounce(func,timeout){
            //used to prevent firing window onresize "while the window is resized", e.g. wait 100ms for no size change and only then execute the function
            var timer;
            return function(event){
                if(timer) clearTimeout(timer);
                timer = setTimeout(func,timeout,event);
            };
        };

    function validateColSizes(){
        try{
            //this was the best way we found to force a max-size for a table column, colResizable plugin does not support maxwidth
            //let historystatecolw = localStorage.getItem("treetable_history").match(/^\d+/)[0];
            let activestatecolw = localStorage.getItem("treetable_active").match(/^\d+/)[0];
            // if (historystatecolw > 86){
            //     console.log("State column size is bigger than 85, forcing maxsize");
            //     console.log("before",localStorage.getItem("treetable_history"))
            //     let newHistWidthList = localStorage.getItem("treetable_history").replace(/^\d+/,85);
            //     localStorage.setItem("treetable_history",newHistWidthList);
            // }
            if (activestatecolw > 86){
                console.log("before",localStorage.getItem("treetable_active"))
                let newHistWidthList = localStorage.getItem("treetable_active").replace(/^\d+/,85);
                localStorage.setItem("treetable_active",newHistWidthList);
            }
        }catch(ex){
            console.log(ex)
        }
    }

    function buildWorfklowTree(){

        $.ajax({
            url:  "/getworkflowlist",
            type: "GET",
            crossDomain: true,
            dataType: "json",
            success: function (response) {
                console.log("workflows",response)
                if (response['workflows'].length == 0){
                    alert("Did not get any workflows from FFASTRANS API");
                }else{
                    m_workflowArray = response['workflows'];
                    
                    mainLayout.cells("a").progressOff();
                    mainLayout.cells("a").detachObject();
                    mainLayout.cells("a").attachObject("workflow_filter_menu");
                    
                    //search button
                    $("input[name=wf_filter]").keyup(function(e){
                      var n,
                            tree = $("#workflowtree").fancytree('getTree');
                            opts = {},
                            filterFunc = tree.filterNodes,
                            match = $(this).val();
                            if(e && e.which === $.ui.keyCode.ESCAPE || $.trim(match) === ""){
                                tree.clearFilter();
                                return;
                            }
                        // Pass a string to perform case insensitive matching
                        n = filterFunc.call(tree, match, opts);
						
                    }).focus();
                    
                    //finally build workflow tree
                    parseWorkflows(m_workflowArray,{"selectMode":2,"dom_id":"workflowtree","extensions":["filter","multi","persist"]},on_treeWorkflowSelected,function(){/*no click evt*/});
                    var sel = $("#workflowtree").fancytree('getTree').getSelectedNodes();

                    if (sel.length != 0){
                        //on initial page load, don't apply the filter if empty
                        applyWorkflowSearch(sel);
                    }
                    
                }
            },
            error: function (xhr, status) {
                mainLayout.cells("a").progressOff();
                dhtmlx.message("ERROR getting WORKFLOWS, please check FFAStrans Path in Admin settings on the left. or you have an invalid expression in filter?");
            }
        });
    }

    function applyWorkflowSearch(selectednodes){
        var searchpatterns = [];
        selectednodes.forEach(function(n){
            if (n.folder){
                //unselect folders
                console.log("unselecting folder",n.title)
                n.setSelected(false)
            }else{
                searchpatterns.push(n.title);
            }
        })
        console.log("Applying filter search from applyWorkflowSearch",searchpatterns)
        applyFilter("workflow",searchpatterns.join("|"));
    }
    
    
    function on_treeWorkflowSelected(event, data){
        //user selected a workflow, modify workflowfilter
        
        var s = data.tree.getSelectedNodes();
        console.log("on_treeWorkflowSelected");
        applyWorkflowSearch(s);
    }

		
	function setInitialColumnWidths(){
	
		/*only set column widths if there ar no stored ones*/
		var do_restore = true;
		if ("treetable_active" in localStorage){
			console.log("Not restoring InitialColumnwidths as it is not the first time user opened the site")
			do_restore = false;
		}
		console.log("Setting initial width percent values")
		var running_percent = m_serverconfig["STATIC_RUNNING_GRID_COL_WIDTHS_PERCENT"].split(",");
		console.log(running_percent)
		var idx = 0;
		$('#colgroup_active').children('col').each(function () {
			try{
			
				if (!running_percent[idx] && do_restore){
					$($('#colgroup_active').children('col')[idx]).css("width","4%"); //minimum width
				}
				if (running_percent[idx] && (do_restore)){
					console.log($($('#colgroup_active').children('col')[idx]),running_percent[idx])
					$($('#colgroup_active').children('col')[idx]).css("width",running_percent[idx])
				}
				if (running_percent[idx] == "0%"){
					//hide if admin config is 0%
					$($('#tr_treetable_active').children('th')[idx]).css("display","none")
				}
						
			}catch(ex){
				console.log(ex)
			}
			idx++;
		});
		
		var history_percent = m_serverconfig["STATIC_FINISHED_GRID_COL_WIDTHS_PERCENT"].split(",");
		idx = 0;
		$('#colgroup_history').children('col').each(function () {
			try{
				if (!history_percent[idx] && do_restore){
					$($('#colgroup_active').children('col')[idx]).css("width","4%"); //minimum width
				}
				if (history_percent[idx] && ( do_restore)){
					$($('#colgroup_history').children('col')[idx]).css("width",history_percent[idx])
				}
				if (history_percent[idx] == "0%"){
					$($('#tr_treetable_history').children('th')[idx]).css("display","none");
				}
			}catch(ex){		
			}
			idx++;
		});
	}
		
		

    function click_a_header(id) {
        clearSelection();
        var tree = $('#treetable_active').fancytree('getTree');
        var selected = tree.getSelectedNodes();
        if (selected.length == 0) {
            dhtmlx.alert("Please select row");
            return;
        }
        if (selected[0]["title"].match(/queued|incoming/i) && id == "a_details"){
                    dhtmlx.message("Sorry, no details to show for queued jobs available");
                    return;
        }
        
        if (id == "a_details") {
            var jobid = (selected[0].data["job_id"]);
            openLogViewer(jobid);
            // var url = "logviewer.html?job_id=" + jobid;
            // var dhxwins = new dhtmlXWindows();
            // //dhxwins.attachViewportTo(window.parent.document.body);
            // var win = dhxwins.createWindow("Job Details", 10, 10, window.innerWidth-20,window.innerHeight-20);
            // win.setText("Job Details");
            // win.attachURL(url);


        }
        if (id == "a_abort") {
            jobCommand(selected, "abort");//jobid for incoming jobs is the filename of mons/i file
        }
        if (id == "a_pause") {
            jobCommand(selected, "pause");
        }
        if (id == "a_resume") {
            jobCommand(selected, "resume");
        }
        if (id == "a_priority") {
            show_priority_window();
        }
        
 
    }
    
    function show_priority_window(){
        //currently not active because button a_priority is not active
        const windowHTML = "Higher priority jobs will be processed before lower priority";
        const dhxWindow = new dhx8.dhx.Window({
            width: 440,
            height: 520,
            title: "New Priority",
            modal: false,
            closable: true,
            movable: true
        });
        
        const list = new dhx8.dhx.List(null, {
        });

        list.data.parse([
            {text:"4 - Very high",value:4},
            {text:"3 - High",    value:3},
            {text:"2 - Normal",  value:2},
            {text:"1 - Low",     value:1},
            {text:"0 - Very low",value:0}
        ]);

        list.events.on("click", function (what) {
            var selected_value = list.data.getIndex(list.selection.getId());
            var tree = $('#treetable_active').fancytree('getTree');
            var selected = tree.getSelectedNodes();
            jobCommand(selected,"priority",selected_value);
            dhxWindow.destructor();
        });
        dhxWindow.attach(list)
        dhxWindow.show();
    }   

    function show_options_window(){
        var dhxwins = new dhtmlXWindows();
        var win = dhxwins.createWindow("View Options", window.innerWidth/2, window.innerHeight/4, 600, 600);
        win.setText("View Options ");
        win.attachURL("jobviewer_pages/options.html");
    }

    window.history_grid_actions= history_grid_actions;
    function history_grid_actions(id,node) {
        //if we have node argument, we are called from context menu
        if (id == "b_options") {
            show_options_window();
            return;
        }

        let selected = m_historyGrid.selection.getCells();
  
        if (selected.length == 0 ) {
            dhtmlx.alert("Please select row");
            return;
        }
        if (id.match("resubmit")) {
            selected.forEach(function(node) {
                resubmit_job(node.row.guid||node.row.job_id);
            })
        }
        if (id.match("details")) {
            var jobid = (selected[0].row.job_id); 
            openLogViewer(jobid);
        }
        if (id.match("delete")) {
            let array_to_delete = [];
            let a_gridids = [];
            for (let i = 0; i < selected.length; i++) {}
            selected.forEach(function(cell_and_row) {
                array_to_delete.push(cell_and_row.row.job_id);
                a_gridids.push(cell_and_row.row.id)
            });
            m_historyGrid.data.remove(a_gridids);
            socket.emit("deletejob", JSON.stringify(array_to_delete)); //note, custom structure for socket.emit messages
            
        }
        
    }

	function attachColResizeable(tree_id){
		/*(re-) attaches colresizeable jquery plugin to given tree id
		  this must be done on window resize, otherwise the grip point is mislocated
		*/
			//destroy existing 
			$(tree_id).colResizable({
			   disable:true
			});
            
			//recreate
			let _colres = $(tree_id).colResizable({
				resizeMode: 'fit',
				hoverCursor: "col-resize",
				dragCursor: "col-resize",
				postbackSafe: true,
				useLocalStorage: true,
				minWidth: 10,
				liveDrag: true,
				removePadding : true,
                onResize:onAfterColumnResized
			});

            // if (tree_id.match(/history/))   
            //     $("#treetable_history").fancytree('getTree').mystuff.colResizeable = _colres;

	}
	
    function onAfterColumnResized(e){
        validateColSizes();

        // console.log("onAfterColumnResized",e);
        // $("#treetable_history").fancytree('getTree').mystuff.colResizeable.applyBounds();
        // let statecol = document.getElementById("history-state");
    }

    function buildActiveGrid() {

        //var sourceUrl = "testdata.xml";
        $("#treetable_active").fancytree({
            extensions: ["contextMenu","table", "gridnav", "multi"],
            icon: false,
            checkbox: false,
            titlesTabbable: true, // Add all node titles to TAB chain
            table: {
                indentation: 15,
                nodeColumnIdx: 0,
            },
            select: function(event, data) {
                if (data.node.isSelected()) {
                    data.node.addClass("rowselected");
                    toggleJobControl("#treetable_active",true);
                } else {
                    data.node.removeClass("rowselected");
                    toggleJobControl("#treetable_active",false);
                }
            },
            gridnav: {
                autofocusInput: false,
                handleCursorKeys: true
            },
            multi: { //multiselct
                mode: "",
            },
            init: function(event, data) {
                //ENABLE RESIZE COLUMNS
                console.log("buildActiveGrid init")
				attachColResizeable("#treetable_active")

            },
            modifyChild: function(event, data) {
                //reset all odd even row colors
                var rootNode = $("#treetable_active").fancytree("getRootNode");
                var oldnodes = rootNode.children;
                for (let i = 0; i < oldnodes.length; i++) {
                    if (i % 2 == 0) {
                        oldnodes[i].toggleClass("ev_dhx_skyblue", true)
                        oldnodes[i].toggleClass("odd_dhx_skyblue", false)
                    } else {
                        oldnodes[i].toggleClass("odd_dhx_skyblue", true)
                        oldnodes[i].toggleClass("ev_dhx_skyblue", false)
                    }
                }
            },
            renderColumns: function(event, data) {
                var node = data.node;
                
                node.addClass("act_row"); //for context menu
                if (data.node.getIndex() % 2 == 0) {
                    node.removeClass("odd_dhx_skyblue"); //apply dthmlx style to node
                    node.addClass("ev_dhx_skyblue"); //apply dthmlx style to node
                } else {
                    node.removeClass("ev_dhx_skyblue"); //apply dthmlx style to node
                    node.addClass("odd_dhx_skyblue"); //apply dthmlx style to node
                }

                $tdList = $(node.tr).find(">td");
				
				var filename_to_display = node.data.source;
                
				try{
					filename_to_display = (node.data.source.split("\\").pop());
					if (filename_to_display.indexOf("/") != -1){
                        filename_to_display = filename_to_display.split("/").pop();
                    }
				}catch(ex){
					//do nothing in order to support non filename sources
				}
				
                $tdList.eq(1).html("<div class='celltext' title='"+ node.data.workflow +"'>" + node.data.workflow + "</div>"); //.addClass("alignRight");
                $tdList.eq(2).html("<div class='celltext'>" + node.data.job_start + "</div>");
                $tdList.eq(3).html("<div class='celltext_rtl'><bdi>" + filename_to_display + "</bdi></div>");
                console.log(node.data)
                $tdList.eq(4).html("<div class='celltext'>Prio " +  (node.data.priority || 1) + " @ " + node.data.proc + " @ " + node.data.host + "</div>");
                $tdList.eq(5).html("<div class='celltext'>" + node.data.status + "</div>");
                
                $tdList.eq(6).html('<div class="progressbar" style=" width:' + node.data.progress + '%">' + node.data.progress + '% ' + node.data.steps.replace(/ /g, "") + '</div>');

				//hide td if needed
				var active_percent = m_serverconfig["STATIC_RUNNING_GRID_COL_WIDTHS_PERCENT"].split(",");
				for(i=0;i<active_percent.length;i++){
					if (active_percent[i] == "0%"){
						$tdList.eq(i).css("display","none")
					}
				}

                data.tree.getRootNode().sortChildren(function(a, b) {
                    return (a.title.localeCompare(b.title))
                }, true);

            },
            postProcess: function(event, data) {
                // transform gethistoryjobsajax result into tree compatible
                // data is a treegrid specific object
                
                data["result"] = data["response"]["data"] //setting data["result"] means override the originally loaded data
				
            },
            dblclick: function(event, data) {},
            contextMenu: {
                selector: "act_row",
                menu: getContextMenuHistoryGrid( 
                    {   
                        "details": {
                            "name": "Job Details"
                        },
                        "prio": {
                            "name": "Priority",
                            "items": {
                                "prio_0": { "name": "0 (Low)" },
                                "prio_1": { "name": "1" },
                                "prio_2": { "name": "2" },
                                "prio_3": { "name": "3" },
                                "prio_4": { "name": "4 (High)" }
                            }
                        },
                        '<i style = "margin-right:3px" class= "fas fa-pause fa-sm" ></i> pause': {
                            "name": "Pause"
                        },
                        "resume": {
                            "name": "Resume"
                        },                        
                        "abort": {
                            "name": "Abort"
                        }
                    }) ,
                    actions: function(node, action, options) {
                        console.log("action: ", action)
                        clearSelection(); //disable browser internal line selection if user selected multiple rows using shift. TODO: catch shift globally and do this
                        var tree = $('#treetable_active').fancytree('getTree');
                        var selected = tree.getSelectedNodes();
                        $.extend(selected,node);
                        if (selected.length == 0 && !node ) {
                            dhtmlx.alert("Please select row");
                            return;
                        }
                        if (action == "details") {
                            var jobid = (node.data["job_id"]); //jobid contains splitid, job_id can be shared between multiple jobs
                            openLogViewer(jobid);
                        }
                        if (action.indexOf("resume") != -1) {
                           console.log(selected)
                           jobCommand(selected, "resume");
                        }
                        if (action.indexOf("abort") != -1) {
                           console.log(selected)
                           jobCommand(selected, "abort");
                        }
                        if (action.indexOf("pause") != -1) {
                           console.log(selected)
                           jobCommand(selected, "pause");
                        }
                        if (action.indexOf("prio") != -1){
                           var newprio = action.split("_")[1];
                           jobCommand(selected, "priority", newprio);
                        }
                        

                    }
                }//contextmenu
            

        })

    }

    function openLogViewer(jobid){
        var url = "logviewer.html?job_id=" + jobid;
        var dhxwins = new dhtmlXWindows();
        var win = dhxwins.createWindow("Job Details", 10, 10,  window.innerWidth-20,window.innerHeight-20);
        win.setText("Job Details");
        win.attachURL(url);
        window.onresize = function(){
            win.setDimension(window.innerWidth-20,window.innerHeight-20);
        }

     
        //support closing with escape key from within iframe
        dhxwins.attachEvent("onContentLoaded", function(win){
                //support esc key for close window
                console.log("CONTENTLOADED")
				var ifr = win.getFrame();
                ifr.contentWindow.focus();
                console.log("iframe",ifr.contentWindow)
                var elem = ifr.contentWindow.m_closefunc = function(){
                    win.close()
                }
        });
    }

    //DEPRECATED, WE FILTER ON SERVER NOW
    // function filterHistoryList(the_list) {
    //     /* DEPRECATED */
    //     var filtered = the_list;
    //     return filtered
    //     //TESTING FILTER ON SERVER

    //     for (let i = 0; i < m_userpermissions.length; i++) {
    //         if (m_userpermissions[i]["key"] == "FILTER_WORKFLOW_NAME") {
    //             if (filtered == the_list) {
    //                 filtered = [];
    //             }
    //             for (let idx = 0; idx < the_list.length; idx++) {
    //                 var name = the_list[idx]["workflow"];
    //                 var regex = new RegExp(m_userpermissions[i]["value"]["filter"], 'gi');
    //                 if (name.match(regex)) {
    //                     filtered.push(the_list[idx]);
    //                 }
    //             }
    //         }
    //     }
    //     return filtered;

    // }

    function getContextMenuHistoryGrid(allpossible){
        //opens context menu
                
        var contextmenu = {};
        var _filter = _getObjectByValue(m_userpermissions,"FILTER_JOBSTATUS_BUTTONS");
        if (_filter.length > 0){
            var regex = new RegExp( _filter[0]["value"]["filter"], 'gi' );
            console.log("Displaying filtered list of buttons, regex: ", regex);
            for (var _idx in allpossible){
               if (allpossible[_idx]){
                    if (allpossible[_idx].name.match(regex)){
                        console.log(allpossible[_idx]);
                        var newitem = {};
                        newitem[_idx] = allpossible[_idx];
                        $.extend(contextmenu, newitem);
                        console.log(contextmenu);
                    }
               } 
            }
            return contextmenu;
        }else{
            //just render all btns
            console.log("Displaying unfiltered list of menu buttons" );
            contextmenu = allpossible;
            return contextmenu;
        }
    }

    function getContextMenuHistoryGrid_ex(allpossible){
        //opens context menu
                
        var contextmenu = {};
        var _filter = _getObjectByValue(m_userpermissions,"FILTER_JOBSTATUS_BUTTONS");
        if (_filter.length > 0){
            var regex = new RegExp( _filter[0]["value"]["filter"], 'gi' );
            console.log("Displaying filtered list of buttons, regex: ", regex);
            for (var _idx in allpossible){
               if (allpossible[_idx]){
                    if (allpossible[_idx].name.match(regex)){
                        console.log(allpossible[_idx]);
                        var newitem = {};
                        newitem[_idx] = allpossible[_idx];
                        $.extend(contextmenu, newitem);
                        console.log(contextmenu);
                    }
               } 
            }
            return contextmenu;
        }else{
            //just render all btns
            console.log("Displaying unfiltered list of menu buttons" );
            contextmenu = allpossible;
            return contextmenu;
        }
    }
    
    function buildPagination(config,dhxgrid)
    {
        var total = config.total;
        // var tree = $('#treetable_history').fancytree('getTree');
        if (dhxgrid.mystuff.page != 1){
            //skip rebuilding pagination if we show another page than first
            return;
        }
        $('#pagination-container').pagination({
            totalNumber: total,
            pageSize: m_max_history_gridrows,
            showGoInput: true,
            showGoButton: true,
            dataSource: function(done){
                        //this is mandatory but pretty useless, we can store custom data in the pagination object. we just store the row indexes
                        var result = [];
                        for (var i = 1; i < this.totalNumber; i++) {
                            result.push(i);
                        }
                        done(result);
                    },
            callback: function(data, pagination) {
                //click on some page number
                if (pagination.pageNumber != dhxgrid.mystuff.page){
                    //a new  page was selected, reload tree
                    // var start = (pagination.pageNumber-1) * m_max_history_gridrows;
                    // var sourceUrl = "/gethistoryjobsajax_treegrid?sortcol="+tree.mystuff.sortcol+"&direction="+tree.mystuff.sortdir+"&start=" +start+ "&count=" + m_max_history_gridrows+"&filterobj="+encodeURIComponent(JSON.stringify(tree.mystuff.filterobj));
                     
                    // tree.mystuff.page = pagination.pageNumber;
                    // tree.reload({
                    //     url: sourceUrl,
                    //     cache: false
                    // });
                    dhxgrid.mystuff.page = pagination.pageNumber;
                    dhxgrid.loadGridData();

                    if (pagination.pageNumber != 1){
                        document.getElementById("span_text_finished").innerHTML = 'Finished <span style="color:orange">(Page ' +pagination.pageNumber+ ')</span>'
                        //addMenuButtons()
                    }else{
                        document.getElementById("span_text_finished").innerHTML = 'Finished</span>'
                        //addMenuButtons()
                    }
                }

                var html = "<span></span>";
                $('#data-container').html(html);
                
            }
        })
    }

    
    function addVariableColumns(){

        // let htmltemplate = `
        //     <th id="history-variable" name="variable" data-sort_dir="">       
        //         <div style="display:flex;margin-left:10px">
        //             <div id="history-variable-sorticon-dis">
        //                     <div class="up-arrow up-arrow-dis"></div>
        //                     <div class="down-arrow down-arrow-dis"></div>
        //             </div>
        //             <i id="history-variable-sorticon" name="treetable_history-sorticon"></i>        
        //             <input placeholder="Variable" style="width:90%;height:18px;margin-left:5px;margin-right:3px" type="search" name="search" incremental autocomplete="off" />		           
        //             <img title="delete filters" style="display:none;width:15px;height:15px;margin-right:3px;margin-left:3px;cursor:pointer" src= "../images/remove-filter-icon-16.jpg"></img>
        //         </div>
        //     </th>`;

        let htmltemplate = `
            <th name="col_header_name" data-sort_dir="">       
                <div style="display:flex;margin-left:10px">       
                    <input placeholder="col_header_name" data-isvariablecol=true style="width:90%;height:18px;margin-left:5px;margin-right:3px" type="search" name="search" incremental autocomplete="off" />
                    <img title="delete filters" style="display:none;width:15px;height:15px;margin-right:3px;margin-left:3px;cursor:pointer" src= "../images/remove-filter-icon-16.jpg"></img>	           
                </div>
            </th>`;

        const trh = document.getElementById('tr_treetable_history');
        if (m_serverconfig.job_viewer && m_serverconfig.job_viewer.variable_columns){
            let variablecolumns = m_serverconfig.job_viewer.variable_columns;
            for (let i=0;i<variablecolumns.length;i++){
                let copy = htmltemplate;
                copy = copy.replaceAll("col_header_name",variablecolumns[i].col_header_name);
                trh.insertAdjacentHTML('beforeend', copy);
            }
        }

    }

    function bla(){
        if (m_serverconfig.job_viewer && m_serverconfig.job_viewer.variable_columns){
            let variablecolumns = m_serverconfig.job_viewer.variable_columns;
            for (let i=0;i<variablecolumns.length;i++){
                let copy = htmltemplate;
                copy = copy.replaceAll("col_header_name",variablecolumns[i].col_header_name);
                trh.insertAdjacentHTML('beforeend', copy);
            }
        }
    }
    async function buildHistoryGrid(){

        let searchboxhtml = `<input class="searchbox" placeholder="" onclick="event.stopPropagation()"></input>`;
        //grid columns are defined on server side
        let colres = await fetch("/gethistory_jobviewercolumns");
        if (!colres.ok)
                return dhx8.dhx.message({ expire: 3000, text: "Error loading grid config"});
        let gridcolumns = await colres.json();
        
        //apply user state
        if (localStorage.jobviewer_history_grid_column_config){
            try{
                //inject merit and hidden state from user config (options.html)
                let userconf = JSON.parse(localStorage.jobviewer_history_grid_column_config);
                gridcolumns = gridcolumns.map(c=>{
                    let uc = userconf.filter(uc=>{return uc.id == c.id});
                    if (uc.length != 1)
                        return c;
                    c.hidden    = uc[0].user_hidden;
                    c.merit     = uc[0].merit;
                    return c;
                });

                gridcolumns.sort((a, b) => a.merit - b.merit);
            }catch(ex){console.error("Cannot restore user column config",ex)}
        }


        console.log("gridcols with userdata",gridcolumns)

        /* build the grid */
        const grid = new dhx8.dhx.Grid("history_div", {
            columns: gridcolumns,
            keyNavigation: true,
            autoWidth: true,
            resizable: true,
            multiselection:true,
            height: "auto",
            rowHeight: 20,
            headerRowHeight: 30,
            selection: "row",
            css: "alternate_row ffastrans_grid_style",
            eventHandlers: {
                
                oninput:{
                    searchbox: debounce((event,  args) => {
                        //debounce function prevents this to fire multiple times parallel while user is typing
                        //only if user did not type for 500ms, function will fire
                        grid.filterobj = collectFilters();
                        grid.data.removeAll();
                        loadGridData();
                    },750),
                },
                onclick: {
                    /* expand row with children */ 
                    expander: (event,  {row} ) => {//expander is in classlist of state htmle template
                        console.log(row)
                        if (row.expanded) {
                            grid.data.update(row.id, { expanded: false });
                            document.getElementById(row.job_id + "_expander").classList.replace('dxi-chevron-down', 'dxi-chevron-right');
                            let to_remove = [];
                            grid.data.forEach(function(item, index, array) {
                                if (item.parentid == row.id)
                                    to_remove.push(item.id);
                            });
                            
                            grid.data.remove(to_remove);

                        } else {
                            grid.data.update(row.id, { expanded: true });
                            document.getElementById(row.job_id + "_expander").classList.replace('dxi-chevron-right', 'dxi-chevron-down');
                            expandgridrow();
                            function expandgridrow(rid){
                                //add the child rows into grid after 
                                const index = grid.data.getIndex(row.id);
                                grid.data.add(row.children.map(c=>{//each branch row
                                        c.parentid = row.id,
                                        c.state="<p style='text-indent:30px'>" + c.state;
                                        c.source="<p style='text-indent:30px'>" + c.source;
                                        c.outcome="<p style='text-indent:30px'>" + c.outcome;
                                        return c
                                    }),index+1);
                            }
                        }
                    }
                }
            },
        });
        m_historyGrid = grid;
        //custom fields keep track of current state
        grid.filterobj      = {};
        grid.sortcol        = "";
        grid.sortdir        = "";
        grid.mystuff        = {page:1}
        grid.loadGridData   = loadGridData;

        /* Row select */
        grid.selection.events.on("AfterSelect", (row, column) => {
            toggleJobControl("history",true);
        });

        /* Sorting */
        grid.events.on("beforeSort", (column, dir) => {
            /* remove all rows and reload sorted data from server */
            grid.sortcol =  column.id;
            grid.sortdir =  dir;
            grid.data.removeAll();
            loadGridData();
            return true;
        });
        
        /* Searching */
        function collectFilters(){ //collects all search values
            let filterobj = {};
            filterobj.variablecols = [];
            const searchboxes = document.querySelectorAll('.searchbox');
            searchboxes.forEach((searchbox) => {
                if (searchbox.value == "")
                    return;

                let header_id = searchbox.closest('.dhx_grid-header-cell').dataset.dhxId;                
                if (searchbox.dataset.variablecol){
                    filterobj.variablecols.push({col_header_name:header_id,filter:searchbox.value});
                }else
                    filterobj[header_id] = searchbox.value;
                
            })
            return filterobj;
        }

        /* Data loading */
        async function loadGridData(){
            let urlSearchParams =  new URLSearchParams({});
            urlSearchParams.append("count", m_max_history_gridrows);
            urlSearchParams.append("filterobj", JSON.stringify(grid.filterobj));
            urlSearchParams.append("sortcol", grid.sortcol);
            urlSearchParams.append("direction", grid.sortdir);
            urlSearchParams.append("start", grid.mystuff.page == 1 ? 0 : m_max_history_gridrows * (grid.mystuff.page-1));

            let url = "/gethistoryjobs_dhx?"+urlSearchParams.toString();
            var response = await fetch(url);
            if (!response.ok)
                return dhx8.dhx.message({ expire: 3000, text: "Error loading grid data"});
            const json = await response.json();
            grid.data.parse(json.data);
            console.log("fetched",json);

            urlSearchParams.append("getcount", 1);
            let counturl = "/gethistoryjobs_dhx?"+urlSearchParams.toString();
            var countresponse = await fetch(counturl);
            if (!countresponse.ok)
                return dhx8.dhx.message({ expire: 3000, text: "Error counting grid data"});
            
            const countjson = await countresponse.json();
            console.log("countresponse",countjson)
            buildPagination({total:countjson.total_count},grid);

        }

        attachGridContextMenu()
        loadGridData();


    }//buildHistoryGrid

    function attachGridContextMenu(){
        
        const contextMenu = new dhx8.dhx.ContextMenu(null, { css: 'grid-context-menu' });
        let menuitems = [
            {
                type: 'menuItem',id: 'details',value: 'Job Details'
            },
            // {
            //     type: 'menuItem',id: 'prio',value: 'Priority', items:[
            //         { type:"menuItem", id:"prio_0",value:"0 (Low)" },
            //         { type:"menuItem", id:"prio_1",value:"1" },
            //         { type:"menuItem", id:"prio_2",value:"2" },
            //         { type:"menuItem", id:"prio_3",value:"3" },
            //         { type:"menuItem", id:"prio_4",value:"4 (High)" }
            //     ]
            // },
            {
                type: 'menuItem',id: 'resubmit',value: 'Resubmit'
            },
			{
                type: 'menuItem',id: 'delete',value: 'Delete'
            }
        ]

        var _filter = _getObjectByValue(m_userpermissions,"FILTER_JOBSTATUS_BUTTONS");
        if (_filter.length > 0){
            //filters user permissions, todo: support multiple FILTER_JOBSTATUS_BUTTONS?
            var regex = new RegExp( _filter[0]["value"]["filter"], 'gi' );
            console.log("Displaying filtered list of buttons, regex: ", regex);
            contextitems = contextitems.filter(itm=>{
                if (itm.name.match(regex))
                    return itm;
            })
        }

        contextMenu.data.parse(menuitems);
        /* context events */
        contextMenu.events.on("click", function(menu_id,e){
            history_grid_actions(menu_id);
        });

        m_historyGrid.events.on('CellRightClick', function (row, column, e) {
            m_historyGrid.selection.setCell(row.id, column);
            dhx8.dhx.awaitRedraw().then(function () {
                contextMenu.showAt(e);
            });
            event.preventDefault();
            return false;
        });
    }

    function translateJobs(joblist){
        /* modifies list of database jobs into tree compatible */
        for (var i=0;i<joblist.length;i++){
            try{
                var c = joblist[i];//mainjob
                if (c._id){
                    joblist[i].key = c._id;
                }
                c.title = c.state;
                if (c.children){
                    for (var c_idx =0;c_idx<c.children.length;c_idx++){
                        c.children[c_idx]["title"] = c.children[c_idx]["state"];
                        //c.result += c.children[c_idx].outcome + " ";
                    }
                }else{
                    c.children = [];
                }
                if (c.children.length == 1){
                    //if only 1 child, show as single job
                    joblist[i] = JSON.parse(JSON.stringify(c.children[0]));
                    joblist[i].key = c._id;
                }

            }catch(ex){
                console.error("Error postprocessing line ",c,ex)
            }
        }
        return joblist;
    }

	function search_history_check_new_row(new_row){
           
		/* called if search is active and new history job arrives, we need to apply the searchfields manually*/
            var show_row = true;
			for (let i = 0; i < $("input[name=search]").length; i++) {
                var input = $("input[name=search]")[i];
                searchfor = $.trim(input.value);
                var keyname = input.placeholder.toLowerCase();
                if(keyname.match(/start|end/)){
                    keyname = "job_" + keyname;
                }
                if (searchfor) {
					console.log("Checking if new row field ", keyname, "value:",new_row[keyname],"matches",searchfor)
                    var regex = new RegExp(searchfor, 'gi');

                    if (new_row[keyname].match(regex)){
                        console.log("match",regex)
						show_row = show_row == false ? show_row : true;
					}else{
                        console.log("no match",regex)
                        show_row = show_row == false ? show_row : false;
                    }
                }else{
                    show_row = show_row == false ? show_row : true;
                }
            }
            
            return show_row;

	}
	
	function history_search_is_active(){
		/* is a filter active? */
			var searchCount = 0;
			for (let i = 0; i < $("input[name=search]").length; i++) {
                var input = $("input[name=search]")[i];
                match = $.trim(input.value);
                if (match) {
                    searchCount++;
                }
            }
            console.log("History Search num of filters:",searchCount)
			return searchCount;
	}
	
    function saveLayoutSizes(dhxLayout, name) {
        //store layout cells height and with into html5 storage (in percentage of document height)
        var aw = (dhxLayout.cells("b").getWidth() / document.body.scrollWidth);
        var ah = (dhxLayout.cells("b").getHeight() / document.body.scrollHeight);
        var bw = (dhxLayout.cells("c").getWidth() / document.body.scrollWidth);
        var bh = (dhxLayout.cells("c").getHeight() / document.body.scrollHeight);
        var cw = (dhxLayout.cells("a").getWidth() / document.body.scrollWidth);
        var ch = (dhxLayout.cells("a").getHeight() / document.body.scrollHeight);
        localStorage.setItem(name + "_aw", aw);
        localStorage.setItem(name + "_ah", ah);
        localStorage.setItem(name + "_bw", bw);
        localStorage.setItem(name + "_bh", bh);
        if (!dhxLayout.cells("a").isCollapsed()){
            localStorage.setItem(name + "_cw", cw);
            localStorage.setItem(name + "_ch", ch);
        }
        localStorage.setItem(name + "_c_collapsed", dhxLayout.cells("a").isCollapsed());
    }

    function restoreLayoutSizes(dhxLayout, name) {
        if (localStorage.getItem(name + "_aw")) {
            if (localStorage.getItem(name + "_c_collapsed") == "false"  && !m_serverconfig["alternate-server"]){
                dhxLayout.cells("a").expand();
            }
            var aw = localStorage.getItem(name + "_aw");
            var ah = localStorage.getItem(name + "_ah");
            var bw = localStorage.getItem(name + "_bw");
            var bh = localStorage.getItem(name + "_bh");
            var cw = localStorage.getItem(name + "_cw");
            var ch = localStorage.getItem(name + "_ch");
            dhxLayout.cells("b").setWidth(aw * document.body.scrollWidth);
            dhxLayout.cells("b").setHeight(ah * document.body.scrollHeight);
            dhxLayout.cells("c").setWidth(bw * document.body.scrollWidth);
            dhxLayout.cells("c").setHeight(bh * document.body.scrollHeight);
            
            if (dhxLayout.cells("a").isCollapsed() == false){
                console.log("CW",cw)
                dhxLayout.cells("a").setWidth(cw * document.body.scrollWidth);
                dhxLayout.cells("a").setHeight(ch * document.body.scrollHeight);
            }

        }
        
    }


    function resubmit_job(job_id) {
        //get all workflows from server and start main with the workflow of interest
        job_id = job_id.split("~")[0];
        var _url = "/getjobdetails?jobid=" + job_id;
        $.ajax({
            url: build_new_api_url(_url),
            type: "GET",
            crossDomain: true,
            success: function(response) {

                if (response['wf_object'].length == 0) {
                    alert("Did not get any workflow in job from FFASTRANS API");
                } else {
					console.log("res: ",response)
                    var postBody = {};
                    postBody.start_proc = response["nodes"]["start"]["id"];
                    postBody.wf_id = response["workflow"]["id"];
                    postBody.inputfile = response["sources"]["localized_file"];
                    postBody.variables = response["variables"];
                    postBody.system = "FFAStrans Web Interface";
                    
					console.log("submitting wf: ",postBody)
                    $.ajax({
                        url: build_new_api_url("/jobs"),//buildUrl(m_serverconfig['STATIC_START_JOB_URL']),
                        type: "POST",
                        crossDomain: true,
                        contentType: "application/json",
                        data: JSON.stringify(postBody),
                        success: function(response) {
                            dhtmlx.message("Sucess")
                        },
                        error: function(xhr, status) {
                            console.log(xhr.responseText)
                            dhtmlx.alert("Error submitting workflow: " + xhr.responseText);
                        }
                    });
                }
            },
            error: function(xhr, status) {
                alert("ERROR getting workflow of job " + job_id + ", please check FFAStrans Path in Admin settings on the left.. ");
            }
        });
    }

    function jobCommand(fancy_node_array, action, value) {
        //only available in ffastrans 9.4>//TODO: wait for the new version call, then do version detection
        console.log("jobcommand", fancy_node_array,action,value)
        console.log(m_serverconfig)
        fancy_node_array.forEach(function(node) {
            //emcodem: check ffastrans version
            // if (node["data"]["state"] == "Queued" || node["data"]["state"] == "Incoming") {
            //     dhtmlx.message("Sorry, "+node["data"]["state"]+" Jobs cannot be controlled yet");
            //     return;
            // 

            var postBody = {
                "action": action,
                "job_id"   : node.data.job_id,
                "split_id": node.data.split_id
            };
            var jobid = "";
            if (node.data["ticket_path"]){
                //incoming
                postBody["value"] = node.data["ticket_path"];
            }

            if (value){
                postBody["value"] = value;
                
            }
            $.ajax({
                url: build_new_api_url("/jobs"),//("/proxy" + m_serverconfig['STATIC_START_JOB_URL']) + node.data.job_id,
                type: "PUT",
                context: this,
                contentType: "application/json",
                data: JSON.stringify(postBody),
                success: function(response) {
                    console.log("success")
                    dhtmlx.message("Success " + action + " " + node.data.job_id);
                },
                error: function(xhr, status) {
                    console.error(xhr)
                    dhtmlx.message("ERROR aborting job, contact developer. Status:" + status);
                }
            });
        })

    }


    function applyWorkflowFilter(o_job) {
        /* DEPRECATED */
        //returns true or false based on userpermission job filter
        //TESTING WORKFLOW FILTER DISABLED, INSTEAD UPDATE HISTORY GRID WHEN NEW HISTORY JOB ARRIVES
        return true;
        //todo: add wf group filter
        for (let i = 0; i < m_userpermissions.length; i++) { //iterate all permissions
            if (m_userpermissions[i]["key"] == "FILTER_WORKFLOW_NAME") {

                var regex = new RegExp(m_userpermissions[i]["value"]["filter"], 'gi');
                if (o_job["workflow"].match(regex)) {
                    return true;
                } else {
                    return false;
                }
            }
        }
        return true; //if there is no filter, render all jobs
    }

    function addActiveJobsToGrid(targetGridObj, jobArray, qstate) {
		
        var rootNode = $("#treetable_active").fancytree("getRootNode");
        var tree = $("#treetable_active").fancytree("getTree");
        //add or update new jobs
        var activeJobIds = [];
        for (let y = 0; y < jobArray.length; y++) {
            if (!search_history_check_new_row(jobArray[y])){
                continue;
            }
            if (applyWorkflowFilter(jobArray[y]) == false) {
                console.log("error ff471, please contact developer"); //should not come here because jobs must be already filtered on backend
                continue;
            }
            
            jobArray[y].key = jobArray[y]["job_id"] + "~" + jobArray[y]["split_id"]; //key is hardcoded in treegrid, its the row id
            activeJobIds.push(jobArray[y].key );
            jobArray[y].title = qstate;//Active/Queued...
            
            var existing = tree.getNodeByKey(jobArray[y].key);
            
            if (existing) {
				//console.log("Node exists, updating",jobArray[y])
				//console.log("Node exists, existing",existing)
                var needrender = false;
                if (JSON.stringify(existing.data) != JSON.stringify(jobArray[y])){
                    needrender = true;
                }
                existing.data = jobArray[y];
				//existing.title = qstate;
                
				try{
				//update all children
					for (var ec=0;ec<existing["children"].length;ec++){
						for (var nc=0;nc<jobArray[y]["children"].length;nc++){
							if (existing["children"][ec]["data"]["guid"] == jobArray[y]["children"][nc]["guid"]){
								existing["children"][ec]["title"] 	= jobArray[y]["children"][nc]["title"];
								existing["children"][ec]["data"] 	= jobArray[y]["children"][nc];
							}
						}					
					}
				}catch(ex){
					//console.log("Error updating children","jobarray",jobArray ,"message", ex)
				}
                if (needrender){
                    existing.renderTitle(); //forces reload of node
                }
            } else {
                rootNode.addChildren(jobArray[y]);
            }
        }
        
        //remove orphand
        var oldnodes = rootNode.children;
        if (oldnodes) {
            for (let a = 0; a < oldnodes.length; a++) {
                if (oldnodes[a].title == qstate) {
                    if (activeJobIds.indexOf(oldnodes[a]["key"]) == -1) {
                        oldnodes[a].remove();
                    }
                }

            }
        }
        //take care about grid sorting
        sortGrid("treetable_active", m_lastsortelementid["treetable_active"], m_lastsortdir["treetable_active"]);
        
    }

    /* HELPERS */
    function hashCode(string) {
        //this creates a hash from a stringified object, it is used to workaround and create missing jobids from ffastrans version 0.9.3
        var hash = 0,
            i,
            chr;
        if (string.length === 0)
            return hash;
        for (let i = 0; i < string.length; i++) {
            chr = string.charCodeAt(i);
            hash = ((hash << 5) - hash) + chr;
            hash |= 0; // Convert to 32bit integer
        }
        return hash;
    };

    function getDurationStringFromDates(start_date, end_date) {
        var delta = Math.abs(new Date(end_date) - new Date(start_date)) / 1000; // get total seconds between the times
        var days = Math.floor(delta / 86400); // calculate (and subtract) whole days
        delta -= days * 86400; // calculate (and subtract) whole hours
        var hours = Math.floor(delta / 3600) % 24;
        delta -= hours * 3600; // calculate (and subtract) whole minutes
        var minutes = Math.floor(delta / 60) % 60;
        delta -= minutes * 60; // what's left is seconds
        var seconds = delta % 60; // in theory the modulus is not required
        return pad(hours) + ":" + pad(minutes) + ":" + pad(seconds);
    }

    function pad(n, z) { //add leading zero if there is none
        z = z || '0';
        n = n + '';
        return n.length >= 2 ? n : new Array(2 - n.length + 1).join(z) + n;
    }

    function configureJobGrid(dhtmlxGridObj) {
        //todo: this is only for activejobgrid
        dhtmlxGridObj.setImagePath("../dependencies/dhtmlx/imgs");
        //dhtmlxGridObj.attachHeader("#text_filter,#text_filter,#text_filter,#text_filter,#text_filter,#text_filter,#text_filter,#text_filter,#text_filter,#text_filter,#text_filter,#text_filter");
        dhtmlxGridObj.setColAlign("left,left,left,left,left,left,left,left,left,left,left"); //the alignment of columns
        dhtmlxGridObj.setColTypes("ro,ed,ed,ed,ed,ro,ed,ed,ed,ed,ed,ed,ed"); //the types of columns
        dhtmlxGridObj.setColSorting("str,str,str,str,str,str,str,str,str,str,str,str"); //the sorting types
        dhtmlxGridObj.enableMultiselect(true);
        dhtmlxGridObj.init(); //finishes initialization and renders the grid on the page
    }

    function buildUrl(what) {
        if (JSON.parse(m_serverconfig['STATIC_USE_PROXY_URL'])) {
            return "/proxy" + what;
        } else {
            var _url = "http://" + m_serverconfig['STATIC_API_HOST'] + ":" + m_serverconfig['STATIC_API_PORT'] + what;
            return _url;
        }
        //old, delete at next iteration
    }

    /* NO PROXY MODE */
    /*TODO: this does not work anymore, add a parameter for in getactivejobsajaxt*/
    function forcejobloading() {
        getActiveJobs/* deprecated  ?!*/
        $.ajax({
            url: ("/getactivejobsajax_treegrid"),
            type: "GET",
            success: function(response) {},
            error: function(xhr, status) {}
        });
    }

    function getQueuedJobs(targetGridObj) {
        //deprecated; still there for "no proxy mode"
        $.ajax({
            url: build_new_api_url("/tickets"),
            type: "GET",
            crossDomain: true,
            dataType: "json",
            context: this,
            success: function(response) {
                mainLayout.cells("b").progressOff();
            },
            error: function(xhr, status) {
                dhtmlx.message("ERROR getting queued jobs, please check FFAStrans Path in Admin settings on the left..  ");
            }
        });
    }

    async function getActiveJobs(targetGridObj) {
        //deprecated; still there for "no proxy mode"
        try{
            var activejobs = await $.ajax({
                url: "/getactivejobsajax_treegrid",
                type: 'GET', 
            });

            addActiveJobsToGrid(runningJobGrid, activejobs, "Active");
        }catch(ajaxerror){
            if (ajaxerror.status == 401){
                //unauthorized, maybe server reloaded?
                window.setTimeout (function(){location.reload()},3000)
                dhtmlx.alert("Got 'unauthorized' response for Activejobs, redirecting to login page in 3 seconds...");
                
            }
        }

    }

    function getFinishedJobs(targetGridObj) {
        //deprecated; still there for "no proxy mode"
        $.ajax({
            url: build_new_api_url("/jobs"),
            type: "GET",
            crossDomain: true,
            dataType: "json",
            context: this,
            success: function(response) {

                addHistoryJobsToGrid(targetGridObj, response.history);
                mainLayout.cells("c").progressOff();
            },
            error: function(xhr, status) {
                dhtmlx.message("ERROR getting jobs, please check FFAStrans Path in Admin settings on the left..  ");

            }
        });
    }
    
    function build_new_api_url(what) {
        if (JSON.parse(m_serverconfig['STATIC_USE_PROXY_URL'])) {
            return "/new_proxy" + what;
        } else {
            var protocol = m_serverconfig.STATIC_WEBSERVER_ENABLE_HTTPS == "true" ? "https://" : "http://";
            var _url = protocol + m_serverconfig['STATIC_API_HOST'] + ":" + m_serverconfig['STATIC_API_NEW_PORT'] + what;
            return _url;
        }
    }

	function sortGridClick(){

	}

    async function sortGrid(whichGrid, src_element_id, force_order) {
		// let e = new Error();
        // console.log("sortgrid",e.stack)
        src_element = document.getElementById(src_element_id);
        src_element_sorticon = document.getElementById(src_element_id + "-sorticon");
        //remove sort icons from all
        $('i[name="'+whichGrid+"-sorticon"+'"]').removeClass("up-arrow");
        $('i[name="'+whichGrid+"-sorticon"+'"]').removeClass("down-arrow");
        
	   //re-enable all disabled sorticons
	    if (document.getElementById(src_element_id+"-sorticon-dis")){
			$("div[id$='sorticon-dis']").attr('hidden', false);
			//hide only the sorticon of interest
			$('div[id$="'+src_element_id+"-sorticon-dis"+'"]').attr('hidden', true);
			console.log("disable",src_element_id+"-sorticon-dis");
		}
        if (!src_element) {
            console.error("Error in sorting, finding element with id: " + src_element, src_element_id)
            return;
        }
        var whichColumn = src_element.getAttribute("name");
        var tree = $('#treetable_active').fancytree('getTree');
        if (whichGrid != "treetable_active") {
            tree = $('#treetable_history').fancytree('getTree');
        }else{
            var breakhere = 1;
        }

        if (!force_order) {
            //manual interaction, reverse current sort order
            if (src_element.dataset["sort_dir"] == "asc") {
                src_element.dataset["sort_dir"] = "des";
                $('i[id="'+src_element_id+"-sorticon"+'"]').addClass("down-arrow");
            } else {
                src_element.dataset["sort_dir"] = "asc";
                $('i[id="'+src_element_id+"-sorticon"+'"]').addClass("up-arrow");
            }
        } else {
            //force_order is only set when the order is automatically restored at page load, no need to reverse the sorting dir
            src_element.dataset["sort_dir"] = force_order
            if (force_order == "asc"){
                src_element.dataset["sort_dir"] = "asc";
                $('i[id="'+src_element_id+"-sorticon"+'"]').addClass("up-arrow");
            }else{
                src_element.dataset["sort_dir"] = "des";
                $('i[id="'+src_element_id+"-sorticon"+'"]').addClass("down-arrow");
            }
        }
        //remember the sorting
        m_lastsortelementid[whichGrid] = src_element_id;
        m_lastsortdir[whichGrid] = src_element.dataset["sort_dir"];
        
		if (whichGrid == "treetable_active"){
			//apply the sorting
			tree.getRootNode().sortChildren(function(a, b) {
				if (src_element.dataset["sort_dir"] == "asc") {
					return (a.data[whichColumn] + "").localeCompare(b.data[whichColumn])
				} else {
					return (b.data[whichColumn] + "").localeCompare(a.data[whichColumn])
				}
			}, true);
		}else{
			//need to reload history grid from db
			var tree = $('#treetable_history').fancytree('getTree');
            var sorting_changed = tree.mystuff.sortcol != whichColumn || tree.mystuff.sortdir != src_element.dataset["sort_dir"];
			tree.mystuff.sortcol = whichColumn;
			tree.mystuff.sortdir = src_element.dataset["sort_dir"];

            //complete reload should only be done in certain cases as it destroys current userinteraction e.g. selectedrow
            if (sorting_changed){ 
                console.log("sorting detected new sort config:",
                    {"whichCol":whichColumn,"tree.mystuff":tree.mystuff, "src_element.dataset":src_element.dataset}
                )
                await tree.reload({
                    url: "/gethistoryjobsajax_treegrid?sortcol="+tree.mystuff.sortcol+"&direction="+tree.mystuff.sortdir+"&count="+m_max_history_gridrows+"&filterobj=" + JSON.stringify(tree.mystuff.filterobj),
                    cache: false
                });
                console.log("tree was reloaded because sorting changed");
            }
		}
        
        //console.log("storing localstorage",JSON.stringify(m_lastsortelementid))
        localStorage.setItem("m_lastsortelementid", JSON.stringify(m_lastsortelementid));
        localStorage.setItem("m_lastsortdir", JSON.stringify(m_lastsortdir));
    }

        
    function clearSelection() {
    //used for clearing all unwanted browser text selections
        if(document.selection && document.selection.empty) {
            document.selection.empty();
        } else if(window.getSelection) {
            var sel = window.getSelection();
            sel.removeAllRanges();
        }
    }
    
        
    function parse_query_string(query) {
      var vars = query.split("&");
      var query_string = {};
      for (var i = 0; i < vars.length; i++) {
        var pair = vars[i].split("=");
        var key = decodeURIComponent(pair[0]);
        var value = decodeURIComponent(pair[1]);
        // If first entry with this name
        if (typeof query_string[key] === "undefined") {
          query_string[key] = decodeURIComponent(value);
          // If second entry with this name
        } else if (typeof query_string[key] === "string") {
          var arr = [query_string[key], decodeURIComponent(value)];
          query_string[key] = arr;
          // If third or later entry with this name
        } else {
          query_string[key].push(decodeURIComponent(value));
        }
      }
      return query_string;
    }
    
                   
    function decodeEntities(encodedString) {
        var translate_re = /&(nbsp|amp|quot|lt|gt);/g;
        var translate = {
            "nbsp":" ",
            "amp" : "&",
            "quot": "\"",
            "lt"  : "<",
            "gt"  : ">"
        };
        return encodedString.replace(translate_re, function(match, entity) {
            return translate[entity];
        }).replace(/&#(\d+);/gi, function(match, numStr) {
            var num = parseInt(numStr, 10);
            return String.fromCharCode(num);
        });
    }

    function wokrflow_tree_control(what){
        var tree = $("#workflowtree").fancytree('getTree');
        if (what.id == "wf_filter_clear"){
            tree.selectAll(false);
        }
        if (what.id == "wf_filter_unexpand"){
            
        }
        if (what.id == "wf_filter_clear"){
            
        }
    }
</script>

<body onload="loadserverconfig()">

    <div style="display:none">
        <!-- global hiding div prevents showing raw tables before dhtmlx layout attaches the template divs -->
        <!-- THIS DIV CONTAINS THE FINISHED JOBGRID FANCYTREE TEMPLATE -->
        <div id="active_div" style="" class="gridbox_dhx_skyblue gridbox">
            <table id="treetable_active" class="obj">
                <colgroup id="colgroup_active" >
                    <col width="5%" ></col>
                    <col width="10%"></col>
                    <col width="5%"></col>
                    <col width="10%"></col>
                    <col width="10%"></col>
                    <col width="10%"></col>
                    <col width="10%"></col>
                </colgroup>
                <thead class="dhtmlxMenu_dhx_skyblue_Middle sticky" style="border:none">
                    <tr id="tr_treetable_active">
                        <th id="active-state" name="state" onclick="sortGrid('treetable_active',this.id)" data-sort_dir="" >        <div style="display:flex;margin-left:15px"><i id="active-state-sorticon" name="treetable_active-sorticon" ></i> 	<div>&nbsp;State</div>		</div></th>
                        <th id="active-workflow" name="workflow" onclick="sortGrid('treetable_active',this.id)" data-sort_dir="">   <div style="display:flex;margin-left:15px"><i id="active-workflow-sorticon" name="treetable_active-sorticon" ></i> <div>&nbsp;Workflow</div>	</div></th>
                        <th id="active-job_start" name="job_start" onclick="sortGrid('treetable_active',this.id)" data-sort_dir=""> <div style="display:flex;margin-left:15px"><i id="active-job_start-sorticon" name="treetable_active-sorticon" ></i><div>&nbsp;Start</div>		</div></th>
                        <th id="active-file" name="file" onclick="sortGrid('treetable_active',this.id)" data-sort_dir="">           <div style="display:flex;margin-left:15px"><i id="active-file-sorticon" name="treetable_active-sorticon" ></i>		<div>&nbsp;Source</div>	</div></th>
                        <th id="active-proc" name="proc" onclick="sortGrid('treetable_active',this.id)" data-sort_dir="">           <div style="display:flex;margin-left:15px"><i id="active-proc-sorticon" name="treetable_active-sorticon" ></i><div>&nbsp;Step</div>	</div></th>
                        <th id="active-status" name="status" onclick="sortGrid('treetable_active',this.id)" data-sort_dir="">       <div style="display:flex;margin-left:15px"><i id="active-status-sorticon" name="treetable_active-sorticon" ></i>	<div>&nbsp;Status</div>		</div></th>
                        <th id="active-progress" name="progress" onclick="sortGrid('treetable_active',this.id)" data-sort_dir="">   <div style="display:flex;margin-left:15px"><i id="active-progress-sorticon" name="treetable_active-sorticon" ></i> <div>&nbsp;Progress</div>	</div></th>
                    </tr>
                </thead>
            </table>
        </div>

        <!-- height calc solution was the only way i found to have pagination and history div in same grid layout cell, todo: move on to dhx8 layout and put the 2 in separate layout cells -->
         <div id="history_div_container" style=""> 
            <div id="history_div" class="history_div" style="height: calc(100% - 38px)"></div> 
            <div id="pagination" >
                 <div id="data-container"></div>
                 <div id="pagination-container" class="dhx_cell_hdr" style="font-weight: normal !important;padding:5px;font-family:Tahoma !important;font-size:12px !important"></div>
             </div>
        </div>
            <!--<div id="table_container" style="overflow-y:scroll;" class="gridbox_dhx_skyblue gridbox">
                <table id="treetable_history" class="obj">
                    <colgroup id="colgroup_history">
                        <col width="5%"></col>
                        <col width="10%"></col>
                        <col width="10%"></col>
                        <col width="10%"></col>
                        <col width="10%"></col>
                        <col width="30%"></col>
                    </colgroup>
                    <thead class="sticky dhtmlxMenu_dhx_skyblue_Middle" style="position: sticky;top: 0;border:none">
                        <tr id="tr_treetable_history">
                            <th id="history-state" name="state" onclick="sortGrid('treetable_history',this.id)" data-sort_dir="">    		<div style="display:flex;margin-left:10px"><div id="history-state-sorticon-dis"><div class="up-arrow up-arrow-dis"> </div><div class="down-arrow down-arrow-dis"></div></div>  <i id="history-state-sorticon" name="treetable_history-sorticon"></i>        <input placeholder="State" style="width:90%;height:18px;margin-left:5px;margin-right:3px" type="search" name="search"  incremental autocomplete="off" />                     <img title="delete filters" style="display:none;width:15px;height:15px;margin-right:3px;margin-left:3px;cursor:pointer" src= "../images/remove-filter-icon-16.jpg"></img></div></th>
                            <th id="history-job_start" name="job_start" onclick="sortGrid('treetable_history',this.id)" data-sort_dir=""> 	<div style="display:flex;margin-left:10px"><div id="history-job_start-sorticon-dis"><div class="up-arrow up-arrow-dis"> </div><div class="down-arrow down-arrow-dis"></div></div><i id="history-job_start-sorticon" name="treetable_history-sorticon"></i>      <input placeholder="Start" style="width:90%;height:18px;margin-left:5px;margin-right:3px" type="search" name="search" incremental autocomplete="off" />		            <img title="delete filters" style="display:none;width:15px;height:15px;margin-right:3px;margin-left:3px;cursor:pointer" src= "../images/remove-filter-icon-16.jpg"></img></div></th>
                            <th id="history-wf_name" name="wf_name" onclick="sortGrid('treetable_history',this.id)" data-sort_dir="">       <div style="display:flex;margin-left:10px"><div id="history-wf_name-sorticon-dis"><div class="up-arrow up-arrow-dis"> </div><div class="down-arrow down-arrow-dis"></div></div><i id="history-wf_name-sorticon" name="treetable_history-sorticon"></i>        <input placeholder="Workflow" style="width:90%;height:18px;margin-left:5px;margin-right:5px;margin-right:3px" type="search" name="search" incremental autocomplete="off" /><img title="delete filters" style="display:none;width:15px;height:15px;margin-right:3px;margin-left:3px;cursor:pointer" src= "../images/remove-filter-icon-16.jpg"></img></div></th>
                            <th id="history-duration" name="duration" onclick="sortGrid('treetable_history',this.id)" data-sort_dir="">     <div style="display:flex;margin-left:10px"><div id="history-duration-sorticon-dis"><div class="up-arrow up-arrow-dis"> </div><div class="down-arrow down-arrow-dis"></div></div><i id="history-duration-sorticon" name="treetable_history-sorticon"></i>        <input placeholder="Duration" style="width:90%;height:18px;margin-left:5px;margin-right:3px" type="search" name="search" incremental autocomplete="off">		            <img title="delete filters" style="display:none;width:15px;height:15px;margin-right:3px;margin-left:3px;cursor:pointer" src= "../images/remove-filter-icon-16.jpg"></img></div></th>
                            <th id="history-job_end" name="job_end" onclick="sortGrid('treetable_history',this.id)" data-sort_dir="">       <div style="display:flex;margin-left:10px"><div id="history-job_end-sorticon-dis"><div class="up-arrow up-arrow-dis"> </div><div class="down-arrow down-arrow-dis"></div></div><i id="history-job_end-sorticon" name="treetable_history-sorticon"></i>        <input placeholder="End" style="width:90%;height:18px;margin-left:5px;margin-right:3px" type="search" name="search" incremental autocomplete="off" />			            <img title="delete filters" style="display:none;width:15px;height:15px;margin-right:3px;margin-left:3px;cursor:pointer" src= "../images/remove-filter-icon-16.jpg"></img></div></th>
                            <th id="history-file" name="file" onclick="sortGrid('treetable_history',this.id)" data-sort_dir="">             <div style="display:flex;margin-left:10px"><div id="history-file-sorticon-dis"><div class="up-arrow up-arrow-dis"> </div><div class="down-arrow down-arrow-dis"></div></div><i id="history-file-sorticon" name="treetable_history-sorticon"></i>           <input placeholder="File" style="width:90%;height:18px;margin-left:5px;margin-right:3px" type="search" name="search" incremental autocomplete="off" /> 		                <img title="delete filters" style="display:none;width:15px;height:15px;margin-right:3px;margin-left:3px;cursor:pointer" src= "../images/remove-filter-icon-16.jpg"></img></div></th>
                            <th id="history-outcome" name="outcome" onclick="sortGrid('treetable_history',this.id)" data-sort_dir="">       <div style="display:flex;margin-left:10px"><div id="history-outcome-sorticon-dis"><div class="up-arrow up-arrow-dis"> </div><div class="down-arrow down-arrow-dis"></div></div><i id="history-outcome-sorticon" name="treetable_history-sorticon"></i>        <input placeholder="Outcome" style="width:90%;height:18px;margin-left:5px;margin-right:3px" type="search" name="search" incremental autocomplete="off" />		            <img title="delete filters" style="display:none;width:15px;height:15px;margin-right:3px;margin-left:3px;cursor:pointer" src= "../images/remove-filter-icon-16.jpg"></img></div></th>
                            
                        </tr>
                    </thead>
                </table>
            </div>
            
        </div> -->

         <!-- WORKFLOW FILTER TEMPLATE -->
        <div id="workflow_filter_menu" class="workflow_filter_background">
            <div class='dhtmlxMenu_dhx_skyblue_Middle workflow_filter_menu_item' style='display:flex;width:100% ;height:40px;'>
                <!-- <button title="Expand all Folders"    name="expand_wf"    class="workflow_filter_menu_item" onclick="wokrflow_tree_control(this)" id="wf_filter_expand" style='margin-left:5px;font-size: 7px;'> <i class="fas fa-plus"></i></button> -->
                <!-- <button title="Collapse all Folders"  name="collapse_wf"  class="workflow_filter_menu_item" onclick="wokrflow_tree_control(this)" id="wf_filter_unexpand" style='font-size: 7px;'> <i class="fas fa-minus"></i></button> -->
                <div style="float:left;display:block;margin-top:5px;margin-left:5px">
                    <button title="Delete Selection (Show all Workflows)" name="delete_selected" class="workflow_filter_menu_item" style="width:25px;height:25px;font-size:10px;margin-top:3px" onclick="wokrflow_tree_control(this)" id="wf_filter_clear" > 
                        <i class="fas fa-ban" ></i>
                    </button>
                    </div>
                <div style="float:left;margin-top:10px;margin-left:10px;display:flex;max-width:180px;white-space:nowrap;overflow:hidden">
                    <input name='wf_filter' class="workflow_filter_menu_item" style='float:left;max-width:150px;height:20px;' id='wf_filter' autocomplete='off'></input> 
                
                </div>
           </div> 
            <div id='workflowtree' style='margin-left:10px;margin-top:10px;margin-bottom:40px'/>
        </div>
        
        
    </div><!-- global hiding div -->
    
    <!-- html code to be loaded by javascript into dhtmlx cells. This is not directly shown on the page but loaded as a template on demand -->
    <div style="display:none" id="dhtmlx attachObject Templates">

    </div>
</body>
