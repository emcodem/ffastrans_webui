<html>
<head>
<link rel="stylesheet" href="/alternate-server/css/override.css"/>
<link rel="stylesheet" href="../dependencies/dhtmlx/8.0.0/suite.css" type="text/css"/> 
<link rel="stylesheet" href="../dependencies/dhtmlx/dhtmlx.css" type="text/css"/> 
<script src="../dependencies/dhtmlx/8.0.0/suite.js"></script>
<script src="../dependencies/jquery/jquery.js"></script>


<style>
    /* it's important to set width/height to 100% for full-screen init */
    html, body {
        width: 100%;
        height: 100%;
        margin: 0px;
        overflow: hidden;
    }

	.testcss > .dhx_button {
		background-color: #e0e0e0;
		color:black;
		text-transform: none;
	}
	.dhxform_obj_dhx_skyblue > button :hover {
		background: linear-gradient(#cb1d1d, #000000);
		
	}
</style>

<script>

/* GLOBALS */
var m_mainLayout,m_mainForm, m_serverconfig;
/* build basic page layout and init periodic job loading*/
function init(){
    
	buildForm()
	//registerButtonClicks();

}

function buildForm(){
	const config = {
        //type: "wide",//"line" | "wide" | "space" | "none";
		width:"100%", height:"100%",rows:
		[
			{
				cols: [
					{
						id: "formcell",
						resizable:true,
						padding: "0px",  
						margin: "0px",
					}]
			}
		]
	}


    //LAYOUT
    m_mainLayout = new dhx.Layout(document.body, config);
	const today_start = new Date().setHours(0,0,0);
	const today_end   = new Date();
	
	var formconfig = {
    
    // sets alignment for rows
    align: "start", // "center", "end", "between", "around", "evenly"
    padding: "20px",   
	height: "100%",
    rows: [
        {
				padding: "10px", 
				// sets alignment for columns
				align: "center",  // "center", "end", "between", "around", "evenly"
				rows:[
					{cols: [
							{type: "datepicker", timePicker: true,range: true, value: [today_start], name: "db_start_date", label: "Date Start", dateFormat: "%Y-%m-%d %H:%i:%s"},
							{type: "datepicker", timePicker: true,range: true, value: [today_end], name: "db_end_date", label: "Date End", dateFormat: "%Y-%m-%d %H:%i:%s"},   
					]},
					{cols: [
							{type:"button", css:"dhxform_obj_dhx_skyblue", id:"btn_export_history","hidden":false,name: "btn_export_history", width:100,value:"Export"},
							{type:"button", css:"dhxform_obj_dhx_skyblue", id:"btn_purge_history","hidden":false,name: "btn_purge_history", width:100,value:"Delete"},
					]}
				],
			
			}
		]
	}
	m_mainForm = new dhx.Form(null, formconfig);
	m_mainLayout.getCell("formcell").attach(m_mainForm);
	m_mainForm.events.on("click", function(name,e){
		if(name == "btn_export_history")
			do_export();
		if(name == "btn_purge_history")
			do_purge();
	});	
}

function do_validate(){
	var values = m_mainForm.getValue()
	
	if(values.db_start_date > values.db_end_date){
		dhx.alert({
			header:"Date error",
			text:"Start date must be older than end date",
			buttons: ["ok"],
			buttonsAlignment:"center"
		});
		return false;
	}
	return true;
}
function do_export(){
	var values = m_mainForm.getValue()
	do_validate();
}

function do_purge(){
	var values = m_mainForm.getValue()
	do_validate();
	
}

function loadserverconfig() {
	
	$.ajax({
		url: ("/getserverconfig" + "?" + Math.random()),
		type: "GET",
		success: function(response) {
			console.log("got server conf")
			m_serverconfig = JSON.parse(response);
			console.log("SERVERCONFIG:",m_serverconfig)
			init();
		},
		error: function(xhr, status) {
			dhtmlx.message("Fatal error, could not load serverconfig. ");
			document.body.innerHTML = "Fatal error, could not load serverconfig. " + xhr.responseText;
		}
	});
}



function testConfig(){
	console.log("starting test");
    var o_testmail = {};
    o_testmail["test_rcpt"] = document.getElementById("test_rcpt").value;
    o_testmail["test_subject"] = document.getElementById("test_subject").value;
	o_testmail["test_body"] = document.getElementById("test_body").value;
	
	document.getElementById("testresult").innerHTML = "Loading... if this does not finish in <1 second, you most likely have DNS problems resolving your domain fqdn\nYou can wait for the 60 second timeout if you like to tough... It should say ETIMEDOUT\nIn that case, ping the FQDN you entered and resolve the problems";
	$.ajax({
		url: ("/admin_alert_email_tester" + "?" + Math.random()),
		type: "POST",
		data: o_testmail,
		success: function(response) {
			console.log("TEST OK",response);
			try{
				response= JSON.parse(response);
				response = JSON.stringify(response, undefined, 2);
			}catch(ex){
			
			}
			document.getElementById("testresult").innerHTML = response;
			
		},
		error: function(xhr, status) {
			console.log("TEST FAIL");
			document.getElementById("testresult").innerHTML = xhr.responseText;
		}
	});
}



/* */

</script>

</head>
<body onload="loadserverconfig()" style="overflow:auto">

</body>