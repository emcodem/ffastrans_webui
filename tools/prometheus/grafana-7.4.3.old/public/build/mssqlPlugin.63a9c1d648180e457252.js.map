{"version":3,"sources":["webpack:///./public/app/features/datasources/utils/passwordHandlers.ts","webpack:///./public/app/plugins/datasource/mssql/response_parser.ts","webpack:///./public/app/plugins/datasource/mssql/datasource.ts","webpack:///./public/app/plugins/datasource/mssql/query_ctrl.ts","webpack:///./public/app/plugins/datasource/mssql/config_ctrl.ts","webpack:///./public/app/plugins/datasource/mssql/module.ts"],"names":["PasswordFieldEnum","createResetHandler","ctrl","field","event","preventDefault","current","undefined","secureJsonFields","secureJsonData","createChangeHandler","currentTarget","value","ResponseParser","res","data","results","key","queryRes","series","push","target","name","datapoints","points","refId","meta","tables","table","type","length","rowCount","columns","rows","textColIndex","this","findColIndex","valueColIndex","transformToKeyValueList","transformToSimpleList","i","containsKey","text","j","unique","Array","from","Set","_","map","colName","options","annotation","timeColumnIndex","timeEndColumnIndex","textColumnIndex","tagsColumnIndex","Promise","reject","message","list","row","timeEnd","Math","floor","time","tags","trim","split","MssqlDatasource","instanceSettings","templateSrv","getTemplateSrv","timeSrv","getTimeSrv","id","responseParser","interval","jsonData","timeInterval","variable","multi","includeAll","replace","val","join","queries","scopedVars","expandedQueries","query","datasource","rawSql","interpolateVariable","rawQuery","filter","targets","item","hide","intervalMs","maxDataPoints","datasourceId","format","of","getBackendSrv","fetch","url","method","range","valueOf","toString","to","pipe","processQueryResult","transformAnnotationResponse","toPromise","optionalOptions","interpolatedQuery","timeRange","parseMetricFindQueryResult","mapTo","status","catchError","err","console","error","variableExists","MssqlQueryCtrl","$scope","$injector","alias","formats","panelCtrl","panel","events","on","PanelEvents","dataReceived","onDataReceived","bind","dataError","onDataError","dataList","lastQueryError","lastQueryMeta","QueryCtrl","templateUrl","MssqlConfigCtrl","encrypt","authenticationType","onPasswordReset","Password","onPasswordChange","showUserCredentials","user","password","MssqlAnnotationsQueryCtrl"],"mappings":"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","file":"mssqlPlugin.63a9c1d648180e457252.js","sourcesContent":["/**\n * Set of handlers for secure password field in Angular components. They handle backward compatibility with\n * passwords stored in plain text fields.\n */\n\nimport { SyntheticEvent } from 'react';\n\nexport enum PasswordFieldEnum {\n  Password = 'password',\n  BasicAuthPassword = 'basicAuthPassword',\n}\n\n/**\n * Basic shape for settings controllers in at the moment mostly angular datasource plugins.\n */\nexport type Ctrl = {\n  current: {\n    secureJsonFields: {\n      [key: string]: boolean;\n    };\n    secureJsonData?: {\n      [key: string]: string;\n    };\n    password?: string;\n    basicAuthPassword?: string;\n  };\n};\n\nexport const createResetHandler = (ctrl: Ctrl, field: PasswordFieldEnum) => (\n  event: SyntheticEvent<HTMLInputElement>\n) => {\n  event.preventDefault();\n  // Reset also normal plain text password to remove it and only save it in secureJsonData.\n  ctrl.current[field] = undefined;\n  ctrl.current.secureJsonFields[field] = false;\n  ctrl.current.secureJsonData = ctrl.current.secureJsonData || {};\n  ctrl.current.secureJsonData[field] = '';\n};\n\nexport const createChangeHandler = (ctrl: any, field: PasswordFieldEnum) => (\n  event: SyntheticEvent<HTMLInputElement>\n) => {\n  ctrl.current.secureJsonData = ctrl.current.secureJsonData || {};\n  ctrl.current.secureJsonData[field] = event.currentTarget.value;\n};\n","import _ from 'lodash';\nimport { MetricFindValue } from '@grafana/data';\n\ninterface TableResponse extends Record<string, any> {\n  type: string;\n  refId: string;\n  meta: any;\n}\n\ninterface SeriesResponse extends Record<string, any> {\n  target: string;\n  refId: string;\n  meta: any;\n  datapoints: [any[]];\n}\n\nexport interface MssqlResponse {\n  data: Array<TableResponse | SeriesResponse>;\n}\n\nexport default class ResponseParser {\n  processQueryResult(res: any): MssqlResponse {\n    const data: any[] = [];\n\n    if (!res.data.results) {\n      return { data };\n    }\n\n    for (const key in res.data.results) {\n      const queryRes = res.data.results[key];\n\n      if (queryRes.series) {\n        for (const series of queryRes.series) {\n          data.push({\n            target: series.name,\n            datapoints: series.points,\n            refId: queryRes.refId,\n            meta: queryRes.meta,\n          });\n        }\n      }\n\n      if (queryRes.tables) {\n        for (const table of queryRes.tables) {\n          table.type = 'table';\n          table.refId = queryRes.refId;\n          table.meta = queryRes.meta;\n          data.push(table);\n        }\n      }\n    }\n\n    return { data: data };\n  }\n\n  parseMetricFindQueryResult(refId: string, results: any): MetricFindValue[] {\n    if (!results || results.data.length === 0 || results.data.results[refId].meta.rowCount === 0) {\n      return [];\n    }\n\n    const columns = results.data.results[refId].tables[0].columns;\n    const rows = results.data.results[refId].tables[0].rows;\n    const textColIndex = this.findColIndex(columns, '__text');\n    const valueColIndex = this.findColIndex(columns, '__value');\n\n    if (columns.length === 2 && textColIndex !== -1 && valueColIndex !== -1) {\n      return this.transformToKeyValueList(rows, textColIndex, valueColIndex);\n    }\n\n    return this.transformToSimpleList(rows);\n  }\n\n  transformToKeyValueList(rows: any, textColIndex: number, valueColIndex: number): MetricFindValue[] {\n    const res = [];\n\n    for (let i = 0; i < rows.length; i++) {\n      if (!this.containsKey(res, rows[i][textColIndex])) {\n        res.push({ text: rows[i][textColIndex], value: rows[i][valueColIndex] });\n      }\n    }\n\n    return res;\n  }\n\n  transformToSimpleList(rows: any): MetricFindValue[] {\n    const res = [];\n\n    for (let i = 0; i < rows.length; i++) {\n      for (let j = 0; j < rows[i].length; j++) {\n        res.push(rows[i][j]);\n      }\n    }\n\n    const unique = Array.from(new Set(res));\n\n    return _.map(unique, (value) => {\n      return { text: value };\n    });\n  }\n\n  findColIndex(columns: any[], colName: string) {\n    for (let i = 0; i < columns.length; i++) {\n      if (columns[i].text === colName) {\n        return i;\n      }\n    }\n\n    return -1;\n  }\n\n  containsKey(res: any[], key: any) {\n    for (let i = 0; i < res.length; i++) {\n      if (res[i].text === key) {\n        return true;\n      }\n    }\n    return false;\n  }\n\n  transformAnnotationResponse(options: any, data: any) {\n    const table = data.data.results[options.annotation.name].tables[0];\n\n    let timeColumnIndex = -1;\n    let timeEndColumnIndex = -1;\n    let textColumnIndex = -1;\n    let tagsColumnIndex = -1;\n\n    for (let i = 0; i < table.columns.length; i++) {\n      if (table.columns[i].text === 'time') {\n        timeColumnIndex = i;\n      } else if (table.columns[i].text === 'timeend') {\n        timeEndColumnIndex = i;\n      } else if (table.columns[i].text === 'text') {\n        textColumnIndex = i;\n      } else if (table.columns[i].text === 'tags') {\n        tagsColumnIndex = i;\n      }\n    }\n\n    if (timeColumnIndex === -1) {\n      return Promise.reject({ message: 'Missing mandatory time column (with time column alias) in annotation query.' });\n    }\n\n    const list = [];\n    for (let i = 0; i < table.rows.length; i++) {\n      const row = table.rows[i];\n      const timeEnd =\n        timeEndColumnIndex !== -1 && row[timeEndColumnIndex] ? Math.floor(row[timeEndColumnIndex]) : undefined;\n      list.push({\n        annotation: options.annotation,\n        time: Math.floor(row[timeColumnIndex]),\n        timeEnd,\n        text: row[textColumnIndex],\n        tags: row[tagsColumnIndex] ? row[tagsColumnIndex].trim().split(/\\s*,\\s*/) : [],\n      });\n    }\n\n    return list;\n  }\n}\n","import _ from 'lodash';\nimport { Observable, of } from 'rxjs';\nimport { catchError, map, mapTo } from 'rxjs/operators';\nimport { getBackendSrv } from '@grafana/runtime';\nimport { ScopedVars } from '@grafana/data';\n\nimport ResponseParser, { MssqlResponse } from './response_parser';\nimport { getTemplateSrv, TemplateSrv } from 'app/features/templating/template_srv';\nimport { getTimeSrv, TimeSrv } from 'app/features/dashboard/services/TimeSrv';\nimport { MssqlQueryForInterpolation } from './types';\n\nexport class MssqlDatasource {\n  id: any;\n  name: any;\n  responseParser: ResponseParser;\n  interval: string;\n\n  constructor(\n    instanceSettings: any,\n    private readonly templateSrv: TemplateSrv = getTemplateSrv(),\n    private readonly timeSrv: TimeSrv = getTimeSrv()\n  ) {\n    this.name = instanceSettings.name;\n    this.id = instanceSettings.id;\n    this.responseParser = new ResponseParser();\n    this.interval = (instanceSettings.jsonData || {}).timeInterval || '1m';\n  }\n\n  interpolateVariable(value: any, variable: any) {\n    if (typeof value === 'string') {\n      if (variable.multi || variable.includeAll) {\n        return \"'\" + value.replace(/'/g, `''`) + \"'\";\n      } else {\n        return value;\n      }\n    }\n\n    if (typeof value === 'number') {\n      return value;\n    }\n\n    const quotedValues = _.map(value, (val) => {\n      if (typeof value === 'number') {\n        return value;\n      }\n\n      return \"'\" + val.replace(/'/g, `''`) + \"'\";\n    });\n    return quotedValues.join(',');\n  }\n\n  interpolateVariablesInQueries(\n    queries: MssqlQueryForInterpolation[],\n    scopedVars: ScopedVars\n  ): MssqlQueryForInterpolation[] {\n    let expandedQueries = queries;\n    if (queries && queries.length > 0) {\n      expandedQueries = queries.map((query) => {\n        const expandedQuery = {\n          ...query,\n          datasource: this.name,\n          rawSql: this.templateSrv.replace(query.rawSql, scopedVars, this.interpolateVariable),\n          rawQuery: true,\n        };\n        return expandedQuery;\n      });\n    }\n    return expandedQueries;\n  }\n\n  query(options: any): Observable<MssqlResponse> {\n    const queries = _.filter(options.targets, (item) => {\n      return item.hide !== true;\n    }).map((item) => {\n      return {\n        refId: item.refId,\n        intervalMs: options.intervalMs,\n        maxDataPoints: options.maxDataPoints,\n        datasourceId: this.id,\n        rawSql: this.templateSrv.replace(item.rawSql, options.scopedVars, this.interpolateVariable),\n        format: item.format,\n      };\n    });\n\n    if (queries.length === 0) {\n      return of({ data: [] });\n    }\n\n    return getBackendSrv()\n      .fetch({\n        url: '/api/tsdb/query',\n        method: 'POST',\n        data: {\n          from: options.range.from.valueOf().toString(),\n          to: options.range.to.valueOf().toString(),\n          queries: queries,\n        },\n      })\n      .pipe(map(this.responseParser.processQueryResult));\n  }\n\n  annotationQuery(options: any) {\n    if (!options.annotation.rawQuery) {\n      return Promise.reject({ message: 'Query missing in annotation definition' });\n    }\n\n    const query = {\n      refId: options.annotation.name,\n      datasourceId: this.id,\n      rawSql: this.templateSrv.replace(options.annotation.rawQuery, options.scopedVars, this.interpolateVariable),\n      format: 'table',\n    };\n\n    return getBackendSrv()\n      .fetch({\n        url: '/api/tsdb/query',\n        method: 'POST',\n        data: {\n          from: options.range.from.valueOf().toString(),\n          to: options.range.to.valueOf().toString(),\n          queries: [query],\n        },\n      })\n      .pipe(map((data: any) => this.responseParser.transformAnnotationResponse(options, data)))\n      .toPromise();\n  }\n\n  metricFindQuery(query: string, optionalOptions: { variable: { name: string } }) {\n    let refId = 'tempvar';\n    if (optionalOptions && optionalOptions.variable && optionalOptions.variable.name) {\n      refId = optionalOptions.variable.name;\n    }\n\n    const interpolatedQuery = {\n      refId: refId,\n      datasourceId: this.id,\n      rawSql: this.templateSrv.replace(query, {}, this.interpolateVariable),\n      format: 'table',\n    };\n\n    const range = this.timeSrv.timeRange();\n    const data = {\n      queries: [interpolatedQuery],\n      from: range.from.valueOf().toString(),\n      to: range.to.valueOf().toString(),\n    };\n\n    return getBackendSrv()\n      .fetch({\n        url: '/api/tsdb/query',\n        method: 'POST',\n        data: data,\n      })\n      .pipe(map((data: any) => this.responseParser.parseMetricFindQueryResult(refId, data)))\n      .toPromise();\n  }\n\n  testDatasource() {\n    return getBackendSrv()\n      .fetch({\n        url: '/api/tsdb/query',\n        method: 'POST',\n        data: {\n          from: '5m',\n          to: 'now',\n          queries: [\n            {\n              refId: 'A',\n              intervalMs: 1,\n              maxDataPoints: 1,\n              datasourceId: this.id,\n              rawSql: 'SELECT 1',\n              format: 'table',\n            },\n          ],\n        },\n      })\n      .pipe(\n        mapTo({ status: 'success', message: 'Database Connection OK' }),\n        catchError((err) => {\n          console.error(err);\n          if (err.data && err.data.message) {\n            return of({ status: 'error', message: err.data.message });\n          }\n\n          return of({ status: 'error', message: err.status });\n        })\n      )\n      .toPromise();\n  }\n\n  targetContainsTemplate(target: any) {\n    const rawSql = target.rawSql.replace('$__', '');\n    return this.templateSrv.variableExists(rawSql);\n  }\n}\n","import _ from 'lodash';\nimport { QueryCtrl } from 'app/plugins/sdk';\nimport { auto } from 'angular';\nimport { PanelEvents, QueryResultMeta } from '@grafana/data';\n\nexport interface MssqlQuery {\n  refId: string;\n  format: string;\n  alias: string;\n  rawSql: string;\n}\n\nconst defaultQuery = `SELECT\n  $__timeEpoch(<time_column>),\n  <value column> as value,\n  <series name column> as metric\nFROM\n  <table name>\nWHERE\n  $__timeFilter(time_column)\nORDER BY\n  <time_column> ASC`;\n\nexport class MssqlQueryCtrl extends QueryCtrl {\n  static templateUrl = 'partials/query.editor.html';\n\n  formats: any[];\n  target: MssqlQuery;\n  lastQueryMeta?: QueryResultMeta;\n  lastQueryError?: string;\n  showHelp: boolean;\n\n  /** @ngInject */\n  constructor($scope: any, $injector: auto.IInjectorService) {\n    super($scope, $injector);\n\n    this.target.format = this.target.format || 'time_series';\n    this.target.alias = '';\n    this.formats = [\n      { text: 'Time series', value: 'time_series' },\n      { text: 'Table', value: 'table' },\n    ];\n\n    if (!this.target.rawSql) {\n      // special handling when in table panel\n      if (this.panelCtrl.panel.type === 'table') {\n        this.target.format = 'table';\n        this.target.rawSql = 'SELECT 1';\n      } else {\n        this.target.rawSql = defaultQuery;\n      }\n    }\n\n    this.panelCtrl.events.on(PanelEvents.dataReceived, this.onDataReceived.bind(this), $scope);\n    this.panelCtrl.events.on(PanelEvents.dataError, this.onDataError.bind(this), $scope);\n  }\n\n  onDataReceived(dataList: any) {\n    this.lastQueryError = undefined;\n    this.lastQueryMeta = dataList[0]?.meta;\n  }\n\n  onDataError(err: any) {\n    if (err.data && err.data.results) {\n      const queryRes = err.data.results[this.target.refId];\n      if (queryRes) {\n        this.lastQueryError = queryRes.error;\n      }\n    }\n  }\n}\n","import {\n  createChangeHandler,\n  createResetHandler,\n  PasswordFieldEnum,\n} from '../../../features/datasources/utils/passwordHandlers';\n\nexport class MssqlConfigCtrl {\n  static templateUrl = 'partials/config.html';\n\n  current: any;\n  onPasswordReset: ReturnType<typeof createResetHandler>;\n  onPasswordChange: ReturnType<typeof createChangeHandler>;\n  showUserCredentials: boolean;\n\n  /** @ngInject */\n  constructor($scope: any) {\n    this.current.jsonData.encrypt = this.current.jsonData.encrypt || 'false';\n    this.current.jsonData.authenticationType = this.current.jsonData.authenticationType || 'SQL Server Authentication';\n    this.onPasswordReset = createResetHandler(this, PasswordFieldEnum.Password);\n    this.onPasswordChange = createChangeHandler(this, PasswordFieldEnum.Password);\n    this.showUserCredentials = this.current.jsonData.authenticationType !== 'Windows Authentication';\n  }\n\n  onAuthenticationTypeChange() {\n    // This is using the fallback in https://github.com/denisenkom/go-mssqldb to use Windows Auth if login/user id is empty.\n    if (this.current.jsonData.authenticationType === 'Windows Authentication') {\n      this.current.user = '';\n      this.current.password = '';\n    }\n\n    this.showUserCredentials = this.current.jsonData.authenticationType !== 'Windows Authentication';\n  }\n}\n","import { MssqlDatasource } from './datasource';\nimport { MssqlQueryCtrl } from './query_ctrl';\nimport { MssqlConfigCtrl } from './config_ctrl';\n\nconst defaultQuery = `SELECT\n    <time_column> as time,\n    <text_column> as text,\n    <tags_column> as tags\n  FROM\n    <table name>\n  WHERE\n    $__timeFilter(time_column)\n  ORDER BY\n    <time_column> ASC`;\n\nclass MssqlAnnotationsQueryCtrl {\n  static templateUrl = 'partials/annotations.editor.html';\n\n  annotation: any;\n\n  /** @ngInject */\n  constructor() {\n    this.annotation.rawQuery = this.annotation.rawQuery || defaultQuery;\n  }\n}\n\nexport {\n  MssqlDatasource,\n  MssqlDatasource as Datasource,\n  MssqlQueryCtrl as QueryCtrl,\n  MssqlConfigCtrl as ConfigCtrl,\n  MssqlAnnotationsQueryCtrl as AnnotationsQueryCtrl,\n};\n"],"sourceRoot":""}