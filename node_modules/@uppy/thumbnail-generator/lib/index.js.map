{"version":3,"names":["UIPlugin","dataURItoBlob","isObjectURL","isPreviewSupported","rotation","locale","packageJson","canvasToBlob","canvas","type","quality","getContext","getImageData","err","code","Promise","reject","Error","toBlob","resolve","then","blob","toDataURL","rotateImage","image","translate","w","width","h","height","deg","document","createElement","context","rotate","rad","scale","scaleX","scaleY","drawImage","protect","ratio","maxSquare","maxSize","maxW","Math","floor","sqrt","maxH","round","defaultOptions","thumbnailWidth","thumbnailHeight","thumbnailType","waitForThumbnailsBeforeUpload","lazy","ThumbnailGenerator","constructor","uppy","opts","onFileAdded","file","preview","data","isRemote","addToQueue","id","onCancelRequest","index","queue","indexOf","splice","onFileRemoved","URL","revokeObjectURL","onRestored","restoredFiles","getFiles","filter","isRestored","forEach","onAllFilesRemoved","waitUntilAllProcessed","fileIDs","fileID","getFile","emit","mode","message","i18n","emitPreprocessCompleteForAll","queueProcessing","once","title","defaultThumbnailDimension","defaultLocale","i18nInit","createThumbnail","targetWidth","targetHeight","originalUrl","createObjectURL","onload","Image","src","addEventListener","event","error","orientationPromise","catch","all","_ref","orientation","dimensions","getProportionalDimensions","rotatedImage","resizedImage","resizeImage","img","aspect","steps","ceil","log2","sW","sH","x","setPreviewURL","setFileState","push","processQueue","length","current","shift","log","requestThumbnail","install","on","addPreProcessor","uninstall","off","removePreProcessor","VERSION","version"],"sources":["index.ts"],"sourcesContent":["import { UIPlugin, Uppy, type UIPluginOptions } from '@uppy/core'\nimport dataURItoBlob from '@uppy/utils/lib/dataURItoBlob'\nimport isObjectURL from '@uppy/utils/lib/isObjectURL'\nimport isPreviewSupported from '@uppy/utils/lib/isPreviewSupported'\n// eslint-disable-next-line @typescript-eslint/ban-ts-comment\n// @ts-ignore untyped\nimport { rotation } from 'exifr/dist/mini.esm.mjs'\n\nimport type { DefinePluginOpts } from '@uppy/core/lib/BasePlugin.js'\nimport type { Body, Meta, UppyFile } from '@uppy/utils/lib/UppyFile'\nimport locale from './locale.ts'\n// eslint-disable-next-line @typescript-eslint/ban-ts-comment\n// @ts-ignore We don't want TS to generate types for the package.json\nimport packageJson from '../package.json'\n\ndeclare module '@uppy/core' {\n  // eslint-disable-next-line @typescript-eslint/no-unused-vars\n  export interface UppyEventMap<M extends Meta, B extends Body> {\n    'thumbnail:all-generated': () => void\n    'thumbnail:generated': (file: UppyFile<M, B>, preview: string) => void\n    'thumbnail:error': (file: UppyFile<M, B>, error: Error) => void\n    'thumbnail:request': (file: UppyFile<M, B>) => void\n    'thumbnail:cancel': (file: UppyFile<M, B>) => void\n  }\n}\n\ninterface Rotation {\n  deg: number\n  rad: number\n  scaleX: number\n  scaleY: number\n  dimensionSwapped: boolean\n  css: boolean\n  canvas: boolean\n}\n\n/**\n * Save a <canvas> element's content to a Blob object.\n *\n */\nfunction canvasToBlob(\n  canvas: HTMLCanvasElement,\n  type: string,\n  quality: number,\n): Promise<Blob | File> {\n  try {\n    canvas.getContext('2d')!.getImageData(0, 0, 1, 1)\n  } catch (err) {\n    if (err.code === 18) {\n      return Promise.reject(\n        new Error('cannot read image, probably an svg with external resources'),\n      )\n    }\n  }\n\n  if (canvas.toBlob) {\n    return new Promise<Blob | null>((resolve) => {\n      canvas.toBlob(resolve, type, quality)\n    }).then((blob) => {\n      if (blob === null) {\n        throw new Error(\n          'cannot read image, probably an svg with external resources',\n        )\n      }\n      return blob\n    })\n  }\n  return Promise.resolve()\n    .then(() => {\n      return dataURItoBlob(canvas.toDataURL(type, quality), {})\n    })\n    .then((blob) => {\n      if (blob === null) {\n        throw new Error('could not extract blob, probably an old browser')\n      }\n      return blob\n    })\n}\n\nfunction rotateImage(image: HTMLImageElement, translate: Rotation) {\n  let w = image.width\n  let h = image.height\n\n  if (translate.deg === 90 || translate.deg === 270) {\n    w = image.height\n    h = image.width\n  }\n\n  const canvas = document.createElement('canvas')\n  canvas.width = w\n  canvas.height = h\n\n  const context = canvas.getContext('2d')!\n  context.translate(w / 2, h / 2)\n  if (translate.canvas) {\n    context.rotate(translate.rad)\n    context.scale(translate.scaleX, translate.scaleY)\n  }\n  context.drawImage(\n    image,\n    -image.width / 2,\n    -image.height / 2,\n    image.width,\n    image.height,\n  )\n\n  return canvas\n}\n\n/**\n * Make sure the image doesnâ€™t exceed browser/device canvas limits.\n * For ios with 256 RAM and ie\n */\nfunction protect(image: HTMLCanvasElement): HTMLCanvasElement {\n  // https://stackoverflow.com/questions/6081483/maximum-size-of-a-canvas-element\n\n  const ratio = image.width / image.height\n\n  const maxSquare = 5000000 // ios max canvas square\n  const maxSize = 4096 // ie max canvas dimensions\n\n  let maxW = Math.floor(Math.sqrt(maxSquare * ratio))\n  let maxH = Math.floor(maxSquare / Math.sqrt(maxSquare * ratio))\n  if (maxW > maxSize) {\n    maxW = maxSize\n    maxH = Math.round(maxW / ratio)\n  }\n  if (maxH > maxSize) {\n    maxH = maxSize\n    maxW = Math.round(ratio * maxH)\n  }\n  if (image.width > maxW) {\n    const canvas = document.createElement('canvas')\n    canvas.width = maxW\n    canvas.height = maxH\n    canvas.getContext('2d')!.drawImage(image, 0, 0, maxW, maxH)\n    return canvas\n  }\n\n  return image\n}\n\nexport interface ThumbnailGeneratorOptions extends UIPluginOptions {\n  thumbnailWidth?: number | null\n  thumbnailHeight?: number | null\n  thumbnailType?: string\n  waitForThumbnailsBeforeUpload?: boolean\n  lazy?: boolean\n}\n\nconst defaultOptions = {\n  thumbnailWidth: null,\n  thumbnailHeight: null,\n  thumbnailType: 'image/jpeg',\n  waitForThumbnailsBeforeUpload: false,\n  lazy: false,\n}\n\ntype Opts = DefinePluginOpts<\n  ThumbnailGeneratorOptions,\n  keyof typeof defaultOptions\n>\n\n/**\n * The Thumbnail Generator plugin\n */\n\nexport default class ThumbnailGenerator<\n  M extends Meta,\n  B extends Body,\n> extends UIPlugin<Opts, M, B> {\n  static VERSION = packageJson.version\n\n  queue: string[]\n\n  queueProcessing: boolean\n\n  defaultThumbnailDimension: number\n\n  thumbnailType: string\n\n  constructor(uppy: Uppy<M, B>, opts?: ThumbnailGeneratorOptions) {\n    super(uppy, { ...defaultOptions, ...opts })\n    this.type = 'modifier'\n    this.id = this.opts.id || 'ThumbnailGenerator'\n    this.title = 'Thumbnail Generator'\n    this.queue = []\n    this.queueProcessing = false\n    this.defaultThumbnailDimension = 200\n    this.thumbnailType = this.opts.thumbnailType\n\n    this.defaultLocale = locale\n\n    this.i18nInit()\n\n    if (this.opts.lazy && this.opts.waitForThumbnailsBeforeUpload) {\n      throw new Error(\n        'ThumbnailGenerator: The `lazy` and `waitForThumbnailsBeforeUpload` options are mutually exclusive. Please ensure at most one of them is set to `true`.',\n      )\n    }\n  }\n\n  createThumbnail(\n    file: UppyFile<M, B>,\n    targetWidth: number | null,\n    targetHeight: number | null,\n  ): Promise<string> {\n    const originalUrl = URL.createObjectURL(file.data)\n\n    const onload = new Promise<HTMLImageElement>((resolve, reject) => {\n      const image = new Image()\n      image.src = originalUrl\n      image.addEventListener('load', () => {\n        URL.revokeObjectURL(originalUrl)\n        resolve(image)\n      })\n      image.addEventListener('error', (event) => {\n        URL.revokeObjectURL(originalUrl)\n        reject(event.error || new Error('Could not create thumbnail'))\n      })\n    })\n\n    const orientationPromise = rotation(file.data).catch(\n      () => 1,\n    ) as Promise<Rotation>\n\n    return Promise.all([onload, orientationPromise])\n      .then(([image, orientation]) => {\n        const dimensions = this.getProportionalDimensions(\n          image,\n          targetWidth,\n          targetHeight,\n          orientation.deg,\n        )\n        const rotatedImage = rotateImage(image, orientation)\n        const resizedImage = this.resizeImage(\n          rotatedImage,\n          dimensions.width,\n          dimensions.height,\n        )\n        return canvasToBlob(resizedImage, this.thumbnailType, 80)\n      })\n      .then((blob) => {\n        return URL.createObjectURL(blob)\n      })\n  }\n\n  /**\n   * Get the new calculated dimensions for the given image and a target width\n   * or height. If both width and height are given, only width is taken into\n   * account. If neither width nor height are given, the default dimension\n   * is used.\n   */\n  getProportionalDimensions(\n    img: HTMLImageElement,\n    width: number | null,\n    height: number | null,\n    deg: number,\n  ): { width: number; height: number } {\n    // eslint-disable-line no-shadow\n    let aspect = img.width / img.height\n    if (deg === 90 || deg === 270) {\n      aspect = img.height / img.width\n    }\n\n    if (width != null) {\n      return {\n        width,\n        height: Math.round(width / aspect),\n      }\n    }\n\n    if (height != null) {\n      return {\n        width: Math.round(height * aspect),\n        height,\n      }\n    }\n\n    return {\n      width: this.defaultThumbnailDimension,\n      height: Math.round(this.defaultThumbnailDimension / aspect),\n    }\n  }\n\n  /**\n   * Resize an image to the target `width` and `height`.\n   *\n   * Returns a Canvas with the resized image on it.\n   */\n  // eslint-disable-next-line class-methods-use-this\n  resizeImage(\n    image: HTMLCanvasElement,\n    targetWidth: number,\n    targetHeight: number,\n  ): HTMLCanvasElement {\n    // Resizing in steps refactored to use a solution from\n    // https://blog.uploadcare.com/image-resize-in-browsers-is-broken-e38eed08df01\n\n    let img = protect(image)\n\n    let steps = Math.ceil(Math.log2(img.width / targetWidth))\n    if (steps < 1) {\n      steps = 1\n    }\n    let sW = targetWidth * 2 ** (steps - 1)\n    let sH = targetHeight * 2 ** (steps - 1)\n    const x = 2\n\n    while (steps--) {\n      const canvas = document.createElement('canvas')\n      canvas.width = sW\n      canvas.height = sH\n      canvas.getContext('2d')!.drawImage(img, 0, 0, sW, sH)\n      img = canvas\n\n      sW = Math.round(sW / x)\n      sH = Math.round(sH / x)\n    }\n\n    return img\n  }\n\n  /**\n   * Set the preview URL for a file.\n   */\n  setPreviewURL(fileID: string, preview: string): void {\n    this.uppy.setFileState(fileID, { preview })\n  }\n\n  addToQueue(fileID: string): void {\n    this.queue.push(fileID)\n    if (this.queueProcessing === false) {\n      this.processQueue()\n    }\n  }\n\n  processQueue(): Promise<void> {\n    this.queueProcessing = true\n    if (this.queue.length > 0) {\n      const current = this.uppy.getFile(this.queue.shift() as string)\n      if (!current) {\n        this.uppy.log(\n          '[ThumbnailGenerator] file was removed before a thumbnail could be generated, but not removed from the queue. This is probably a bug',\n          'error',\n        )\n        return Promise.resolve()\n      }\n      return this.requestThumbnail(current)\n        .catch(() => {}) // eslint-disable-line node/handle-callback-err\n        .then(() => this.processQueue())\n    }\n    this.queueProcessing = false\n    this.uppy.log('[ThumbnailGenerator] Emptied thumbnail queue')\n    this.uppy.emit('thumbnail:all-generated')\n    return Promise.resolve()\n  }\n\n  requestThumbnail(file: UppyFile<M, B>): Promise<void> {\n    if (isPreviewSupported(file.type) && !file.isRemote) {\n      return this.createThumbnail(\n        file,\n        this.opts.thumbnailWidth,\n        this.opts.thumbnailHeight,\n      )\n        .then((preview) => {\n          this.setPreviewURL(file.id, preview)\n          this.uppy.log(\n            `[ThumbnailGenerator] Generated thumbnail for ${file.id}`,\n          )\n          this.uppy.emit(\n            'thumbnail:generated',\n            this.uppy.getFile(file.id),\n            preview,\n          )\n        })\n        .catch((err) => {\n          this.uppy.log(\n            `[ThumbnailGenerator] Failed thumbnail for ${file.id}:`,\n            'warning',\n          )\n          this.uppy.log(err, 'warning')\n          this.uppy.emit('thumbnail:error', this.uppy.getFile(file.id), err)\n        })\n    }\n    return Promise.resolve()\n  }\n\n  onFileAdded = (file: UppyFile<M, B>): void => {\n    if (\n      !file.preview &&\n      file.data &&\n      isPreviewSupported(file.type) &&\n      !file.isRemote\n    ) {\n      this.addToQueue(file.id)\n    }\n  }\n\n  /**\n   * Cancel a lazy request for a thumbnail if the thumbnail has not yet been generated.\n   */\n  onCancelRequest = (file: UppyFile<M, B>): void => {\n    const index = this.queue.indexOf(file.id)\n    if (index !== -1) {\n      this.queue.splice(index, 1)\n    }\n  }\n\n  /**\n   * Clean up the thumbnail for a file. Cancel lazy requests and free the thumbnail URL.\n   */\n  onFileRemoved = (file: UppyFile<M, B>): void => {\n    const index = this.queue.indexOf(file.id)\n    if (index !== -1) {\n      this.queue.splice(index, 1)\n    }\n\n    // Clean up object URLs.\n    if (file.preview && isObjectURL(file.preview)) {\n      URL.revokeObjectURL(file.preview)\n    }\n  }\n\n  onRestored = (): void => {\n    const restoredFiles = this.uppy.getFiles().filter((file) => file.isRestored)\n    restoredFiles.forEach((file) => {\n      // Only add blob URLs; they are likely invalid after being restored.\n      if (!file.preview || isObjectURL(file.preview)) {\n        this.addToQueue(file.id)\n      }\n    })\n  }\n\n  onAllFilesRemoved = (): void => {\n    this.queue = []\n  }\n\n  waitUntilAllProcessed = (fileIDs: string[]): Promise<void> => {\n    fileIDs.forEach((fileID) => {\n      const file = this.uppy.getFile(fileID)\n      this.uppy.emit('preprocess-progress', file, {\n        mode: 'indeterminate',\n        message: this.i18n('generatingThumbnails'),\n      })\n    })\n\n    const emitPreprocessCompleteForAll = () => {\n      fileIDs.forEach((fileID) => {\n        const file = this.uppy.getFile(fileID)\n        this.uppy.emit('preprocess-complete', file)\n      })\n    }\n\n    return new Promise((resolve) => {\n      if (this.queueProcessing) {\n        this.uppy.once('thumbnail:all-generated', () => {\n          emitPreprocessCompleteForAll()\n          resolve()\n        })\n      } else {\n        emitPreprocessCompleteForAll()\n        resolve()\n      }\n    })\n  }\n\n  install(): void {\n    this.uppy.on('file-removed', this.onFileRemoved)\n    this.uppy.on('cancel-all', this.onAllFilesRemoved)\n\n    if (this.opts.lazy) {\n      this.uppy.on('thumbnail:request', this.onFileAdded)\n      this.uppy.on('thumbnail:cancel', this.onCancelRequest)\n    } else {\n      this.uppy.on('thumbnail:request', this.onFileAdded)\n      this.uppy.on('file-added', this.onFileAdded)\n      this.uppy.on('restored', this.onRestored)\n    }\n\n    if (this.opts.waitForThumbnailsBeforeUpload) {\n      this.uppy.addPreProcessor(this.waitUntilAllProcessed)\n    }\n  }\n\n  uninstall(): void {\n    this.uppy.off('file-removed', this.onFileRemoved)\n    this.uppy.off('cancel-all', this.onAllFilesRemoved)\n\n    if (this.opts.lazy) {\n      this.uppy.off('thumbnail:request', this.onFileAdded)\n      this.uppy.off('thumbnail:cancel', this.onCancelRequest)\n    } else {\n      this.uppy.off('thumbnail:request', this.onFileAdded)\n      this.uppy.off('file-added', this.onFileAdded)\n      this.uppy.off('restored', this.onRestored)\n    }\n\n    if (this.opts.waitForThumbnailsBeforeUpload) {\n      this.uppy.removePreProcessor(this.waitUntilAllProcessed)\n    }\n  }\n}\n"],"mappings":"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","ignoreList":[]}